!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(e.vl={})}(this,function(e){"use strict";function t(e,t,n){return e.fields=t||[],e.fname=n,e}function l(e){throw Error(e)}function a(e){var t,n,r,i=[],o=null,a=0,u=e.length,s="";function c(){i.push(s+e.substring(t,n)),s="",t=n+1}for(e+="",t=n=0;n<u;++n)if("\\"===(r=e[n]))s+=e.substring(t,n),t=++n;else if(r===o)c(),o=null,a=-1;else{if(o)continue;t===a&&'"'===r?(t=n+1,o=r):t===a&&"'"===r?(t=n+1,o=r):"."!==r||a?"["===r?(t<n&&c(),a=t=n+1):"]"===r&&(a||l("Access path missing open bracket: "+e),0<a&&c(),a=0,t=n+1):t<n?c():t=n+1}return a&&l("Access path missing closing bracket: "+e),o&&l("Access path missing closing quote: "+e),t<n&&(n++,c()),i}var S=Array.isArray;function E(e){return e===Object(e)}function m(e){return"string"==typeof e}function N(e){return S(e)?"["+e.map(N)+"]":E(e)||m(e)?JSON.stringify(e).replace("\u2028","\\u2028").replace("\u2029","\\u2029"):e}var n,r,i,o,u=[];i=a(n="id"),o="return _["+i.map(N).join("][")+"];",t(Function("_",o),[n=1===i.length?i[0]:n],r||n),t(function(e){return e},u,"identity"),t(function(){return 0},u,"zero"),t(function(){return 1},u,"one"),t(function(){return!0},u,"true"),t(function(){return!1},u,"false");function s(e,t,n){var r=[t].concat([].slice.call(n));console[e].apply(console,r)}function c(e){return"boolean"==typeof e}function x(e){return"number"==typeof e}function f(e){for(var t={},n=0,r=e.length;n<r;++n)t[e[n]]=!0;return t}var d=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};function h(e,t){function n(){this.constructor=e}d(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}var I=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e};function z(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(r=Object.getOwnPropertySymbols(e);i<r.length;i++)t.indexOf(r[i])<0&&(n[r[i]]=e[r[i]])}return n}var p,g,v,y,b={'"':'"',"\\":"\\","/":"/",b:"\b",f:"\f",n:"\n",r:"\r",t:"\t"},w=function(e){throw{name:"SyntaxError",message:e,at:p,text:v}},k=function(e){return e&&e!==g&&w("Expected '"+e+"' instead of '"+g+"'"),g=v.charAt(p),p+=1,g},O=function(){var e,t="";for("-"===g&&k(t="-");"0"<=g&&g<="9";)t+=g,k();if("."===g)for(t+=".";k()&&"0"<=g&&g<="9";)t+=g;if("e"===g||"E"===g)for(t+=g,k(),"-"!==g&&"+"!==g||(t+=g,k());"0"<=g&&g<="9";)t+=g,k();if(e=+t,isFinite(e))return e;w("Bad number")},_=function(){var e,t,n,r="";if('"'===g)for(;k();){if('"'===g)return k(),r;if("\\"===g)if(k(),"u"===g){for(t=n=0;t<4&&(e=parseInt(k(),16),isFinite(e));t+=1)n=16*n+e;r+=String.fromCharCode(n)}else{if("string"!=typeof b[g])break;r+=b[g]}else r+=g}w("Bad string")},T=function(){for(;g&&g<=" ";)k()};y=function(){switch(T(),g){case"{":return function(){var e,t={};if("{"===g){if(k("{"),T(),"}"===g)return k("}"),t;for(;g;){if(e=_(),T(),k(":"),Object.hasOwnProperty.call(t,e)&&w('Duplicate key "'+e+'"'),t[e]=y(),T(),"}"===g)return k("}"),t;k(","),T()}}w("Bad object")}();case"[":return function(){var e=[];if("["===g){if(k("["),T(),"]"===g)return k("]"),e;for(;g;){if(e.push(y()),T(),"]"===g)return k("]"),e;k(","),T()}}w("Bad array")}();case'"':return _();case"-":return O();default:return"0"<=g&&g<="9"?O():function(){switch(g){case"t":return k("t"),k("r"),k("u"),k("e"),!0;case"f":return k("f"),k("a"),k("l"),k("s"),k("e"),!1;case"n":return k("n"),k("u"),k("l"),k("l"),null}w("Unexpected '"+g+"'")}()}};var C,A,D,R=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,L={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};function F(e){return R.lastIndex=0,R.test(e)?'"'+e.replace(R,function(e){var t=L[e];return"string"==typeof t?t:"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+e+'"'}var j="undefined"!=typeof JSON?JSON:{parse:function(e,a){var t;return v=e,p=0,g=" ",t=y(),T(),g&&w("Syntax error"),"function"==typeof a?function e(t,n){var r,i,o=t[n];if(o&&"object"==typeof o)for(r in o)Object.prototype.hasOwnProperty.call(o,r)&&(void 0!==(i=e(o,r))?o[r]=i:delete o[r]);return a.call(t,n,o)}({"":t},""):t},stringify:function(e,t,n){var r;if(A=C="","number"==typeof n)for(r=0;r<n;r+=1)A+=" ";else"string"==typeof n&&(A=n);if((D=t)&&"function"!=typeof t&&("object"!=typeof t||"number"!=typeof t.length))throw new Error("JSON.stringify");return function e(t,n){var r,i,o,a,u,s=C,c=n[t];switch(c&&"object"==typeof c&&"function"==typeof c.toJSON&&(c=c.toJSON(t)),"function"==typeof D&&(c=D.call(n,t,c)),typeof c){case"string":return F(c);case"number":return isFinite(c)?String(c):"null";case"boolean":case"null":return String(c);case"object":if(!c)return"null";if(C+=A,u=[],"[object Array]"===Object.prototype.toString.apply(c)){for(a=c.length,r=0;r<a;r+=1)u[r]=e(r,c)||"null";return o=0===u.length?"[]":C?"[\n"+C+u.join(",\n"+C)+"\n"+s+"]":"["+u.join(",")+"]",C=s,o}if(D&&"object"==typeof D)for(a=D.length,r=0;r<a;r+=1)"string"==typeof(i=D[r])&&(o=e(i,c))&&u.push(F(i)+(C?": ":":")+o);else for(i in c)Object.prototype.hasOwnProperty.call(c,i)&&(o=e(i,c))&&u.push(F(i)+(C?": ":":")+o);return o=0===u.length?"{}":C?"{\n"+C+u.join(",\n"+C)+"\n"+s+"}":"{"+u.join(",")+"}",C=s,o}}("",{"":e})}},U=function(e,t){t||(t={}),"function"==typeof t&&(t={cmp:t});var p=t.space||"";"number"==typeof p&&(p=Array(p+1).join(" "));var o,h="boolean"==typeof t.cycles&&t.cycles,m=t.replacer||function(e,t){return t},g=t.cmp&&(o=t.cmp,function(i){return function(e,t){var n={key:e,value:i[e]},r={key:t,value:i[t]};return o(n,r)}}),v=[];return function e(t,n,r,i){var o=p?"\n"+new Array(i+1).join(p):"",a=p?": ":":";if(r&&r.toJSON&&"function"==typeof r.toJSON&&(r=r.toJSON()),void 0!==(r=m.call(t,n,r))){if("object"!=typeof r||null===r)return j.stringify(r);if(P(r)){for(var u=[],s=0;s<r.length;s++){var c=e(r,s,r[s],i+1)||j.stringify(null);u.push(o+p+c)}return"["+u.join(",")+o+"]"}if(-1!==v.indexOf(r)){if(h)return j.stringify("__cycle__");throw new TypeError("Converting circular structure to JSON")}v.push(r);var l=M(r).sort(g&&g(r));for(u=[],s=0;s<l.length;s++){var f=e(r,n=l[s],r[n],i+1);if(f){var d=j.stringify(n)+a+f;u.push(o+p+d)}}return v.splice(v.indexOf(r),1),"{"+u.join(",")+o+"}"}}({"":e},"",e,0)},P=Array.isArray||function(e){return"[object Array]"==={}.toString.call(e)},M=Object.keys||function(e){var t=Object.prototype.hasOwnProperty||function(){return!0},n=[];for(var r in e)t.call(e,r)&&n.push(r);return n};function H(e){return!!e.or}function q(e){return!!e.and}function W(e){return!!e.not}function G(e,t){for(var n={},r=0,i=t;r<i.length;r++){var o=i[r];e.hasOwnProperty(o)&&(n[o]=e[o])}return n}function B(e,t){for(var n=I({},e),r=0,i=t;r<i.length;r++){delete n[i[r]]}return n}var Y=U;function V(e){if(x(e))return e;var t=m(e)?e:U(e);if(t.length<100)return t;for(var n=0,r=0;r<t.length;r++){n=(n<<5)-n+t.charCodeAt(r),n&=n}return n}function X(e,t){return-1<e.indexOf(t)}function Q(e,t){return e.filter(function(e){return!X(t,e)})}function K(e,t){for(var n=0,r=0;r<e.length;r++)if(t(e[r],r,n++))return!0;return!1}function J(e,t){for(var n=0,r=0;r<e.length;r++)if(!t(e[r],r,n++))return!1;return!0}function Z(e){return[].concat.apply([],e)}function $(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];for(var r=0,i=t;r<i.length;r++){e=ee(e,i[r])}return e}function ee(e,t){if("object"!=typeof t||null===t)return e;for(var n in t)t.hasOwnProperty(n)&&void 0!==t[n]&&("object"!=typeof t[n]||S(t[n])||null===t[n]?e[n]=t[n]:"object"!=typeof e[n]||null===e[n]?e[n]=$(S(t[n].constructor)?[]:{},t[n]):$(e[n],t[n]));return e}function te(e,t){for(var n,r=[],i={},o=0,a=e;o<a.length;o++){var u=a[o];(n=t(u))in i||(i[n]=1,r.push(u))}return r}function ne(e,t){for(var n in e)if(e.hasOwnProperty(n)&&t[n]&&e[n]&&t[n]!==e[n])return!0;return!1}function re(e,t){for(var n in e)if(n in t)return!0;return!1}var ie=Object.keys;function oe(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(e[n]);return t}function ae(e){return ie(e)}function ue(e){return JSON.parse(JSON.stringify(e))}function se(e){return!0===e||!1===e}function ce(e){var t=e.replace(/\W/g,"_");return(e.match(/^\d+/)?"_":"")+t}function le(e,t){return W(e)?"!("+le(e.not,t)+")":q(e)?"("+e.and.map(function(e){return le(e,t)}).join(") && (")+")":H(e)?"("+e.or.map(function(e){return le(e,t)}).join(") || (")+")":t(e)}function fe(e,t){if(0===t.length)return!0;var n=t.shift();return fe(e[n],t)&&delete e[n],0===Object.keys(e).length}function de(e){return e.charAt(0).toUpperCase()+e.substr(1)}function pe(e,t){void 0===t&&(t="datum");for(var n=a(e),r=[],i=1;i<=n.length;i++){var o="["+n.slice(0,i).map(N).join("][")+"]";r.push(""+t+o)}return r.join(" && ")}function he(e,t){return void 0===t&&(t="datum"),t+"["+N(a(e).join("."))+"]"}function me(e){return""+a(e).map(function(e){return e.replace(".","\\.")}).join("\\.")}function ge(e){return""+a(e).join(".")}function ve(e){return e?a(e).length:0}var ye=Object.freeze({pick:G,omit:B,stringify:Y,hash:V,contains:X,without:Q,union:function(e,t){return e.concat(Q(t,e))},some:K,every:J,flatten:Z,mergeDeep:$,unique:te,differ:ne,hasIntersection:re,isNumeric:function(e){return!isNaN(e)},differArray:function(e,t){if(e.length!==t.length)return!0;e.sort(),t.sort();for(var n=0;n<e.length;n++)if(t[n]!==e[n])return!0;return!1},keys:ie,vals:oe,flagKeys:ae,duplicate:ue,isBoolean:se,varName:ce,logicalExpr:le,deleteNestedProperty:fe,titlecase:de,accessPathWithDatum:pe,flatAccessWithDatum:he,replacePathInField:me,removePathFromField:ge,accessPathDepth:ve}),be={argmax:1,argmin:1,average:1,count:1,distinct:1,max:1,mean:1,median:1,min:1,missing:1,q1:1,q3:1,ci0:1,ci1:1,stderr:1,stdev:1,stdevp:1,sum:1,valid:1,values:1,variance:1,variancep:1},xe=ae(be);function Se(e){return!!be[e]}var Ee=["count","valid","missing","distinct"];function we(e){return e&&X(Ee,e)}var ke=["count","sum","distinct","valid","missing"],Ne=["mean","average","median","q1","q3","min","max"],Oe=f(Ne),_e=Object.freeze({AGGREGATE_OPS:xe,isAggregateOp:Se,COUNTING_OPS:Ee,isCountingAggregateOp:we,SUM_OPS:ke,SHARED_DOMAIN_OPS:Ne,SHARED_DOMAIN_OP_INDEX:Oe}),Te=["domain","grid","labels","ticks","title"],Ce={grid:"grid",gridScale:"grid",domain:"main",labels:"main",labelFlush:"main",labelOverlap:"main",minExtent:"main",maxExtent:"main",offset:"main",ticks:"main",title:"main",values:"both",scale:"both",zindex:"both"},Ae={orient:1,domain:1,format:1,grid:1,labelBound:1,labelFlush:1,labelPadding:1,labels:1,labelOverlap:1,maxExtent:1,minExtent:1,offset:1,position:1,tickCount:1,ticks:1,tickSize:1,title:1,titlePadding:1,values:1,zindex:1},De=I({},Ae,{encoding:1,labelAngle:1,titleMaxLength:1});function Ie(e){return!!De[e]}var ze,Re,Le=ae(I({scale:1},Ae,{gridScale:1,encode:1})),Fe=ae(De),je=Object.freeze({AXIS_PARTS:Te,AXIS_PROPERTY_TYPE:Ce,isAxisProperty:Ie,VG_AXIS_PROPERTIES:Le,AXIS_PROPERTIES:Fe});(Re=ze||(ze={})).ROW="row",Re.COLUMN="column",Re.X="x",Re.Y="y",Re.X2="x2",Re.Y2="y2",Re.LATITUDE="latitude",Re.LONGITUDE="longitude",Re.LATITUDE2="latitude2",Re.LONGITUDE2="longitude2",Re.COLOR="color",Re.FILL="fill",Re.STROKE="stroke",Re.SHAPE="shape",Re.SIZE="size",Re.OPACITY="opacity",Re.TEXT="text",Re.ORDER="order",Re.DETAIL="detail",Re.KEY="key",Re.TOOLTIP="tooltip",Re.HREF="href";var Ue=ze.X,Pe=ze.Y,Me=ze.X2,He=ze.Y2,qe=ze.LATITUDE,We=ze.LATITUDE2,Ge=ze.LONGITUDE,Be=ze.LONGITUDE2,Ye=ze.ROW,Ve=ze.COLUMN,Xe=ze.SHAPE,Qe=ze.SIZE,Ke=ze.COLOR,Je=ze.FILL,Ze=ze.STROKE,$e=ze.TEXT,et=ze.DETAIL,tt=ze.KEY,nt=ze.ORDER,rt=ze.OPACITY,it=ze.TOOLTIP,ot=ze.HREF,at={longitude:1,longitude2:1,latitude:1,latitude2:1},ut=ae(at),st=I({x:1,y:1,x2:1,y2:1},at,{color:1,fill:1,stroke:1,opacity:1,size:1,shape:1,order:1,text:1,detail:1,key:1,tooltip:1,href:1});function ct(e){return"color"===e||"fill"===e||"stroke"===e}var lt=I({},st,{row:1,column:1}),ft=ae(lt),dt=(lt.order,lt.detail,ae(z(lt,["order","detail"])));function pt(e){return!!lt[e]}var ht=ae(st),mt=(st.x,st.y,st.x2,st.y2,st.latitude,st.longitude,st.latitude2,st.longitude2,z(st,["x","y","x2","y2","latitude","longitude","latitude2","longitude2"])),gt=ae(mt),vt={x:1,y:1},yt=ae(vt),bt=z(mt,["text","tooltip","href","detail","key","order"]),xt=ae(bt),St=I({},vt,bt),Et=ae(St);function wt(e){return!!St[e]}function kt(e,t){return t in Nt(e)}function Nt(e){switch(e){case Ke:case Je:case Ze:case et:case tt:case it:case ot:case nt:case rt:case Ye:case Ve:return{point:!0,tick:!0,rule:!0,circle:!0,square:!0,bar:!0,rect:!0,line:!0,trail:!0,area:!0,text:!0,geoshape:!0};case Ue:case Pe:case qe:case Ge:return{point:!0,tick:!0,rule:!0,circle:!0,square:!0,bar:!0,rect:!0,line:!0,trail:!0,area:!0,text:!0};case Me:case He:case We:case Be:return{rule:!0,bar:!0,rect:!0,area:!0};case Qe:return{point:!0,tick:!0,rule:!0,circle:!0,square:!0,bar:!0,text:!0,line:!0,trail:!0};case Xe:return{point:!0,geoshape:!0};case $e:return{text:!0}}}function Ot(e){switch(e){case Ue:case Pe:case Qe:case rt:case Me:case He:return"continuous";case Ye:case Ve:case Xe:case $e:case it:case ot:return"discrete";case Ke:case Je:case Ze:return"flexible";case qe:case Ge:case We:case Be:case et:case tt:case nt:return}throw new Error("rangeType not implemented for "+e)}var _t=Object.freeze({get Channel(){return ze},X:Ue,Y:Pe,X2:Me,Y2:He,LATITUDE:qe,LATITUDE2:We,LONGITUDE:Ge,LONGITUDE2:Be,ROW:Ye,COLUMN:Ve,SHAPE:Xe,SIZE:Qe,COLOR:Ke,FILL:Je,STROKE:Ze,TEXT:$e,DETAIL:et,KEY:tt,ORDER:nt,OPACITY:rt,TOOLTIP:it,HREF:ot,GEOPOSITION_CHANNEL_INDEX:at,GEOPOSITION_CHANNELS:ut,isColorChannel:ct,CHANNELS:ft,SINGLE_DEF_CHANNELS:dt,isChannel:pt,UNIT_CHANNELS:ht,NONPOSITION_CHANNELS:gt,POSITION_SCALE_CHANNELS:yt,NONPOSITION_SCALE_CHANNELS:xt,SCALE_CHANNELS:Et,isScaleChannel:wt,supportMark:kt,getSupportedMark:Nt,rangeType:Ot});function Tt(t){return c(t)?"bin":"bin"+ie(t).map(function(e){return ce("_"+e+"_"+t[e])}).join("")}function Ct(e){return e&&!c(e)}function At(e){switch(e){case Ye:case Ve:case Qe:case Ke:case Je:case Ze:case rt:case Xe:return 6;default:return 10}}var Dt,It,zt=Object.freeze({binToString:Tt,isBinParams:Ct,autoMaxBins:At});(It=Dt||(Dt={})).AREA="area",It.BAR="bar",It.LINE="line",It.POINT="point",It.RECT="rect",It.RULE="rule",It.TEXT="text",It.TICK="tick",It.TRAIL="trail",It.CIRCLE="circle",It.SQUARE="square",It.GEOSHAPE="geoshape";var Rt=Dt.AREA,Lt=Dt.BAR,Ft=Dt.LINE,jt=Dt.POINT,Ut=Dt.TEXT,Pt=Dt.TICK,Mt=Dt.TRAIL,Ht=Dt.RECT,qt=Dt.RULE,Wt=Dt.GEOSHAPE,Gt=Dt.CIRCLE,Bt=Dt.SQUARE,Yt={area:1,bar:1,line:1,point:1,text:1,tick:1,trail:1,rect:1,geoshape:1,rule:1,circle:1,square:1};function Vt(e){return X(["line","area","trail"],e)}var Xt=ae(Yt);function Qt(e){return e.type}var Kt=f(Xt);function Jt(e){return(Qt(e)?e.type:e)in Kt}var Zt,$t,en,tn,nn=["stroke","strokeWidth","strokeDash","strokeDashOffset","strokeOpacity","strokeJoin","strokeMiterLimit"],rn=["fill","fillOpacity"],on=[].concat(nn,rn),an=["filled","color"],un={area:["line","point"],bar:["binSpacing","continuousBandSize","discreteBandSize"],line:["point"],text:["shortTimeLabels"],tick:["bandSize","thickness"]},sn={color:"#4c78a8"},cn={binSpacing:1,continuousBandSize:5},ln={thickness:1},fn=Object.freeze({get Mark(){return Dt},AREA:Rt,BAR:Lt,LINE:Ft,POINT:jt,TEXT:Ut,TICK:Pt,TRAIL:Mt,RECT:Ht,RULE:qt,GEOSHAPE:Wt,CIRCLE:Gt,SQUARE:Bt,isMark:function(e){return!!Yt[e]},isPathMark:Vt,PRIMITIVE_MARKS:Xt,isMarkDef:Qt,isPrimitiveMark:Jt,STROKE_CONFIG:nn,FILL_CONFIG:rn,FILL_STROKE_CONFIG:on,VL_ONLY_MARK_CONFIG_PROPERTIES:an,VL_ONLY_MARK_SPECIFIC_CONFIG_PROPERTY_INDEX:un,defaultMarkConfig:sn,defaultBarConfig:cn,defaultTickConfig:ln}),dn=($t=2||0,{level:function(e){return arguments.length?($t=+e,this):$t},error:function(){return 1<=$t&&s(Zt||"error","ERROR",arguments),this},warn:function(){return 2<=$t&&s(Zt||"warn","WARN",arguments),this},info:function(){return 3<=$t&&s(Zt||"log","INFO",arguments),this},debug:function(){return 4<=$t&&s(Zt||"log","DEBUG",arguments),this}}),pn=dn;function hn(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];pn.warn.apply(pn,arguments)}(tn=en||(en={})).INVALID_SPEC="Invalid spec",tn.FIT_NON_SINGLE='Autosize "fit" only works for single views and layered views.',tn.CANNOT_FIX_RANGE_STEP_WITH_FIT='Cannot use a fixed value of "rangeStep" when "autosize" is "fit".',tn.cannotProjectOnChannelWithoutField=function(e){return'Cannot project a selection on encoding channel "'+e+'", which has no field.'},tn.nearestNotSupportForContinuous=function(e){return'The "nearest" transform is not supported for '+e+" marks."},tn.selectionNotFound=function(e){return'Cannot find a selection named "'+e+'"'},tn.SCALE_BINDINGS_CONTINUOUS="Scale bindings are currently only supported for scales with unbinned, continuous domains.",tn.noSuchRepeatedValue=function(e){return'Unknown repeated value "'+e+'".'},tn.CONCAT_CANNOT_SHARE_AXIS="Axes cannot be shared in concatenated views.",tn.REPEAT_CANNOT_SHARE_AXIS="Axes cannot be shared in repeated views.",tn.cannotSetTitleAnchor=function(e){return'Cannot set title "anchor" for a '+e+" spec"},tn.unrecognizedParse=function(e){return'Unrecognized parse "'+e+'".'},tn.differentParse=function(e,t,n){return'An ancestor parsed field "'+e+'" as '+n+" but a child wants to parse the field as "+t+"."},tn.invalidTransformIgnored=function(e){return"Ignoring an invalid transform: "+Y(e)+"."},tn.NO_FIELDS_NEEDS_AS='If "from.fields" is not specified, "as" has to be a string that specifies the key to be used for the data from the secondary source.',tn.encodingOverridden=function(e){return"Layer's shared "+e.join(",")+" channel "+(1===e.length?"is":"are")+" overriden"},tn.projectionOverridden=function(e){var t=e.parentProjection,n=e.projection;return"Layer's shared projection "+Y(t)+" is overridden by a child projection "+Y(n)+"."},tn.primitiveChannelDef=function(e,t,n){return"Channel "+e+" is a "+t+". Converted to {value: "+Y(n)+"}."},tn.invalidFieldType=function(e){return'Invalid field type "'+e+'"'},tn.nonZeroScaleUsedWithLengthMark=function(e,t,n){return"A "+(n.scaleType?n.scaleType+" scale":n.zeroFalse?"scale with zero=false":"scale with custom domain that excludes zero")+" is used to encode "+e+"'s "+t+". This can be misleading as the "+("x"===t?"width":"height")+" of the "+e+" can be arbitrary based on the scale domain. You may want to use point mark instead."},tn.invalidFieldTypeForCountAggregate=function(e,t){return'Invalid field type "'+e+'" for aggregate: "'+t+'", using "quantitative" instead.'},tn.invalidAggregate=function(e){return'Invalid aggregation operator "'+e+'"'},tn.emptyOrInvalidFieldType=function(e,t,n){return'Invalid field type "'+e+'" for channel "'+t+'", using "'+n+'" instead.'},tn.droppingColor=function(e,t){var n=t.fill,r=t.stroke;return"Dropping color "+e+" as the plot also has "+(n&&r?"fill and stroke":n?"fill":"stroke")},tn.emptyFieldDef=function(e,t){return"Dropping "+Y(e)+' from channel "'+t+'" since it does not contain data field or value.'},tn.latLongDeprecated=function(e,t,n){return e+"-encoding with type "+t+" is deprecated. Replacing with "+n+"-encoding."},tn.LINE_WITH_VARYING_SIZE="Line marks cannot encode size with a non-groupby field. You may want to use trail marks instead.",tn.incompatibleChannel=function(e,t,n){return e+' dropped as it is incompatible with "'+t+'"'+(n?" when "+n:"")+"."},tn.invalidEncodingChannel=function(e){return e+"-encoding is dropped as "+e+" is not a valid encoding channel."},tn.facetChannelShouldBeDiscrete=function(e){return e+" encoding should be discrete (ordinal / nominal / binned)."},tn.discreteChannelCannotEncode=function(e,t){return'Using discrete channel "'+e+'" to encode "'+t+'" field can be misleading as it does not encode '+("ordinal"===t?"order":"magnitude")+"."},tn.BAR_WITH_POINT_SCALE_AND_RANGESTEP_NULL="Bar mark should not be used with point scale when rangeStep is null. Please use band scale instead.",tn.lineWithRange=function(e,t){return"Line mark is for continuous lines and thus cannot be used with "+(e&&t?"x2 and y2":e?"x2":"y2")+". We will use the rule mark (line segments) instead."},tn.orientOverridden=function(e,t){return'Specified orient "'+e+'" overridden with "'+t+'"'},tn.CANNOT_UNION_CUSTOM_DOMAIN_WITH_FIELD_DOMAIN="custom domain scale cannot be unioned with default field-based domain",tn.cannotUseScalePropertyWithNonColor=function(e){return'Cannot use the scale property "'+e+'" with non-color channel.'},tn.unaggregateDomainHasNoEffectForRawField=function(e){return"Using unaggregated domain with raw field has no effect ("+Y(e)+")."},tn.unaggregateDomainWithNonSharedDomainOp=function(e){return'Unaggregated domain not applicable for "'+e+'" since it produces values outside the origin domain of the source data.'},tn.unaggregatedDomainWithLogScale=function(e){return"Unaggregated domain is currently unsupported for log scale ("+Y(e)+")."},tn.cannotApplySizeToNonOrientedMark=function(e){return'Cannot apply size to non-oriented mark "'+e+'".'},tn.rangeStepDropped=function(e){return'rangeStep for "'+e+'" is dropped as top-level '+("x"===e?"width":"height")+" is provided."},tn.scaleTypeNotWorkWithChannel=function(e,t,n){return'Channel "'+e+'" does not work with "'+t+'" scale. We are using "'+n+'" scale instead.'},tn.scaleTypeNotWorkWithFieldDef=function(e,t){return'FieldDef does not work with "'+e+'" scale. We are using "'+t+'" scale instead.'},tn.scalePropertyNotWorkWithScaleType=function(e,t,n){return n+"-scale's \""+t+'" is dropped as it does not work with '+e+" scale."},tn.scaleTypeNotWorkWithMark=function(e,t){return'Scale type "'+t+'" does not work with mark "'+e+'".'},tn.mergeConflictingProperty=function(e,t,n,r){return"Conflicting "+t.toString()+' property "'+e.toString()+'" ('+Y(n)+" and "+Y(r)+").  Using "+Y(n)+"."},tn.independentScaleMeansIndependentGuide=function(e){return'Setting the scale to be independent for "'+e+'" means we also have to set the guide (axis or legend) to be independent.'},tn.domainSortDropped=function(e){return"Dropping sort property "+Y(e)+" as unioned domains only support boolean or op 'count'."},tn.UNABLE_TO_MERGE_DOMAINS="Unable to merge domains",tn.MORE_THAN_ONE_SORT="Domains that should be unioned has conflicting sort properties. Sort will be set to true.",tn.INVALID_CHANNEL_FOR_AXIS="Invalid channel for axis.",tn.cannotStackRangedMark=function(e){return'Cannot stack "'+e+'" if there is already "'+e+'2"'},tn.cannotStackNonLinearScale=function(e){return"Cannot stack non-linear scale ("+e+")"},tn.stackNonSummativeAggregate=function(e){return'Stacking is applied even though the aggregate function is non-summative ("'+e+'")'},tn.invalidTimeUnit=function(e,t){return"Invalid "+e+": "+Y(t)},tn.dayReplacedWithDate=function(e){return'Time unit "'+e+'" is not supported. We are replacing it with '+e.replace("day","date")+"."},tn.droppedDay=function(e){return"Dropping day from datetime "+Y(e)+" as day cannot be combined with other units."};var mn=2006;function gn(e){return!!(e&&(e.year||e.quarter||e.month||e.date||e.day||e.hours||e.minutes||e.seconds||e.milliseconds))}var vn=["january","february","march","april","may","june","july","august","september","october","november","december"],yn=vn.map(function(e){return e.substr(0,3)}),bn=["sunday","monday","tuesday","wednesday","thursday","friday","saturday"],xn=bn.map(function(e){return e.substr(0,3)});function Sn(e,t){void 0===t&&(t=!1);var n=[];if(t&&void 0!==e.day&&1<ie(e).length&&(hn(en.droppedDay(e)),delete(e=ue(e)).day),void 0!==e.year?n.push(e.year):void 0!==e.day?n.push(mn):n.push(0),void 0!==e.month){var r=t?function(e){if(x(e))return e-1+"";var t=e.toLowerCase(),n=vn.indexOf(t);if(-1!==n)return n+"";var r=t.substr(0,3),i=yn.indexOf(r);if(-1!==i)return i+"";throw new Error(en.invalidTimeUnit("month",e))}(e.month):e.month;n.push(r)}else if(void 0!==e.quarter){var i=t?function(e){if(x(e))return 4<e&&hn(en.invalidTimeUnit("quarter",e)),e-1+"";throw new Error(en.invalidTimeUnit("quarter",e))}(e.quarter):e.quarter;n.push(i+"*3")}else n.push(0);if(void 0!==e.date)n.push(e.date);else if(void 0!==e.day){var o=t?function(e){if(x(e))return e%7+"";var t=e.toLowerCase(),n=bn.indexOf(t);if(-1!==n)return n+"";var r=t.substr(0,3),i=xn.indexOf(r);if(-1!==i)return i+"";throw new Error(en.invalidTimeUnit("day",e))}(e.day):e.day;n.push(o+"+1")}else n.push(1);for(var a=0,u=["hours","minutes","seconds","milliseconds"];a<u.length;a++){var s=u[a];void 0!==e[s]?n.push(e[s]):n.push(0)}return e.utc?"utc("+n.join(", ")+")":"datetime("+n.join(", ")+")"}var En,wn,kn=Object.freeze({isDateTime:gn,MONTHS:vn,SHORT_MONTHS:yn,DAYS:bn,SHORT_DAYS:xn,dateTimeExpr:Sn});(wn=En||(En={})).YEAR="year",wn.MONTH="month",wn.DAY="day",wn.DATE="date",wn.HOURS="hours",wn.MINUTES="minutes",wn.SECONDS="seconds",wn.MILLISECONDS="milliseconds",wn.YEARMONTH="yearmonth",wn.YEARMONTHDATE="yearmonthdate",wn.YEARMONTHDATEHOURS="yearmonthdatehours",wn.YEARMONTHDATEHOURSMINUTES="yearmonthdatehoursminutes",wn.YEARMONTHDATEHOURSMINUTESSECONDS="yearmonthdatehoursminutesseconds",wn.MONTHDATE="monthdate",wn.HOURSMINUTES="hoursminutes",wn.HOURSMINUTESSECONDS="hoursminutesseconds",wn.MINUTESSECONDS="minutesseconds",wn.SECONDSMILLISECONDS="secondsmilliseconds",wn.QUARTER="quarter",wn.YEARQUARTER="yearquarter",wn.QUARTERMONTH="quartermonth",wn.YEARQUARTERMONTH="yearquartermonth",wn.UTCYEAR="utcyear",wn.UTCMONTH="utcmonth",wn.UTCDAY="utcday",wn.UTCDATE="utcdate",wn.UTCHOURS="utchours",wn.UTCMINUTES="utcminutes",wn.UTCSECONDS="utcseconds",wn.UTCMILLISECONDS="utcmilliseconds",wn.UTCYEARMONTH="utcyearmonth",wn.UTCYEARMONTHDATE="utcyearmonthdate",wn.UTCYEARMONTHDATEHOURS="utcyearmonthdatehours",wn.UTCYEARMONTHDATEHOURSMINUTES="utcyearmonthdatehoursminutes",wn.UTCYEARMONTHDATEHOURSMINUTESSECONDS="utcyearmonthdatehoursminutesseconds",wn.UTCMONTHDATE="utcmonthdate",wn.UTCHOURSMINUTES="utchoursminutes",wn.UTCHOURSMINUTESSECONDS="utchoursminutesseconds",wn.UTCMINUTESSECONDS="utcminutesseconds",wn.UTCSECONDSMILLISECONDS="utcsecondsmilliseconds",wn.UTCQUARTER="utcquarter",wn.UTCYEARQUARTER="utcyearquarter",wn.UTCQUARTERMONTH="utcquartermonth",wn.UTCYEARQUARTERMONTH="utcyearquartermonth";var Nn={year:1,quarter:1,month:1,day:1,date:1,hours:1,minutes:1,seconds:1,milliseconds:1},On=ae(Nn);function _n(e){return!!Nn[e]}var Tn={utcyear:1,utcquarter:1,utcmonth:1,utcday:1,utcdate:1,utchours:1,utcminutes:1,utcseconds:1,utcmilliseconds:1};function Cn(e){return!!Tn[e]}var An={utcyearquarter:1,utcyearquartermonth:1,utcyearmonth:1,utcyearmonthdate:1,utcyearmonthdatehours:1,utcyearmonthdatehoursminutes:1,utcyearmonthdatehoursminutesseconds:1,utcquartermonth:1,utcmonthdate:1,utchoursminutes:1,utchoursminutesseconds:1,utcminutesseconds:1,utcsecondsmilliseconds:1},Dn=I({},Tn,An);function In(e){return!!Dn[e]}function zn(e){return e.substr(3)}var Rn=I({},Nn,Tn,{yearquarter:1,yearquartermonth:1,yearmonth:1,yearmonthdate:1,yearmonthdatehours:1,yearmonthdatehoursminutes:1,yearmonthdatehoursminutesseconds:1,quartermonth:1,monthdate:1,hoursminutes:1,hoursminutesseconds:1,minutesseconds:1,secondsmilliseconds:1},An),Ln=ae(Rn);var Fn={year:"setFullYear",month:"setMonth",date:"setDate",hours:"setHours",minutes:"setMinutes",seconds:"setSeconds",milliseconds:"setMilliseconds",quarter:null,day:null};function jn(e,t){var n=Fn[e];return{setDateMethod:t?"setUTC"+n.substr(3):n,getDateMethod:"get"+(t?"UTC":"")+n.substr(3)}}function Un(n){return On.reduce(function(e,t){return Pn(n,t)?e.concat(t):e},[])}function Pn(e,t){var n=e.indexOf(t);return-1<n&&(t!==En.SECONDS||0===n||"i"!==e.charAt(n-1))}function Mn(r,e){var i=pe(e),o=In(r)?"utc":"";return Sn(On.reduce(function(e,t){var n;return Pn(r,t)&&(e[t]=(n=t)===En.QUARTER?"("+o+"quarter("+i+")-1)":""+o+n+"("+i+")"),e},{}))}function Hn(e,t,n,r){if(e){var i=[],o="",a=Pn(e,En.YEAR);Pn(e,En.QUARTER)&&(o="'Q' + quarter("+t+")"),Pn(e,En.MONTH)&&i.push(!1!==n?"%b":"%B"),Pn(e,En.DAY)?i.push(n?"%a":"%A"):Pn(e,En.DATE)&&i.push("%d"+(a?",":"")),a&&i.push(n?"%y":"%Y");var u=[];Pn(e,En.HOURS)&&u.push("%H"),Pn(e,En.MINUTES)&&u.push("%M"),Pn(e,En.SECONDS)&&u.push("%S"),Pn(e,En.MILLISECONDS)&&u.push("%L");var s=[];return 0<i.length&&s.push(i.join(" ")),0<u.length&&s.push(u.join(":")),0<s.length&&(o&&(o+=" + ' ' + "),o+=r?"utcFormat("+t+", '"+s.join(" ")+"')":"timeFormat("+t+", '"+s.join(" ")+"')"),o||void 0}}function qn(e){return"day"!==e&&0<=e.indexOf("day")?(hn(en.dayReplacedWithDate(e)),e.replace("day","date")):e}var Wn,Gn,Bn=Object.freeze({get TimeUnit(){return En},TIMEUNIT_PARTS:On,isLocalSingleTimeUnit:_n,isUtcSingleTimeUnit:Cn,isUTCTimeUnit:In,getLocalTimeUnit:zn,TIMEUNITS:Ln,isTimeUnit:function(e){return!!Rn[e]},convert:function(e,t){for(var n=In(e),r=n?new Date(Date.UTC(0,0,1,0,0,0,0)):new Date(0,0,1,0,0,0,0),i=0,o=On;i<o.length;i++){var a=o[i];if(Pn(e,a))switch(a){case En.DAY:throw new Error("Cannot convert to TimeUnits containing 'day'");case En.QUARTER:var u=jn("month",n),s=u.getDateMethod;r[u.setDateMethod](3*Math.floor(t[s]()/3));break;default:var c=jn(a,n),l=c.getDateMethod;r[c.setDateMethod](t[l]())}}return r},getTimeUnitParts:Un,containsTimeUnit:Pn,fieldExpr:Mn,formatExpression:Hn,normalizeTimeUnit:qn});(Gn=Wn||(Wn={})).QUANTITATIVE="quantitative",Gn.ORDINAL="ordinal",Gn.TEMPORAL="temporal",Gn.NOMINAL="nominal",Gn.LATITUDE="latitude",Gn.LONGITUDE="longitude",Gn.GEOJSON="geojson";var Yn={quantitative:1,ordinal:1,temporal:1,nominal:1,latitude:1,longitude:1,geojson:1};var Vn=Wn.QUANTITATIVE,Xn=Wn.ORDINAL,Qn=Wn.TEMPORAL,Kn=Wn.NOMINAL,Jn=Wn.GEOJSON;function Zn(e){if(e)switch(e=e.toLowerCase()){case"q":case Vn:return"quantitative";case"t":case Qn:return"temporal";case"o":case Xn:return"ordinal";case"n":case Kn:return"nominal";case Wn.LATITUDE:return"latitude";case Wn.LONGITUDE:return"longitude";case Jn:return"geojson"}}var $n=Object.freeze({get Type(){return Wn},TYPE_INDEX:Yn,isType:function(e){return!!Yn[e]},QUANTITATIVE:Vn,ORDINAL:Xn,TEMPORAL:Qn,NOMINAL:Kn,GEOJSON:Jn,getFullName:Zn});function er(e){return e.selection}function tr(e){return e&&!m(e)&&"repeat"in e}function nr(e){var t=e.field,n=e.timeUnit,r=e.bin,i=e.aggregate;return I({},n?{timeUnit:n}:{},r?{bin:r}:{},i?{aggregate:i}:{},{field:t})}function rr(e){return!!e&&!!e.condition}function ir(e){return!!e&&!!e.condition&&!S(e.condition)&&ar(e.condition)}function or(e){return!!e&&!!e.condition&&(S(e.condition)||sr(e.condition))}function ar(e){return!(!e||!e.field&&"count"!==e.aggregate)}function ur(e){return ar(e)&&m(e.field)}function sr(e){return e&&"value"in e&&void 0!==e.value}function cr(e){return!(!e||!e.scale&&!e.sort)}function lr(e,t){void 0===t&&(t={});var n=e.field,r=t.prefix,i=t.suffix;if(pr(e))n="count_*";else{var o=void 0;t.nofn||(e.op?o=e.op:e.bin?(o=Tt(e.bin),i=t.binSuffix||""):e.aggregate?o=String(e.aggregate):e.timeUnit&&(o=String(e.timeUnit))),o&&(n=n?o+"_"+n:o)}return i&&(n=n+"_"+i),r&&(n=r+"_"+n),t.expr?he(n,t.expr):me(n)}function fr(e){switch(e.type){case"nominal":case"ordinal":case"geojson":return!0;case"quantitative":return!!e.bin;case"latitude":case"longitude":case"temporal":return!1}throw new Error(en.invalidFieldType(e.type))}function dr(e){return!fr(e)}function pr(e){return"count"===e.aggregate}function hr(e,t){var n=e.field,r=e.bin,i=e.timeUnit,o=e.aggregate;return"count"===o?t.countTitle:r?n+" (binned)":i?n+" ("+Un(i).join("-")+")":o?de(o)+" of "+n:n}function mr(e,t){var n=e.aggregate||e.timeUnit||e.bin&&"bin";return n?n.toUpperCase()+"("+e.field+")":e.field}var gr=function(e,t){switch(t.fieldTitle){case"plain":return e.field;case"functional":return mr(e);default:return hr(e,t)}},vr=gr;function yr(e){vr=e}function br(){yr(gr)}function xr(e,t){return vr(e,t)}function Sr(e,t){if(e.timeUnit)return"temporal";if(e.bin)return"quantitative";switch(Ot(t)){case"continuous":return"quantitative";case"discrete":case"flexible":return"nominal";default:return"quantitative"}}function Er(e){return ar(e)?e:ir(e)?e.condition:void 0}function wr(e,t){if(m(e)||x(e)||c(e)){var n=m(e)?"string":x(e)?"number":"boolean";return hn(en.primitiveChannelDef(t,n,e)),{value:e}}return ar(e)?kr(e,t):ir(e)?I({},e,{condition:kr(e.condition,t)}):e}function kr(e,t){if(e.aggregate&&!Se(e.aggregate)){e.aggregate;var n=z(e,["aggregate"]);hn(en.invalidAggregate(e.aggregate)),e=n}if(e.timeUnit&&(e=I({},e,{timeUnit:qn(e.timeUnit)})),e.bin&&(e=I({},e,{bin:Nr(e.bin,t)})),e.type){var r=Zn(e.type);e.type!==r&&(e=I({},e,{type:r})),"quantitative"!==e.type&&we(e.aggregate)&&(hn(en.invalidFieldTypeForCountAggregate(e.type,e.aggregate)),e=I({},e,{type:"quantitative"}))}else{var i=Sr(e,t);hn(en.emptyOrInvalidFieldType(e.type,t,i)),e=I({},e,{type:i})}var o=_r(e,t),a=o.compatible,u=o.warning;return a||hn(u),e}function Nr(e,t){return c(e)?{maxbins:At(t)}:e.maxbins||e.step?e:I({},e,{maxbins:At(t)})}var Or={compatible:!0};function _r(e,t){var n=e.type;switch(t){case"row":case"column":return dr(e)?{compatible:!1,warning:en.facetChannelShouldBeDiscrete(t)}:Or;case"x":case"y":case"color":case"fill":case"stroke":case"text":case"detail":case"key":case"tooltip":case"href":return Or;case"longitude":case"longitude2":case"latitude":case"latitude2":return n!==Vn?{compatible:!1,warning:"Channel "+t+" should be used with a quantitative field only, not "+e.type+" field."}:Or;case"opacity":case"size":case"x2":case"y2":return"nominal"===n&&!e.sort||"geojson"===n?{compatible:!1,warning:"Channel "+t+" should not be used with an unsorted discrete field."}:Or;case"shape":return"nominal"!==e.type&&"geojson"!==e.type?{compatible:!1,warning:"Shape channel should be used with only either nominal or geojson data"}:Or;case"order":return"nominal"!==e.type||"sort"in e?Or:{compatible:!1,warning:"Channel order is inappropriate for nominal field, which has no inherent order."}}throw new Error("channelCompatability not implemented for channel "+t)}function Tr(e){return"quantitative"===e.type||!!e.bin}function Cr(e){return"temporal"===e.type||!!e.timeUnit}function Ar(e,t){var n,r=t.timeUnit,i=t.type,o=t.time,a=t.undefinedIfExprNotRequired,u=void 0;return gn(e)?u=Sn(e,!0):(m(e)||x(e))&&(r||"temporal"===i)&&(u=_n(r)?Sn(((n={})[r]=e,n),!0):Cn(r)?Ar(e,{timeUnit:zn(r)}):"datetime("+JSON.stringify(e)+")"),u?o?"time("+u+")":u:a?void 0:JSON.stringify(e)}function Dr(e,t){var n=e.timeUnit,r=e.type;return t.map(function(e){var t=Ar(e,{timeUnit:n,type:r,undefinedIfExprNotRequired:!0});return void 0!==t?{signal:t}:e})}var Ir=Object.freeze({isConditionalSelection:er,isRepeatRef:tr,toFieldDefBase:nr,isConditionalDef:rr,hasConditionalFieldDef:ir,hasConditionalValueDef:or,isFieldDef:ar,isStringFieldDef:ur,isValueDef:sr,isScaleFieldDef:cr,vgField:lr,isDiscrete:fr,isContinuous:dr,isCount:pr,verbalTitleFormatter:hr,functionalTitleFormatter:mr,defaultTitleFormatter:gr,setTitleFormatter:yr,resetTitleFormatter:br,title:xr,defaultType:Sr,getFieldDef:Er,normalize:wr,normalizeFieldDef:kr,normalizeBin:Nr,channelCompatibility:_r,isNumberFieldDef:Tr,isTimeFieldDef:Cr,valueExpr:Ar,valueArray:Dr});function zr(e,t){var n=e&&e[t];return!!n&&(S(n)?K(n,function(e){return!!e.field}):ar(n)||ir(n))}function Rr(r){return K(ft,function(e){if(zr(r,e)){var t=r[e];if(S(t))return K(t,function(e){return!!e.aggregate});var n=Er(t);return n&&!!n.aggregate}return!1})}function Lr(s,c){return ie(s).reduce(function(e,n){var t;if(!pt(n))return hn(en.invalidEncodingChannel(n)),e;if(!kt(n,c))return hn(en.incompatibleChannel(n,c)),e;if("size"===n&&"line"===c&&((i=Er(s[n]))&&i.aggregate))return hn(en.LINE_WITH_VARYING_SIZE),e;if("color"===n&&("fill"in s||"stroke"in s))return hn(en.droppingColor("encoding",{fill:"fill"in s,stroke:"stroke"in s})),e;var r=s[n];if("detail"===n||"order"===n&&!S(r)&&!sr(r)||"tooltip"===n&&S(r))r&&(e[n]=(S(r)?r:[r]).reduce(function(e,t){return ar(t)?e.push(kr(t,n)):hn(en.emptyFieldDef(t,n)),e},[]));else{var i;if((i=Er(s[n]))&&X([Wn.LATITUDE,Wn.LONGITUDE],i.type)){var o=n,a=(e[o],z(e,["symbol"==typeof o?o:o+""])),u="x"===n?"longitude":"y"===n?"latitude":"x2"===n?"longitude2":"y2"===n?"latitude2":void 0;return hn(en.latLongDeprecated(n,i.type,u)),I({},a,((t={})[u]=I({},wr(i,n),{type:"quantitative"}),t))}if(!ar(r)&&!sr(r)&&!rr(r))return hn(en.emptyFieldDef(r,n)),e;e[n]=wr(r,n)}return e},{})}function Fr(e){return e&&(!!e.x&&!!e.x2||!!e.y&&!!e.y2)}function jr(n){var r=[];return ft.forEach(function(e){if(zr(n,e)){var t=n[e];(S(t)?t:[t]).forEach(function(e){ar(e)?r.push(e):ir(e)&&r.push(e.condition)})}}),r}function Ur(e,n,r){if(e)for(var t=function(t){S(e[t])?e[t].forEach(function(e){n.call(r,e,t)}):n.call(r,e[t],t)},i=0,o=ie(e);i<o.length;i++){t(o[i])}}function Pr(r,i,e,o){return r?ie(r).reduce(function(e,n){var t=r[n];return S(t)?t.reduce(function(e,t){return i.call(o,e,t,n)},e):i.call(o,e,t,n)},e):e}var Mr=Object.freeze({channelHasField:zr,isAggregate:Rr,normalizeEncoding:Lr,isRanged:Fr,fieldDefs:jr,forEach:Ur,reduce:Pr});function Hr(e,t){var n,r=e[t];return void 0!==r?((n={})[t]={value:r},n):{}}var qr="box-plot";function Wr(e){return!!e.type}var Gr=["x","y","color","detail","opacity","size"];var Br={};function Yr(e,t){Br[e]=t}var Vr=["boxWhisker","box","boxMid"],Xr=I({},{box:["size","color","extent"],boxWhisker:["color"],boxMid:["color"]});function Qr(e,t){var n=Qt(e.mark)?e.mark.type:e.mark,r=Br[n];if(r)return r(e,t);throw new Error('Invalid mark type "'+n+'"')}Yr(qr,function(e,t){var n,r,i,o,a,u=(e=I({},a=e,{encoding:Pr(a.encoding,function(e,t,n){return-1<Gr.indexOf(n)?e[n]=t:hn(en.incompatibleChannel(n,qr)),e},{})})).mark,s=(e.encoding,e.selection),c=(e.projection,z(e,["mark","encoding","selection","projection"])),l=void 0;x(t.box.extent)&&(l=t.box.extent),Wr(u)&&u.extent&&"min-max"===u.extent&&(l=void 0);var f=function(e,t,n){var r=function(e,t){e.mark;var n,r,i=e.encoding;if(e.projection,z(e,["mark","encoding","projection"]),"vertical"===t?(r="y",n=i.y):(r="x",n=i.x),n&&n.aggregate){var o=n.aggregate,a=z(n,["aggregate"]);o!==qr&&hn("Continuous axis should not have customized aggregation function "+o),n=a}return{continuousAxisChannelDef:n,continuousAxis:r}}(e,t),i=r.continuousAxisChannelDef,a=r.continuousAxis,u=e.encoding,o=void 0===n,s=[{op:"q1",field:i.field,as:"lower_box_"+i.field},{op:"q3",field:i.field,as:"upper_box_"+i.field},{op:"median",field:i.field,as:"mid_box_"+i.field}],c=[];s.push({op:"min",field:i.field,as:(o?"lower_whisker_":"min_")+i.field}),s.push({op:"max",field:i.field,as:(o?"upper_whisker_":"max_")+i.field}),o||(c=[{calculate:"datum.upper_box_"+i.field+" - datum.lower_box_"+i.field,as:"iqr_"+i.field},{calculate:"min(datum.upper_box_"+i.field+" + datum.iqr_"+i.field+" * "+n+", datum.max_"+i.field+")",as:"upper_whisker_"+i.field},{calculate:"max(datum.lower_box_"+i.field+" - datum.iqr_"+i.field+" * "+n+", datum.min_"+i.field+")",as:"lower_whisker_"+i.field}]);var l=[],f=[],d=[],p={};return Ur(u,function(e,t){if(t!==a)if(ar(e)){if(e.aggregate&&e.aggregate!==qr)s.push({op:e.aggregate,field:e.field,as:lr(e)});else if(void 0===e.aggregate){var n=lr(e),r=e.bin;if(r){var i=e.field;f.push({bin:r,field:i,as:n})}else if(e.timeUnit){var o=e.timeUnit;i=e.field,d.push({timeUnit:o,field:i,as:n})}l.push(n)}p[t]={field:lr(e),type:e.type}}else p[t]=u[t]}),{transform:[].concat(f,d,[{aggregate:s,groupby:l}],c),continuousAxisChannelDef:i,continuousAxis:a,encodingWithoutContinuousAxis:p}}(e,function(e){var t=e.mark,n=e.encoding;if(e.projection,z(e,["mark","encoding","projection"]),ar(n.x)&&dr(n.x)){if(ar(n.y)&&dr(n.y)){if(void 0===n.x.aggregate&&n.y.aggregate===qr)return"vertical";if(void 0===n.y.aggregate&&n.x.aggregate===qr)return"horizontal";if(n.x.aggregate===qr&&n.y.aggregate===qr)throw new Error("Both x and y cannot have aggregate");return Wr(t)&&t.orient?t.orient:"vertical"}return"horizontal"}if(ar(n.y)&&dr(n.y))return"vertical";throw new Error("Need a valid continuous axis for boxplots")}(e),l),d=f.transform,p=f.continuousAxisChannelDef,h=f.continuousAxis,m=f.encodingWithoutContinuousAxis,g=m.size,v=z(m,["color","size"]),y=g?{size:g}:Hr(t.box,"size"),b={};return p.scale&&(b.scale=p.scale),p.axis&&(b.axis=p.axis),I({},c,{transform:d,layer:[{mark:{type:"rule",style:"boxWhisker"},encoding:I((n={},n[h]=I({field:"lower_whisker_"+p.field,type:p.type},b),n[h+"2"]={field:"lower_box_"+p.field,type:p.type},n),v,Hr(t.boxWhisker,"color"))},{mark:{type:"rule",style:"boxWhisker"},encoding:I((r={},r[h]={field:"upper_box_"+p.field,type:p.type},r[h+"2"]={field:"upper_whisker_"+p.field,type:p.type},r),v,Hr(t.boxWhisker,"color"))},I({},s?{selection:s}:{},{mark:{type:"bar",style:"box"},encoding:I((i={},i[h]={field:"lower_box_"+p.field,type:p.type},i[h+"2"]={field:"upper_box_"+p.field,type:p.type},i),m,m.color?{}:Hr(t.box,"color"),y)}),{mark:{type:"tick",style:"boxMid"},encoding:I((o={},o[h]={field:"mid_box_"+p.field,type:p.type},o),v,Hr(t.boxMid,"color"),y)}]})}),Yr("error-bar",function(e){e.mark,e.selection,e.projection;var t=e.encoding,n=z(e,["mark","selection","projection","encoding"]),r=(t.size,z(t,["size"])),i=(t.x2,t.y2,z(t,["x2","y2"])),o=z(i,["x","y"]);if(!t.x2&&!t.y2)throw new Error("Neither x2 or y2 provided");return I({},n,{layer:[{mark:"rule",encoding:r},{mark:"tick",encoding:i},{mark:"tick",encoding:t.x2?I({x:t.x2,y:t.y},o):I({x:t.x,y:t.y2},o)}]})});var Kr,Jr,Zr=Object.freeze({add:Yr,remove:function(e){delete Br[e]},COMPOSITE_MARK_STYLES:Vr,VL_ONLY_COMPOSITE_MARK_SPECIFIC_CONFIG_PROPERTY_INDEX:Xr,normalize:Qr}),$r=["shortTimeLabels"],ei={},ti={entryPadding:1,format:1,offset:1,orient:1,padding:1,tickCount:1,title:1,type:1,values:1,zindex:1},ni=I({},ti,{opacity:1,shape:1,stroke:1,fill:1,size:1,encode:1}),ri=ae(ti),ii=ae(ni),oi=Object.freeze({defaultLegendConfig:ei,LEGEND_PROPERTIES:ri,VG_LEGEND_PROPERTIES:ii});(Jr=Kr||(Kr={})).LINEAR="linear",Jr.BIN_LINEAR="bin-linear",Jr.LOG="log",Jr.POW="pow",Jr.SQRT="sqrt",Jr.TIME="time",Jr.UTC="utc",Jr.SEQUENTIAL="sequential",Jr.QUANTILE="quantile",Jr.QUANTIZE="quantize",Jr.THRESHOLD="threshold",Jr.ORDINAL="ordinal",Jr.BIN_ORDINAL="bin-ordinal",Jr.POINT="point",Jr.BAND="band";var ai={linear:"numeric",log:"numeric",pow:"numeric",sqrt:"numeric","bin-linear":"bin-linear",time:"time",utc:"time",sequential:"sequential",ordinal:"ordinal","bin-ordinal":"bin-ordinal",point:"ordinal-position",band:"ordinal-position"},ui=ie(ai);function si(e,t){var n=ai[e],r=ai[t];return n===r||"ordinal-position"===n&&"time"===r||"ordinal-position"===r&&"time"===n}var ci={linear:0,log:1,pow:1,sqrt:1,time:0,utc:0,point:10,band:11,"bin-linear":0,sequential:0,ordinal:0,"bin-ordinal":0};function li(e){return ci[e]}var fi=["linear","bin-linear","log","pow","sqrt","time","utc"],di=f(fi),pi=fi.concat(["sequential"]),hi=f(pi),mi=["ordinal","bin-ordinal","point","band"],gi=f(mi),vi=f(["bin-linear","bin-ordinal"]);function yi(e){return e in gi}function bi(e){return e in vi}function xi(e){return e in hi}function Si(e){return e in di}var Ei={textXRangeStep:90,rangeStep:21,pointPadding:.5,bandPaddingInner:.1,facetSpacing:16,minBandSize:2,minFontSize:8,maxFontSize:40,minOpacity:.3,maxOpacity:.8,minSize:9,minStrokeWidth:1,maxStrokeWidth:4};function wi(e){return e&&!!e.name}function ki(e){return e&&e.selection}var Ni={type:1,domain:1,range:1,rangeStep:1,scheme:1,reverse:1,round:1,clamp:1,nice:1,base:1,exponent:1,interpolate:1,zero:1,padding:1,paddingInner:1,paddingOuter:1},Oi=ae(Ni),_i=ae(z(Ni,["type","domain","range","rangeStep","scheme"])),Ti=function(){for(var e={},t=0,n=ft;t<n.length;t++)for(var r=n[t],i=0,o=ie(Yn);i<o.length;i++)for(var a=o[i],u=0,s=ui;u<s.length;u++)for(var c=s[u],l=0,f=[!1,!0];l<f.length;l++){var d=f[l],p=zi(r,a,d);Ii(r,c)&&Di(c,a,d)&&(e[p]=e[p]||[],e[p].push(c))}return e}();function Ci(e,t){switch(t){case"type":case"domain":case"reverse":case"range":return!0;case"scheme":return X(["sequential","ordinal","bin-ordinal","quantile","quantize"],e);case"interpolate":return X(["linear","bin-linear","pow","log","sqrt","utc","time"],e);case"round":return Si(e)||"band"===e||"point"===e;case"padding":return Si(e)||X(["point","band"],e);case"paddingOuter":case"rangeStep":return X(["point","band"],e);case"paddingInner":return"band"===e;case"clamp":return Si(e)||"sequential"===e;case"nice":return Si(e)||"sequential"===e||"quantize"===e;case"exponent":return"pow"===e;case"base":return"log"===e;case"zero":return xi(e)&&!X(["log","time","utc","bin-linear","threshold","quantile"],e)}throw new Error("Invalid scale property "+t+".")}function Ai(e,t){switch(t){case"interpolate":case"scheme":return ct(e)?void 0:en.cannotUseScalePropertyWithNonColor(e);case"type":case"domain":case"range":case"base":case"exponent":case"nice":case"padding":case"paddingInner":case"paddingOuter":case"rangeStep":case"reverse":case"round":case"clamp":case"zero":return}throw new Error('Invalid scale property "'+t+'".')}function Di(e,t,n){return X([Wn.ORDINAL,Wn.NOMINAL],t)?void 0===e||yi(e):t===Wn.TEMPORAL?X([Kr.TIME,Kr.UTC,Kr.SEQUENTIAL,void 0],e):t!==Wn.QUANTITATIVE||X(n?[Kr.BIN_LINEAR,Kr.BIN_ORDINAL,Kr.LINEAR]:[Kr.LOG,Kr.POW,Kr.SQRT,Kr.QUANTILE,Kr.QUANTIZE,Kr.LINEAR,Kr.SEQUENTIAL,void 0],e)}function Ii(e,t){switch(e){case ze.X:case ze.Y:case ze.SIZE:case ze.OPACITY:return Si(t)||X(["band","point"],t);case ze.COLOR:case ze.FILL:case ze.STROKE:return"band"!==t;case ze.SHAPE:return"ordinal"===t}return!1}function zi(e,t,n){var r=e+"_"+t;return n?r+"_bin":r}var Ri=Object.freeze({get ScaleType(){return Kr},SCALE_TYPES:ui,scaleCompatible:si,scaleTypePrecedence:li,CONTINUOUS_TO_CONTINUOUS_SCALES:fi,CONTINUOUS_DOMAIN_SCALES:pi,DISCRETE_DOMAIN_SCALES:mi,TIME_SCALE_TYPES:["time","utc"],hasDiscreteDomain:yi,isBinScale:bi,hasContinuousDomain:xi,isContinuousToContinuous:Si,defaultScaleConfig:Ei,isExtendedScheme:wi,isSelectionDomain:ki,SCALE_PROPERTIES:Oi,NON_TYPE_DOMAIN_RANGE_VEGA_SCALE_PROPERTIES:_i,SCALE_TYPE_INDEX:Ti,scaleTypeSupportProperty:Ci,channelScalePropertyIncompatability:Ai,scaleTypeSupportDataType:Di,channelSupportScaleType:Ii,getSupportedScaleType:function(e,t,n){return Ti[zi(e,t,n)]}}),Li="_vgsid_";function Fi(e){var t=e.anchor,n=e.offset,r=e.orient,i=e.color,o=z(e,["anchor","offset","orient","color"]);return{mark:I({},o,i?{fill:i}:{}),nonMark:I({},t?{anchor:t}:{},n?{offset:n}:{},r?{orient:r}:{})}}var ji={width:200,height:200},Ui={padding:5,timeFormat:"",countTitle:"Number of Records",invalidValues:"filter",view:ji,mark:sn,area:{},bar:cn,circle:{},geoshape:{},line:{},point:{},rect:{},rule:{color:"black"},square:{},text:{color:"black"},tick:ln,trail:{},box:{size:14,extent:1.5},boxWhisker:{},boxMid:{color:"white"},scale:Ei,projection:{},axis:{},axisX:{},axisY:{minExtent:30},axisLeft:{},axisRight:{},axisTop:{},axisBottom:{},axisBand:{},legend:ei,selection:{single:{on:"click",fields:[Li],resolve:"global",empty:"all"},multi:{on:"click",fields:[Li],toggle:"event.shiftKey",resolve:"global",empty:"all"},interval:{on:"[mousedown, window:mouseup] > window:mousemove!",encodings:["x","y"],translate:"[mousedown, window:mouseup] > window:mousemove!",zoom:"wheel!",mark:{fill:"#333",fillOpacity:.125,stroke:"white"},resolve:"global"}},style:{},title:{}};function Pi(e){return $(ue(Ui),e)}var Mi=["view"].concat(Xt,Vr),Hi=["padding","numberFormat","timeFormat","countTitle","stack","scale","selection","invalidValues","overlay"],qi=I({view:["width","height"]},un,Xr);function Wi(e){e=ue(e);for(var t=0,n=Hi;t<n.length;t++){delete e[o=n[t]]}if(e.axis)for(var r=0,i=$r;r<i.length;r++){var o=i[r];delete e.axis[o]}if(e.legend)for(var a=0,u=$r;a<u.length;a++){o=u[a];delete e.legend[o]}if(e.mark)for(var s=0,c=an;s<c.length;s++){o=c[s];delete e.mark[o]}for(var l=0,f=Mi;l<f.length;l++){for(var d=f[l],p=0,h=an;p<h.length;p++){o=h[p];delete e[d][o]}var m=qi[d];if(m)for(var g=0,v=m;g<v.length;g++){o=v[g];delete e[d][o]}Gi(e,d)}for(var o in Gi(e,"title","group-title"),e)E(e[o])&&0===ie(e[o]).length&&delete e[o];return 0<ie(e).length?e:void 0}function Gi(e,t,n){var r="title"===t?Fi(e.title).mark:e[t];"view"===t&&(n="cell");var i=I({},r,e.style[t]);0<ie(i).length&&(e.style[n||t]=i),delete e[t]}var Bi=Object.freeze({defaultViewConfig:ji,defaultConfig:Ui,initConfig:Pi,stripAndRedirectConfig:Wi}),Yi={zero:1,center:1,normalize:1};function Vi(e){return!!Yi[e]}var Xi=[Lt,Rt,qt,jt,Gt,Bt,Ft,Ut,Pt],Qi=[Lt,Rt];function Ki(e,t,n){var r=Qt(e)?e.type:e;if(!X(Xi,r))return null;var i=function(e){var t=e.x,n=e.y;if(ar(t)&&ar(n))if("quantitative"===t.type&&"quantitative"===n.type){if(t.stack)return"x";if(n.stack)return"y";if(!!t.aggregate!=!!n.aggregate)return t.aggregate?"x":"y"}else{if("quantitative"===t.type)return"x";if("quantitative"===n.type)return"y"}else{if(ar(t)&&"quantitative"===t.type)return"x";if(ar(n)&&"quantitative"===n.type)return"y"}}(t);if(!i)return null;var o=t[i],a=ur(o)?lr(o,{}):void 0,u="x"===i?"y":"x",s=t[u],c=ur(s)?lr(s,{}):void 0,l=gt.reduce(function(r,i){if(zr(t,i)){var e=t[i];(S(e)?e:[e]).forEach(function(e){var t=Er(e);if(!t.aggregate){var n=ur(t)?lr(t,{}):void 0;(!n||n!==c&&n!==a)&&r.push({channel:i,fieldDef:t})}})}return r},[]);if(0===l.length)return null;var f=void 0;return(f=void 0!==o.stack?o.stack:X(Qi,r)&&void 0===n?"zero":n)&&Vi(f)?(o.scale&&o.scale.type&&o.scale.type!==Kr.LINEAR&&hn(en.cannotStackNonLinearScale(o.scale.type)),zr(t,i===Ue?Me:He)?(void 0!==o.stack&&hn(en.cannotStackRangedMark(i)),null):(o.aggregate&&!X(ke,o.aggregate)&&hn(en.stackNonSummativeAggregate(o.aggregate)),{groupbyChannel:s?u:void 0,fieldChannel:i,impute:Vt(r),stackBy:l,offset:f})):null}var Ji=Object.freeze({isStackOffset:Vi,STACKABLE_MARKS:Xi,STACK_BY_DEFAULT_MARKS:Qi,stack:Ki});function Zi(e){return void 0!==e.facet}function $i(e){return!!e.mark}function eo(e){return void 0!==e.layer}function to(e){return void 0!==e.repeat}function no(e){return ro(e)||io(e)}function ro(e){return void 0!==e.vconcat}function io(e){return void 0!==e.hconcat}function oo(e,t){if(Zi(e))return r=t,i=(n=e).spec,o=z(n,["spec"]),I({},o,{spec:oo(i,r)});var n,r,i,o,a,u,s,c,l,f,d,p,h,m,g,v,y,b,x,S,E,w,k,N,O,_,T,C;if(eo(e))return function t(e,n,r,i){var o=e.layer,a=e.encoding,u=e.projection,s=z(e,["layer","encoding","projection"]);var c=ao({parentEncoding:r,encoding:a});var l=uo({parentProjection:i,projection:u});return I({},s,{layer:o.map(function(e){return eo(e)?t(e,n,c,l):so(e,n,c,l)})})}(e,t);if(to(e))return u=t,s=(a=e).spec,c=z(a,["spec"]),I({},c,{spec:oo(s,u)});if(ro(e))return f=t,d=(l=e).vconcat,p=z(l,["vconcat"]),I({},p,{vconcat:d.map(function(e){return oo(e,f)})});if(io(e))return m=t,g=(h=e).hconcat,v=z(h,["hconcat"]),I({},v,{hconcat:g.map(function(e){return oo(e,m)})});if($i(e)){var A=zr(e.encoding,Ye),D=zr(e.encoding,Ve);return A||D?(b=t,x=(y=e).encoding,S=x.row,E=x.column,w=z(x,["row","column"]),k=y.mark,N=y.width,O=y.projection,_=y.height,T=y.selection,y.encoding,C=z(y,["mark","width","projection","height","selection","encoding"]),I({},C,{facet:I({},S?{row:S}:{},E?{column:E}:{}),spec:so(I({},O?{projection:O}:{},{mark:k},N?{width:N}:{},_?{height:_}:{},{encoding:w},T?{selection:T}:{}),b)})):so(e,t)}throw new Error(en.INVALID_SPEC)}function ao(e){var t=e.parentEncoding,n=e.encoding;if(t&&n){var r=ie(t).reduce(function(e,t){return n[t]&&e.push(t),e},[]);0<r.length&&hn(en.encodingOverridden(r))}var i=I({},t||{},n||{});return 0<ie(i).length?i:void 0}function uo(e){var t=e.parentProjection,n=e.projection;return t&&n&&hn(en.projectionOverridden({parentProjection:t,projection:n})),n||t}function so(e,t,n,r){var i=e.encoding,o=e.projection,a=Qt(e.mark)?e.mark.type:e.mark;if(n||r){var u=uo({parentProjection:r,projection:o}),s=ao({parentEncoding:n,encoding:i});return so(I({},e,u?{projection:u}:{},s?{encoding:s}:{}),t)}return Jt(e.mark)?Fr(i)?function(e){var t=zr(e.encoding,Ue),n=zr(e.encoding,Pe),r=zr(e.encoding,Me),i=zr(e.encoding,He);if(r&&!t||i&&!n){var o=ue(e);return r&&!t&&(o.encoding.x=o.encoding.x2,delete o.encoding.x2),i&&!n&&(o.encoding.y=o.encoding.y2,delete o.encoding.y2),o}return e}(e):"line"===a&&(i.x2||i.y2)?(hn(en.lineWithRange(!!i.x2,!!i.y2)),so(I({mark:"rule"},e),t,n,r)):Vt(a)?function(e,t){void 0===t&&(t={});var n,r=e.selection,i=e.projection,o=e.encoding,a=e.mark,u=z(e,["selection","projection","encoding","mark"]),s=Qt(a)?a:{type:a},c=(p=s,h=t[s.type],m=o,"transparent"===p.point?{opacity:0}:p.point?E(p.point)?p.point:{}:void 0!==p.point?null:h.point||m.shape?E(h.point)?h.point:{}:null),l="area"===s.type&&(f=s,d=t[s.type],f.line?!0===f.line?{}:f.line:void 0!==f.line?null:d.line?!0===d.line?{}:d.line:null);var f,d;var p,h,m;if(!c&&!l)return I({},e,{mark:co(s)});var g=[I({},r?{selection:r}:{},{mark:co(I({},s,"area"===s.type?{opacity:.7}:{})),encoding:B(o,["shape"])})],v=Ki(s,o,t?t.stack:void 0),y=o;if(v){var b=v.fieldChannel,x=v.offset;y=I({},o,((n={})[b]=I({},o[b],x?{stack:x}:{}),n))}l&&g.push(I({},i?{projection:i}:{},{mark:I({type:"line"},G(s,["clip","interpolate"]),l),encoding:y}));c&&g.push(I({},i?{projection:i}:{},{mark:I({type:"point",opacity:1,filled:!0},G(s,["clip"]),c),encoding:y}));return I({},u,{layer:g})}(e,t):e:Qr(e,t)}function co(e){e.point,e.line;var t=z(e,["point","line"]);return 1<ie(t).length?t:t.type}function lo(t,e){return e.forEach(function(n){var e=V(["field","type","value","timeUnit","bin","aggregate"].reduce(function(e,t){return void 0!==n[t]&&(e[t]=n[t]),e},{}));t[e]=t[e]||n}),t}var fo=Object.freeze({isFacetSpec:Zi,isUnitSpec:$i,isLayerSpec:eo,isRepeatSpec:to,isConcatSpec:no,isVConcatSpec:ro,isHConcatSpec:io,normalize:oo,fieldDefs:function(e){return oe(function t(e,n){return void 0===n&&(n={}),eo(e)?e.layer.forEach(function(e){$i(e)?lo(n,jr(e.encoding)):t(e,n)}):Zi(e)?(lo(n,jr(e.facet)),t(e.spec,n)):to(e)?t(e.spec,n):no(e)?(ro(e)?e.vconcat:e.hconcat).forEach(function(e){return t(e,n)}):lo(n,jr(e.encoding)),n}(e))},isStacked:function(e,t){return t=t||e.config,!!Jt(e.mark)&&null!==Ki(e.mark,e.encoding,t?t.stack:void 0)}});function po(e){return m(e)?{type:e}:e||{}}var ho=["background","padding","datasets"];function mo(n){return ho.reduce(function(e,t){return n&&void 0!==n[t]&&(e[t]=n[t]),e},{})}function go(e){return!!e.url}function vo(e){return!!e.values}function yo(e){return!!e.name&&!go(e)&&!vo(e)}var bo="main",xo="raw",So=Object.freeze({isUrlData:go,isInlineData:vo,isNamedData:yo,MAIN:bo,RAW:xo});function Eo(e,t,n){return wo=t||No,ko=n||Lo,jo(e.trim()).map(Uo)}var wo,ko,No="view",Oo="[",_o="]",To="{",Co="}",Ao=":",Do=",",Io="@",zo=">",Ro=/[[\]{}]/,Lo={"*":1,arc:1,area:1,group:1,image:1,line:1,path:1,rect:1,rule:1,shape:1,symbol:1,text:1,trail:1};function Fo(e,t,n,r,i){for(var o,a=0,u=e.length;t<u;++t){if(o=e[t],!a&&o===n)return t;i&&0<=i.indexOf(o)?--a:r&&0<=r.indexOf(o)&&++a}return t}function jo(e){for(var t=[],n=0,r=e.length,i=0;i<r;)i=Fo(e,i,Do,Oo+To,_o+Co),t.push(e.substring(n,i).trim()),n=++i;if(0===t.length)throw"Empty event selector: "+e;return t}function Uo(e){return"["===e[0]?function(e){var t,n,r=e.length,i=1;if((i=Fo(e,i,_o,Oo,_o))===r)throw"Empty between selector: "+e;if(2!==(t=jo(e.substring(1,i))).length)throw"Between selector must have two elements: "+e;if((e=e.slice(i+1).trim())[0]!==zo)throw"Expected '>' after between selector: "+e;{if(t=t.map(Uo),(n=Uo(e.slice(1).trim())).between)return{between:t,stream:n};n.between=t}return n}(e):function(t){var e,n,r={source:wo},i=[],o=[0,0],a=0,u=0,s=t.length,c=0;if(t[s-1]===Co){if(!(0<=(c=t.lastIndexOf(To))))throw"Unmatched right brace: "+t;try{o=function(n){var e=n.split(Do);if(!n.length||2<e.length)throw n;return e.map(function(e){var t=+e;if(t!=t)throw n;return t})}(t.substring(c+1,s-1))}catch(e){throw"Invalid throttle specification: "+t}t=t.slice(0,c).trim(),s=t.length,c=0}if(!s)throw t;t[0]===Io&&(a=++c);(e=Fo(t,c,Ao))<s&&(i.push(t.substring(u,e).trim()),u=c=++e);if((c=Fo(t,c,Oo))===s)i.push(t.substring(u,s).trim());else if(i.push(t.substring(u,c).trim()),n=[],(u=++c)===s)throw"Unmatched left bracket: "+t;for(;c<s;){if((c=Fo(t,c,_o))===s)throw"Unmatched left bracket: "+t;if(n.push(t.substring(u,c).trim()),c<s-1&&t[++c]!==Oo)throw"Expected left bracket: "+t;u=++c}if(!(s=i.length)||Ro.test(i[s-1]))throw"Invalid event selector: "+t;1<s?(r.type=i[1],a?r.markname=i[0].slice(1):(l=i[0],ko.hasOwnProperty(l)?r.marktype=i[0]:r.source=i[0])):r.type=i[0];var l;"!"===r.type.slice(-1)&&(r.consume=!0,r.type=r.type.slice(0,-1));null!=n&&(r.filter=n);o[0]&&(r.throttle=o[0]);o[1]&&(r.debounce=o[1]);return r}(e)}function Po(e){return!!e.signal}function Mo(e){return!!e.step}function Ho(e){return!S(e)&&("field"in e&&"data"in e)}var qo=ae({opacity:1,fill:1,fillOpacity:1,stroke:1,strokeCap:1,strokeWidth:1,strokeOpacity:1,strokeDash:1,strokeDashOffset:1,strokeJoin:1,strokeMiterLimit:1,size:1,shape:1,interpolate:1,tension:1,orient:1,align:1,baseline:1,text:1,dir:1,dx:1,dy:1,ellipsis:1,limit:1,radius:1,theta:1,angle:1,font:1,fontSize:1,fontWeight:1,fontStyle:1,cursor:1,href:1,tooltip:1,cornerRadius:1});function Wo(e,n,t,r){void 0===r&&(r={header:!1});var i=e.combine(),o=i.orient,a=i.scale,u=i.title,s=i.zindex,c=z(i,["orient","scale","title","zindex"]);if(ie(c).forEach(function(e){var t=Ce[e];t&&t!==n&&"both"!==t&&delete c[e]}),"grid"===n){if(!c.grid)return;if(c.encode){var l=c.encode.grid;c.encode=I({},l?{grid:l}:{}),0===ie(c.encode).length&&delete c.encode}return I({scale:a,orient:o},c,{domain:!1,labels:!1,maxExtent:0,minExtent:0,ticks:!1,zindex:void 0!==s?s:0})}if(r.header||!e.mainExtracted){if(c.encode){for(var f=0,d=Te;f<d.length;f++){var p=d[f];e.hasAxisPart(p)||delete c.encode[p]}0===ie(c.encode).length&&delete c.encode}var h,m,g=(m=t,S(h=u)?h.map(function(e){return xr(e,m)}).join(", "):h);return I({scale:a,orient:o,grid:!1},g?{title:g}:{},c,{zindex:void 0!==s?s:1})}}var Go={titleAnchor:"anchor",titleAngle:"angle",titleBaseline:"baseline",titleColor:"color",titleFont:"font",titleFontSize:"fontSize",titleFontWeight:"fontWeight",titleLimit:"limit"},Bo={labelAngle:"angle",labelColor:"color",labelFont:"font",labelFontSize:"fontSize",labelLimit:"limit"},Yo=Object.keys(Go),Vo=Object.keys(Bo),Xo=Object.freeze({HEADER_TITLE_PROPERTIES_MAP:Go,HEADER_LABEL_PROPERTIES_MAP:Bo,HEADER_TITLE_PROPERTIES:Yo,HEADER_LABEL_PROPERTIES:Vo});function Qo(e){return!(!e||"count"!==e.op&&!e.field||!e.op)}function Ko(e){return!!e&&S(e)}var Jo=Object.freeze({isSortField:Qo,isSortArray:Ko});function Zo(e,t){var n=t[e+"Offset"];if(n)return n}function $o(e,t,n,r){return ea(e,t,{binSuffix:"start"===n?void 0:"end"},r?{offset:r}:{})}function ea(e,t,n,r){var i=I({},t?{scale:t}:{},{field:lr(e,n)});return r?I({},i,r):i}function ta(e,t){return void 0===t&&(t=!0),{scale:e,band:t}}function na(e,t,n,r,i,o){if(t){if(ar(t)){if(t.bin)return X([Ue,Pe],e)&&t.type===Vn?i&&i.impute?ea(t,n,{binSuffix:"mid"}):{signal:'(scale("'+(c=n)+'", '+lr(s=t,{expr:"datum"})+') + scale("'+c+'", '+lr(s,{binSuffix:"end",expr:"datum"})+"))/2"}:ea(t,n,Ia(t,e)?{binSuffix:"range"}:{});if(r){var a=r.get("type");if(yi(a))return"band"===a?ea(t,n,{binSuffix:"range"},{band:.5}):ea(t,n,{binSuffix:"range"})}return ea(t,n,{})}if(sr(t)){var u=t.value;return X(["x","x2"],e)&&"width"===u?{field:{group:"width"}}:X(["y","y2"],e)&&"height"===u?{field:{group:"height"}}:{value:u}}}var s,c;return"function"==typeof o?o():o}function ra(e,t){if(e){if(ar(e))return Sa(e,e.format,"datum",t);if(sr(e))return{value:e.value}}}function ia(e){return I({},e,{mult:.5})}function oa(t,n,r,i,o){return function(){if(m(t)){if(r){var e=i.get("type");if(X([Kr.LOG,Kr.TIME,Kr.UTC],e))"bar"!==o&&"area"!==o||hn(en.nonZeroScaleUsedWithLengthMark(o,n,{scaleType:e}));else{if(function(e){if(!1!==e.get("zero"))return!0;var t=e.domains;return!!S(t)&&K(t,function(e){return S(e)&&2===e.length&&e[0]<=0&&0<=e[1]})}(i))return{scale:r,value:0};"bar"!==o&&"area"!==o||hn(en.nonZeroScaleUsedWithLengthMark(o,n,{zeroFalse:!1===i.explicit.zero}))}}return"zeroOrMin"===t?"x"===n?{value:0}:{field:{group:"height"}}:"x"===n?{field:{group:"width"}}:{value:0}}return t}}function aa(e,t){var n,r;void 0===t&&(t={valueOnly:!1});var i=e.markDef,o=e.encoding,a=e.config,u=i.filled,s=i.type,c={fill:xa("fill",i,a),stroke:xa("stroke",i,a),color:xa("color",i,a)},l=X(["bar","point","circle","square","geoshape"],s)?"transparent":void 0,f={fill:i.fill||c.fill||l,stroke:i.stroke||c.stroke},d=u?"fill":"stroke",p=I({},f.fill?{fill:{value:f.fill}}:{},f.stroke?{stroke:{value:f.stroke}}:{});return o.fill||o.stroke?(i.color&&hn(en.droppingColor("property",{fill:"fill"in o,stroke:"stroke"in o})),I({},la("fill",e,{defaultValue:f.fill||l}),la("stroke",e,{defaultValue:f.stroke}))):o.color?I({},p,la("color",e,{vgChannel:d,defaultValue:i[d]||i.color||c[d]||c.color||(u?l:void 0)})):i.fill||i.stroke?(i.color&&hn(en.droppingColor("property",{fill:"fill"in i,stroke:"stroke"in i})),p):i.color?I({},p,((n={})[d]={value:i.color},n)):c.fill||c.stroke?p:c.color?I({},l?{fill:{value:"transparent"}}:{},((r={})[d]={value:c.color},r)):{}}function ua(e,t){return I({},(n=e.markDef,r=t,qo.reduce(function(e,t){return void 0!==n[t]&&"ignore"!==r[t]&&(e[t]={value:n[t]}),e},{})),aa(e),la("opacity",e),function(r){var e="tooltip",t=r.encoding[e];{if(S(t)){var n=t.map(function(e){var t=void 0!==e.title?e.title:lr(e,{binSuffix:"range"}),n=ra(e,r.config).signal;return'"'+t+'": '+n});return{tooltip:{signal:"{"+n.join(", ")+"}"}}}return pa(r,e,t)}}(e),da(e,"href"));var n,r}function sa(e){return e+" !== null && !isNaN("+e+")"}function ca(n){if("filter"===n.config.invalidValues){var e=["x","y"].map(function(e){var t=n.getScaleComponent(e);if(t&&xi(t.get("type")))return n.vgField(e,{expr:"datum"})}).filter(function(e){return!!e}).map(sa);if(0<e.length)return{defined:{signal:e.join(" && ")}}}return{}}function la(t,n,e){void 0===e&&(e={});var r=e.defaultValue,i=e.vgChannel,o=e.defaultRef||(void 0!==r?{value:r}:void 0),a=n.encoding[t];return fa(n,a,i||t,function(e){return na(t,e,n.scaleName(t),n.getScaleComponent(t),null,o)})}function fa(r,e,t,i){var n,o,a=e&&e.condition,u=i(e);if(a){var s=(S(a)?a:[a]).map(function(e){var t=i(e),n=er(e)?ks(r,e.selection):Ms(r,e.test);return I({test:n},t)});return(n={})[t]=s.concat(void 0!==u?[u]:[]),n}return void 0!==u?((o={})[t]=u,o):{}}function da(e,t){return void 0===t&&(t="text"),pa(e,t,e.encoding[t])}function pa(t,e,n){return fa(t,n,e,function(e){return ra(e,t.config)})}function ha(e,t,n){var r,i,o,a=n.scaleName(t),u="x"===t?"width":"height";if(n.encoding.size||void 0!==n.markDef.size)if(n.markDef.orient){var s=((r={})[t+"c"]=ea(e,a,{},{band:.5}),r);if(Er(n.encoding.size))return I({},s,la("size",n,{vgChannel:u}));if(sr(n.encoding.size))return I({},s,la("size",n,{vgChannel:u}));if(void 0!==n.markDef.size)return I({},s,((i={})[u]={value:n.markDef.size},i))}else hn(en.cannotApplySizeToNonOrientedMark(n.markDef.type));return(o={})[t]=ea(e,a,{binSuffix:"range"}),o[u]=ta(a),o}function ma(e,t,n,r){var i="x"===e?"width":"height";return I({},va(e,t,n,"x"===e?"xc":"yc"),la("size",t,{defaultRef:r,vgChannel:i}))}function ga(e,t,n,r,i){return"x"===t?{x2:$o(e,n,"start",i?0:r),x:$o(e,n,"end",i?r:0)}:{y2:$o(e,n,"start",i?r:0),y:$o(e,n,"end",i?0:r)}}function va(e,t,n,r){var i,o,a,u,s,c,l,f=t.encoding,d=t.mark,p=t.stack,h=f[e],m=t.scaleName(e),g=t.getScaleComponent(e),v=Zo(e,t.markDef),y=h||!f.latitude&&!f.longitude?I({},(a=f[o=e],c=p,l=oa(n,e,u=m,s=g,d),ar(a)&&c&&o===c.fieldChannel?ea(a,u,{suffix:"end"}):na(o,a,u,s,c,l)),v?{offset:v}:{}):{field:t.getName(e)};return(i={})[r||e]=y,i}function ya(e,t,n){var r,i,o,a,u,s,c,l,f=e.encoding,d=e.mark,p=e.stack,h="x2"===n?"x":"y",m=f[h],g=e.scaleName(h),v=e.getScaleComponent(h),y=Zo(n,e.markDef),b=m||!f.latitude&&!f.longitude?I({},(o=m,a=f[i=n],c=p,l=oa(t,h,u=g,s=v,d),ar(o)&&c&&i.charAt(0)===c.fieldChannel.charAt(0)?ea(o,u,{suffix:"start"}):na(i,a,u,s,c,l)),y?{offset:y}:{}):{field:e.getName(n)};return(r={})[n]=b,r}function ba(e){return[].concat(e.type,e.style||[])}function xa(e,t,n){var r=n.mark[e],i=n[t.type];void 0!==i[e]&&(r=i[e]);for(var o=0,a=ba(t);o<a.length;o++){var u=a[o],s=n.style[u],c=e;s&&void 0!==s[c]&&(r=s[c])}return r}function Sa(e,t,n,r){var i=wa(e,t,r);if(e.bin)return{signal:Oa(lr(e,{expr:n}),lr(e,{expr:n,binSuffix:"end"}),i,r)};if("quantitative"===e.type)return{signal:""+ka(lr(e,{expr:n,binSuffix:"range"}),i)};if(Cr(e)){var o=cr(e)&&e.scale&&e.scale.type===Kr.UTC;return{signal:_a(lr(e,{expr:n}),e.timeUnit,t,r.text.shortTimeLabels,r.timeFormat,o,!0)}}return{signal:"''+"+lr(e,{expr:n})}}function Ea(e,t){return void 0!==e?e:t}function wa(e,t,n){if(e.type===Vn)return t||n.numberFormat}function ka(e,t){return"format("+e+', "'+(t||"")+'")'}function Na(e,t,n){return ka(e,t||n.numberFormat)}function Oa(e,t,n,r){return e+" === null || isNaN("+e+') ? "null" : '+Na(e,n,r)+' + " - " + '+Na(t,n,r)}function _a(e,t,n,r,i,o,a){return void 0===a&&(a=!1),!t||n?(n=n||i)||a?(o?"utc":"time")+"Format("+e+", '"+n+"')":void 0:Hn(t,e,r,o)}function Ta(e,n){return(S(e)?e:[e]).reduce(function(e,t){return e.field.push(lr(t,n)),e.order.push(t.sort||"ascending"),e},{field:[],order:[]})}function Ca(e,t){var i=e.slice();return t.forEach(function(e){for(var t=0,n=i;t<n.length;t++){var r=n[t];if(Y(r)===Y(e))return}i.push(e)}),i}function Aa(e,t){return e===t?e:e+", "+t}function Da(e,t){if(S(e.value)&&S(t.value))return{explicit:e.explicit,value:Ca(e.value,t.value)};if(!S(e.value)&&!S(t.value))return{explicit:e.explicit,value:Aa(e.value,t.value)};throw new Error("It should never reach here")}function Ia(e,t){return e.bin?wt(t)&&X(["ordinal","nominal"],e.type):(console.warn("Only use this method with binned field defs"),!1)}function za(r,i){return ie(r).reduce(function(e,t){var n=r[t];return I({},e,fa(i,n,t,function(e){return{value:e.value}}))},{})}var Ra=function(){function e(e,t){this.debugName=t,this._children=[],this._parent=null,e&&(this.parent=e)}return e.prototype.clone=function(){throw new Error("Cannot clone node")},e.prototype.producedFields=function(){return{}},e.prototype.dependentFields=function(){return{}},Object.defineProperty(e.prototype,"parent",{get:function(){return this._parent},set:function(e){(this._parent=e).addChild(this)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"children",{get:function(){return this._children},enumerable:!0,configurable:!0}),e.prototype.numChildren=function(){return this._children.length},e.prototype.addChild=function(e){this._children.push(e)},e.prototype.removeChild=function(e){this._children.splice(this._children.indexOf(e),1)},e.prototype.remove=function(){for(var e=0,t=this._children;e<t.length;e++){t[e].parent=this._parent}this._parent.removeChild(this)},e.prototype.insertAsParentOf=function(e){var t=e.parent;t.removeChild(this),this.parent=t,e.parent=this},e.prototype.swapWithParent=function(){for(var e=this._parent,t=e.parent,n=0,r=this._children;n<r.length;n++){r[n].parent=e}this._children=[],e.removeChild(this),e.parent.removeChild(e),this.parent=t,e.parent=this},e}(),La=function(o){function e(e,t,n,r){var i=o.call(this,e,t)||this;return i.type=n,i.refCounts=r,i._source=i._name=t,!i.refCounts||i._name in i.refCounts||(i.refCounts[i._name]=0),i}return h(e,o),e.prototype.clone=function(){var e=new this.constructor;return e.debugName="clone_"+this.debugName,e._source=this._source,e._name="clone_"+this._name,e.type=this.type,e.refCounts=this.refCounts,e.refCounts[e._name]=0,e},e.prototype.getSource=function(){return this.refCounts[this._name]++,this._source},e.prototype.isRequired=function(){return!!this.refCounts[this._name]},e.prototype.setSource=function(e){this._source=e},e}(Ra),Fa=function(r){function u(e,t){var n=r.call(this,e)||this;return n.transform=t,n}return h(u,r),u.prototype.clone=function(){return new u(null,ue(this.transform))},u.parseAllForSortIndex=function(a,e){return e.forEachFieldDef(function(e,t){if(cr(e)&&Ko(e.sort)){var n=e.field,r=e.timeUnit,i=e.sort,o=i.map(function(e,t){return qs({field:n,timeUnit:r,equal:e})+" ? "+t+" : "}).join("")+i.length;a=new u(a,{calculate:o,as:ja(e,t)})}}),a},u.prototype.producedFields=function(){var e={};return e[this.transform.as]=!0,e},u.prototype.assemble=function(){return{type:"formula",expr:this.transform.calculate,as:this.transform.as}},u}(Ra);function ja(e,t,n){return lr(e,{prefix:t,suffix:"sort_index",expr:n})}var Ua=["row","column"],Pa=["header","footer"];function Ma(e,t){for(var n=e.component.layoutHeaders[t],r=[],i=0,o=Pa;i<o.length;i++){var a=o[i];if(n[a])for(var u=0,s=n[a];u<s.length;u++){var c=s[u];r.push(Ha(e,t,a,n,c))}}return r}function Ha(e,t,n,r,i){var o,a,u,s,c;if(i){var l=null,f=r.facetFieldDef;if(f&&i.labels){var d=f.header,p=void 0===d?{}:d,h=p.format,m=p.labelAngle,g=e.config?e.config:void 0,v=I({},(90+(c=((c=m)%360+360)%360))%180==0?{}:c<90||270<c?{align:{value:"right"}}:135<=c&&c<225?{align:{value:"left"}}:{});l=I({text:Sa(f,h,"parent",e.config),offset:10,orient:"row"===t?"left":"top",style:"guide-label"},qa(g,f,Vo,Bo),0<ie(v).length?{encode:{update:v}}:{})}var y=i.axes,b=y&&0<y.length;if(l||b){var x="row"===t?"height":"width";return I({name:e.getName(t+"_"+n),type:"group",role:t+"-"+n},r.facetFieldDef?{from:{data:e.getName(t+"_domain")},sort:(a=f,u=t,s=a.sort,Qo(s)?{field:lr(s,{expr:"datum"}),order:s.order||"ascending"}:S(s)?{field:ja(a,u,"datum"),order:"ascending"}:{field:lr(a,{expr:"datum"}),order:s||"ascending"})}:{},l?{title:l}:{},i.sizeSignal?{encode:{update:(o={},o[x]=i.sizeSignal,o)}}:{},b?{axes:y}:{})}}return null}function qa(e,t,n,r){for(var i={},o=0,a=n;o<a.length;o++){var u=a[o];e&&e.header&&e.header[u]&&(i[r[u]]=e.header[u]),t&&t.header&&t.header[u]&&(i[r[u]]=t.header[u])}return i}function Wa(e){return[].concat(Ga(e,"width"),Ga(e,"height"))}function Ga(e,t){var n="width"===t?"x":"y",r=e.component.layoutSize.get(t);if(!r||"merged"===r)return[];var i=e.getSizeSignalRef(t).signal;if("range-step"===r){var o=e.getScaleComponent(n);if(o){var a=o.get("type"),u=o.get("range");if(yi(a)&&Mo(u)){var s=e.scaleName(n);if(Yu(e.parent))if("independent"===e.parent.component.resolve.scale[n])return[Ba(s,u)];return[Ba(s,u),{name:i,update:Ya(s,o,"domain('"+s+"').length")}]}}throw new Error("layout size is range step although there is no rangeStep.")}return[{name:i,value:r}]}function Ba(e,t){return{name:e+"_step",value:t.step}}function Ya(e,t,n){var r=t.get("type"),i=t.get("padding"),o=t.get("paddingOuter");o=void 0!==o?o:i;var a=t.get("paddingInner");return"bandspace("+n+", "+(a="band"===r?void 0!==a?a:i:1)+", "+o+") * "+e+"_step"}function Va(e,t){var n=e.scale[t],r=X(yt,t)?"axis":"legend";return"independent"===n?("shared"===e[r][t]&&hn(en.independentScaleMeansIndependentGuide(t)),"independent"):e[r][t]||"shared"}var Xa=function(){function e(e,t){void 0===e&&(e={}),void 0===t&&(t={}),this.explicit=e,this.implicit=t}return e.prototype.clone=function(){return new e(ue(this.explicit),ue(this.implicit))},e.prototype.combine=function(){return I({},this.explicit,this.implicit)},e.prototype.get=function(e){return void 0!==this.explicit[e]?this.explicit[e]:this.implicit[e]},e.prototype.getWithExplicit=function(e){return void 0!==this.explicit[e]?{explicit:!0,value:this.explicit[e]}:void 0!==this.implicit[e]?{explicit:!1,value:this.implicit[e]}:{explicit:!1,value:void 0}},e.prototype.setWithExplicit=function(e,t){void 0!==t.value&&this.set(e,t.value,t.explicit)},e.prototype.set=function(e,t,n){return delete this[n?"implicit":"explicit"][e],this[n?"explicit":"implicit"][e]=t,this},e.prototype.copyKeyFromSplit=function(e,t){void 0!==t.explicit[e]?this.set(e,t.explicit[e],!0):void 0!==t.implicit[e]&&this.set(e,t.implicit[e],!1)},e.prototype.copyKeyFromObject=function(e,t){void 0!==t[e]&&this.set(e,t[e],!0)},e.prototype.copyAll=function(e){for(var t=0,n=ie(e.combine());t<n.length;t++){var r=n[t],i=e.getWithExplicit(r);this.setWithExplicit(r,i)}},e}();function Qa(e){return{explicit:!0,value:e}}function Ka(e){return{explicit:!1,value:e}}function Ja(o){return function(e,t,n,r){var i=o(e.value,t.value);return 0<i?e:i<0?t:Za(e,t,n,r)}}function Za(e,t,n,r){return e.explicit&&t.explicit&&hn(en.mergeConflictingProperty(n,r,e.value,t.value)),e}function $a(e,t,n,r,i){return void 0===i&&(i=Za),void 0===e||void 0===e.value?t:e.explicit&&!t.explicit?e:t.explicit&&!e.explicit?t:Y(e.value)===Y(t.value)?e:i(e,t,n,r)}var eu=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return h(t,e),t}(Xa);function tu(e){return ru(e,function(e,t){return Math.max(e,t.value)})}function nu(e){return ru(e,function(e,t){return void 0!==e?e:t.value})}function ru(e,t){return or(e)?(S(e.condition)?e.condition:[e.condition]).reduce(t,e.value):sr(e)?e.value:void 0}var iu=Object.freeze({symbols:function(e,t,n,r,i){if("gradient"!==i){var o=I({},function(e,t,n){for(var r=0,i=n;r<i.length;r++){var o=i[r],a=xa(o,t.markDef,t.config);void 0!==a&&(e[o]={value:a})}return e}({},n,on),aa(n));switch(n.mark){case Lt:case Pt:case Ut:o.shape={value:"square"};break;case Gt:case Bt:o.shape={value:n.mark}}var a=n.markDef,u=n.encoding,s=a.filled;if(o.fill)if("fill"===r||s&&r===Ke)delete o.fill;else if(o.fill.field)delete o.fill;else if(S(o.fill)){var c=nu(u.fill||u.color)||a.fill||s&&a.color;c&&(o.fill={value:c})}if(o.stroke)if("stroke"===r||!s&&r===Ke)delete o.stroke;else if(o.stroke.field)delete o.stroke;else if(S(o.stroke)){var l=nu(u.stroke||u.color)||a.stroke||!s&&a.color;l&&(o.stroke={value:l})}if(o.fill&&"transparent"!==o.fill.value&&!o.stroke&&(o.stroke={value:"transparent"}),r!==Xe){var f=nu(u.shape)||a.shape;f&&(o.shape={value:f})}if(r!==rt){var d=tu(u.opacity)||a.opacity;d&&(o.opacity={value:d})}return o=I({},o,t),0<ie(o).length?o:void 0}},gradient:function(e,t,n,r,i){var o={};if("gradient"===i){var a=tu(n.encoding.opacity)||n.markDef.opacity;a&&(o.opacity={value:a})}return o=I({},o,t),0<ie(o).length?o:void 0},labels:function(e,t,n,r,i){var o=n.legend(r),a=n.config,u={};if(Cr(e)){var s=n.getScaleComponent(r).get("type")===Kr.UTC,c=_a("datum.value",e.timeUnit,o.format,a.legend.shortTimeLabels,a.timeFormat,s);t=I({},c?{text:{signal:c}}:{},t)}return u=I({},u,t),0<ie(u).length?u:void 0}});function ou(e){var r,i;Bu(e)?e.component.legends=(i=(r=e).encoding,[Ke,Je,Ze,Qe,Xe,rt].reduce(function(e,t){var n=i[t];return!r.legend(t)||!r.getScaleComponent(t)||ar(n)&&t===Xe&&n.type===Jn||(e[t]=function(i,o){var a=i.fieldDef(o),r=i.legend(o),u=new eu({},function(e,t){var n;switch(t){case Ke:var r=e.scaleName(Ke);return e.markDef.filled?{fill:r}:{stroke:r};case Je:case Ze:case Qe:case Xe:case rt:return(n={})[t]=e.scaleName(t),n}}(i,o));ri.forEach(function(e){var t=function(e,t,n,r){var i=r.fieldDef(n);switch(e){case"format":return wa(i,t.format,r.config);case"title":var o=void 0!==i.title?i.title:t.title||(void 0===t.title?void 0:null);return Ea(o,xr(i,r.config))||void 0;case"values":return function(e,t){var n=e.values;if(n)return Dr(t,n)}(t,i);case"type":return Ea(t.type,function(e,t,n){if(ct(t)&&("quantitative"===e&&!bi(n)||"temporal"===e&&X(["time","utc"],n)))return"gradient"}(i.type,n,r.getScaleComponent(n).get("type")))}return t[e]}(e,r,o,i);if(void 0!==t){var n="values"===e?!!r.values:"title"===e&&t===i.fieldDef(o).title||t===r[e];(n||void 0===i.config.legend[e])&&u.set(e,t,n)}});var s=r.encoding||{},e=["labels","legend","title","symbols","gradient"].reduce(function(e,t){var n=za(s[t]||{},i),r=iu[t]?iu[t](a,n,i,o,u.get("type")):n;return void 0!==r&&0<ie(r).length&&(e[t]={update:r}),e},{});return 0<ie(e).length&&u.set("encode",e,!!r.encoding),u}(r,t)),e},{})):e.component.legends=function(i){for(var e=i.component,n=e.legends,o=e.resolve,t=function(t){ou(t),ie(t.component.legends).forEach(function(e){o.legend[e]=Va(i.component.resolve,e),"shared"===o.legend[e]&&(n[e]=au(n[e],t.component.legends[e]),n[e]||(o.legend[e]="independent",delete n[e]))})},r=0,a=i.children;r<a.length;r++){var u=a[r];t(u)}return ie(n).forEach(function(e){for(var t=0,n=i.children;t<n.length;t++){var r=n[t];r.component.legends[e]&&"shared"===o.legend[e]&&delete r.component.legends[e]}}),n}(e)}function au(t,r){if(!t)return r.clone();var e=t.getWithExplicit("orient"),n=r.getWithExplicit("orient");if(!e.explicit||!n.explicit||e.value===n.value){for(var i=!1,o=function(n){var e=$a(t.getWithExplicit(n),r.getWithExplicit(n),n,"legend",function(e,t){switch(n){case"title":return Da(e,t);case"type":return i=!0,Ka("symbol")}return Za(e,t,n,"legend")});t.setWithExplicit(n,e)},a=0,u=ii;a<u.length;a++){o(u[a])}return i&&(((t.implicit||{}).encode||{}).gradient&&fe(t.implicit,["encode","gradient"]),((t.explicit||{}).encode||{}).gradient&&fe(t.explicit,["encode","gradient"])),t}}function uu(e){for(var t=e.component.legends,n={},r=0,i=ie(t);r<i.length;r++){var o=i[r],a=e.getScaleComponent(o),u=Y(a.domains);if(n[u])for(var s=0,c=n[u];s<c.length;s++){au(c[s],t[o])||n[u].push(t[o])}else n[u]=[t[o].clone()]}return Z(oe(n)).map(function(e){return e.combine()})}function su(e){return Qu(e)||Xu(e)||Vu(e)?(t=e).children.reduce(function(e,t){return e.concat(t.assembleProjections())},cu(t)):cu(e);var t}function cu(r){var e=r.component.projection;if(!e||e.merged)return[];var t=e.combine(),n=t.name,i=z(t,["name"]),o={signal:"["+e.size.map(function(e){return e.signal}).join(", ")+"]"},a=e.data.reduce(function(e,t){var n=Po(t)?t.signal:"data('"+r.lookupDataSource(t)+"')";return X(e,n)||e.push(n),e},[]);if(a.length<=0)throw new Error("Projection's fit didn't find any data sources");return[I({name:n,size:o,fit:{signal:1<a.length?"["+a.join(", ")+"]":a[0]}},i)]}var lu=["type","clipAngle","clipExtent","center","rotate","precision","coefficient","distance","fraction","lobes","parallel","radius","ratio","spacing","tilt"],fu=function(o){function e(e,t,n,r){var i=o.call(this,I({},t),{name:e})||this;return i.specifiedProjection=t,i.size=n,i.data=r,i.merged=!1,i}return h(e,o),e}(Xa);function du(e){Bu(e)?e.component.projection=function(t){var e=t.specifiedProjection,n=t.config;if(t.hasProjection){var r=[];return[[Ge,qe],[Be,We]].forEach(function(e){(t.channelHasField(e[0])||t.channelHasField(e[1]))&&r.push({signal:t.getName("geojson_"+r.length)})}),t.channelHasField(Xe)&&t.fieldDef(Xe).type===Jn&&r.push({signal:t.getName("geojson_"+r.length)}),0===r.length&&r.push(t.requestDataName(bo)),new fu(t.projectionName(!0),I({},n.projection||{},e||{}),[t.getSizeSignalRef("width"),t.getSizeSignalRef("height")],r)}return}(e):e.component.projection=function(e){if(0===e.children.length)return;var r,t=J(e.children,function(e){du(e);var t=e.component.projection;if(t){if(r){var n=function(t,n){var e=J(lu,function(e){return!t.explicit.hasOwnProperty(e)&&!n.explicit.hasOwnProperty(e)||!(!t.explicit.hasOwnProperty(e)||!n.explicit.hasOwnProperty(e)||Y(t.get(e))!==Y(n.get(e)))});if(Y(t.size)===Y(n.size)){if(e)return t;if(Y(t.explicit)===Y({}))return n;if(Y(n.explicit)===Y({}))return t}return null}(r,t);return n&&(r=n),!!n}return r=t,!0}return!0});if(r&&t){var n=e.projectionName(!0),i=new fu(n,r.specifiedProjection,r.size,ue(r.data));return e.children.forEach(function(e){e.component.projection&&(i.data=i.data.concat(e.component.projection.data),e.renameProjection(e.component.projection.get("name"),n),e.component.projection.merged=!0)}),i}return}(e)}var pu=function(i){function d(e,t,n){var r=i.call(this,e)||this;return r.dimensions=t,r.measures=n,r}return h(d,i),d.prototype.clone=function(){return new d(null,I({},this.dimensions),ue(this.measures))},d.makeFromEncoding=function(e,u){var t=!1;u.forEachFieldDef(function(e){e.aggregate&&(t=!0)});var s={},c={};return t?(u.forEachFieldDef(function(e,t){var n,r,i,o=e.aggregate,a=e.field;o?"count"===o?(s["*"]=s["*"]||{},s["*"].count=lr(e)):(s[a]=s[a]||{},s[a][o]=lr(e),wt(t)&&"unaggregated"===u.scaleDomain(t)&&(s[a].min=lr({field:a,aggregate:"min"}),s[a].max=lr({field:a,aggregate:"max"}))):(n=c,r=t,(i=e).bin?(n[lr(i,{})]=!0,n[lr(i,{binSuffix:"end"})]=!0,Ia(i,r)&&(n[lr(i,{binSuffix:"range"})]=!0)):n[lr(i)]=!0)}),ie(c).length+ie(s).length===0?null:new d(e,c,s)):null},d.makeFromTransform=function(e,t){for(var n={},r={},i=0,o=t.aggregate;i<o.length;i++){var a=(f=o[i]).op,u=f.field,s=f.as;a&&("count"===a?(r["*"]=r["*"]||{},r["*"].count=s||lr(f)):(r[u]=r[u]||{},r[u][a]=s||lr(f)))}for(var c=0,l=t.groupby||[];c<l.length;c++){var f;n[f=l[c]]=!0}return ie(n).length+ie(r).length===0?null:new d(e,n,r)},d.prototype.merge=function(e){ne(this.dimensions,e.dimensions)?function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];pn.debug.apply(pn,arguments)}("different dimensions, cannot merge"):(!function(e,t){for(var n in t)if(t.hasOwnProperty(n)){var r=t[n];for(var i in r)r.hasOwnProperty(i)&&(n in e?e[n][i]=r[i]:e[n]={op:r[i]})}}(this.measures,e.measures),e.remove())},d.prototype.addDimensions=function(e){var t=this;e.forEach(function(e){return t.dimensions[e]=!0})},d.prototype.dependentFields=function(){var t={};return ie(this.dimensions).forEach(function(e){return t[e]=!0}),ie(this.measures).forEach(function(e){return t[e]=!0}),t},d.prototype.producedFields=function(){var e=this,n={};return ie(this.measures).forEach(function(t){ie(e.measures[t]).forEach(function(e){n[e+"_"+t]=!0})}),n},d.prototype.assemble=function(){for(var e=[],t=[],n=[],r=0,i=ie(this.measures);r<i.length;r++)for(var o=i[r],a=0,u=ie(this.measures[o]);a<u.length;a++){var s=u[a];n.push(this.measures[o][s]),e.push(s),t.push(o)}return{type:"aggregate",groupby:ie(this.dimensions),ops:e,fields:t,as:n}},d}(Ra),hu=function(f){function e(e,t,n,r){var i=f.call(this,e)||this;i.model=t,i.name=n,i.data=r;for(var o=0,a=[Ve,Ye];o<a.length;o++){var u=a[o],s=t.facet[u];if(s){var c=s.bin,l=s.sort;i[u]=I({name:t.getName(u+"_domain"),fields:[lr(s)].concat(c?[lr(s,{binSuffix:"end"})]:[])},Qo(l)?{sortField:l}:S(l)?{sortIndexField:ja(s,u)}:{})}}return i.childModel=t.child,i}return h(e,f),Object.defineProperty(e.prototype,"fields",{get:function(){return(this.column&&this.column.fields||[]).concat(this.row&&this.row.fields||[])},enumerable:!0,configurable:!0}),e.prototype.getSource=function(){return this.name},e.prototype.getChildIndependentFieldsWithStep=function(){for(var e={},t=0,n=["x","y"];t<n.length;t++){var r=n[t],i=this.childModel.component.scales[r];if(i&&!i.merged){var o=i.get("type"),a=i.get("range");if(yi(o)&&Mo(a)){var u=Du(Iu(this.childModel,r));u?e[r]=u:hn("Unknown field for ${channel}.  Cannot calculate view size.")}}}return e},e.prototype.assembleRowColumnData=function(e,t,n){var r="row"===e?"y":"x",i=[],o=[],a=[];n[r]&&(t?(i.push("distinct_"+n[r]),o.push("max")):(i.push(n[r]),o.push("distinct")),a.push("distinct_"+n[r]));var u=this[e],s=u.sortField,c=u.sortIndexField;if(s){var l=s.op,f=s.field;i.push(f),o.push(l),a.push(lr(s))}else c&&(i.push(c),o.push("max"),a.push(c));return{name:this[e].name,source:t||this.data,transform:[I({type:"aggregate",groupby:this[e].fields},i.length?{fields:i,ops:o,as:a}:{})]}},e.prototype.assemble=function(){var e=[],t=null,n=this.getChildIndependentFieldsWithStep();if(this.column&&this.row&&(n.x||n.y)){t="cross_"+this.column.name+"_"+this.row.name;var r=[].concat(n.x?[n.x]:[],n.y?[n.y]:[]),i=r.map(function(){return"distinct"});e.push({name:t,source:this.data,transform:[{type:"aggregate",groupby:this.column.fields.concat(this.row.fields),fields:r,ops:i}]})}for(var o=0,a=[Ve,Ye];o<a.length;o++){var u=a[o];this[u]&&e.push(this.assembleRowColumnData(u,t,n))}return e},e}(Ra),mu=function(r){function a(e,t){var n=r.call(this,e)||this;return n.fieldDefs=t,n}return h(a,r),a.prototype.clone=function(){return new a(null,I({},this.fieldDefs))},a.make=function(e,i){var t=i.config,o=i.mark;if("filter"!==t.invalidValues)return null;var n=i.reduceFieldDef(function(e,t,n){var r=wt(n)&&i.getScaleComponent(n);r&&(!xi(r.get("type"))||t.aggregate||Vt(o)||(e[t.field]=t));return e},{});return ie(n).length?new a(e,n):null},Object.defineProperty(a.prototype,"filter",{get:function(){return this.fieldDefs},enumerable:!0,configurable:!0}),a.prototype.assemble=function(){var i=this,e=ie(this.filter).reduce(function(e,t){var n=i.fieldDefs[t],r=lr(n,{expr:"datum"});return null!==n&&(e.push(r+" !== null"),e.push("!isNaN("+r+")")),e},[]);return 0<e.length?{type:"filter",expr:e.join(" && ")}:null},a}(Ra);var gu=function(r){function g(e,t){var n=r.call(this,e)||this;return n._parse=t,n}return h(g,r),g.prototype.clone=function(){return new g(null,ue(this._parse))},g.makeExplicit=function(e,t,n){var r={},i=t.data;return i&&i.format&&i.format.parse&&(r=i.format.parse),this.makeWithAncestors(e,r,{},n)},g.makeImplicitFromFilterTransform=function(e,t,n){var r={};return function e(t,n){if(W(t))e(t.not,n);else if(q(t))for(var r=0,i=t.and;r<i.length;r++)e(i[r],n);else if(H(t))for(var o=0,a=t.or;o<a.length;o++)e(a[o],n);else n(t)}(t.filter,function(e){if(Ps(e)){var t=null;Is(e)?t=e.equal:js(e)?t=e.range[0]:Us(e)&&(t=(e.oneOf||e.in)[0]),t&&(gn(t)?r[e.field]="date":x(t)?r[e.field]="number":m(t)&&(r[e.field]="string")),e.timeUnit&&(r[e.field]="date")}}),0===ie(r).length?null:this.makeWithAncestors(e,{},r,n)},g.makeImplicitFromEncoding=function(e,t,n){var r={};return(Bu(t)||Yu(t))&&t.forEachFieldDef(function(e){Cr(e)?r[e.field]="date":Tr(e)?we(e.aggregate)||(r[e.field]="number"):1<ve(e.field)?e.field in r||(r[e.field]="flatten"):cr(e)&&Qo(e.sort)&&1<ve(e.sort.field)&&(e.sort.field in r||(r[e.sort.field]="flatten"))}),this.makeWithAncestors(e,{},r,n)},g.makeWithAncestors=function(e,t,n,r){for(var i=0,o=ie(n);i<o.length;i++){var a=o[i];void 0!==(c=r.getWithExplicit(a)).value&&(c.explicit||c.value===n[a]||"derived"===c.value||"flatten"===n[a]?delete n[a]:hn(en.differentParse(a,n[a],c.value)))}for(var u=0,s=ie(t);u<s.length;u++){var c;a=s[u];void 0!==(c=r.get(a))&&(c===t[a]?delete t[a]:hn(en.differentParse(a,t[a],c)))}var l=new Xa(t,n);r.copyAll(l);for(var f={},d=0,p=ie(l.combine());d<p.length;d++){var h=p[d],m=l.get(h);null!==m&&(f[h]=m)}return 0===ie(f).length||r.parseNothing?null:new g(e,f)},Object.defineProperty(g.prototype,"parse",{get:function(){return this._parse},enumerable:!0,configurable:!0}),g.prototype.merge=function(e){this._parse=I({},this._parse,e.parse),e.remove()},g.prototype.assembleFormatParse=function(){for(var e={},t=0,n=ie(this._parse);t<n.length;t++){var r=n[t],i=this._parse[r];1===ve(r)&&(e[r]=i)}return e},g.prototype.producedFields=function(){return f(ie(this._parse))},g.prototype.dependentFields=function(){return f(ie(this._parse))},g.prototype.assembleTransforms=function(t){var o=this;return void 0===t&&(t=!1),ie(this._parse).filter(function(e){return!t||1<ve(e)}).map(function(e){var t,n,r,i=(t=e,n=o._parse[e],r=pe(t),"number"===n?"toNumber("+r+")":"boolean"===n?"toBoolean("+r+")":"string"===n?"toString("+r+")":"date"===n?"toDate("+r+")":"flatten"===n?r:0===n.indexOf("date:")?"timeParse("+r+","+n.slice(5,n.length)+")":0===n.indexOf("utc:")?"utcParse("+r+","+n.slice(4,n.length)+")":(hn(en.unrecognizedParse(n)),null));return i?{type:"formula",expr:i,as:ge(e)}:null}).filter(function(e){return null!==e})},g}(Ra),vu=function(o){function e(e){var t=o.call(this,null)||this;if(vo(e=e||{name:"source"}))t._data={values:e.values};else if(go(e)){if(t._data={url:e.url},e.format||(e.format={}),!e.format||!e.format.type){var n=/(?:\.([^.]+))?$/.exec(e.url)[1];X(["json","csv","tsv","dsv","topojson"],n)||(n="json"),e.format.type=n}}else yo(e)&&(t._data={});if(e.name&&(t._name=e.name),e.format){var r=e.format,i=(r.parse,z(r,["parse"]));t._data.format=i}return t}return h(e,o),Object.defineProperty(e.prototype,"data",{get:function(){return this._data},enumerable:!0,configurable:!0}),e.prototype.hasName=function(){return!!this._name},Object.defineProperty(e.prototype,"dataName",{get:function(){return this._name},set:function(e){this._name=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"parent",{set:function(e){throw new Error("Source nodes have to be roots.")},enumerable:!0,configurable:!0}),e.prototype.remove=function(){throw new Error("Source nodes are roots and cannot be removed.")},e.prototype.hash=function(){return vo(this._data)?(this._hash||(this._hash=V(this._data)),this._hash):go(this._data)?V([this._data.url,this._data.format]):this._name},e.prototype.assemble=function(){return I({name:this._name},this._data,{transform:[]})},e}(Ra),yu=function(r){function i(e,t){var n=r.call(this,e)||this;return n.formula=t,n}return h(i,r),i.prototype.clone=function(){return new i(null,ue(this.formula))},i.makeFromEncoding=function(e,t){var n=t.reduceFieldDef(function(e,t){if(t.timeUnit){var n=lr(t);e[n]={as:n,timeUnit:t.timeUnit,field:t.field}}return e},{});return 0===ie(n).length?null:new i(e,n)},i.makeFromTransform=function(e,t){var n;return new i(e,((n={})[t.field]={as:t.as,timeUnit:t.timeUnit,field:t.field},n))},i.prototype.merge=function(e){this.formula=I({},this.formula,e.formula),e.remove()},i.prototype.producedFields=function(){var t={};return oe(this.formula).forEach(function(e){t[e.as]=!0}),t},i.prototype.dependentFields=function(){var t={};return oe(this.formula).forEach(function(e){t[e.field]=!0}),t},i.prototype.assemble=function(){return oe(this.formula).map(function(e){return{type:"formula",as:e.as,expr:Mn(e.timeUnit,e.field)}})},i}(Ra);function bu(r){return function e(t){if(!(t instanceof vu)){var n=t.parent;r(t)&&e(n)}}}function xu(e){var t=e.parent;if(e instanceof gu){if(t instanceof vu)return!1;if(1<t.numChildren())return!0;if(t instanceof gu)t.merge(e);else{if(re(t.producedFields(),e.dependentFields()))return!0;e.swapWithParent()}}return!0}function Su(e){return!(e instanceof La||0<e.numChildren()||e instanceof hu)&&(e.remove(),!0)}function Eu(e){var n={};return bu(function(e){if(e instanceof yu){var t=e.producedFields();ie(t).every(function(e){return!!n[e]})?e.remove():n=I({},n,t)}return!0})(e)}var wu=function(r){function p(e,t){var n=r.call(this,e)||this;return n._stack=t,n}return h(p,r),p.prototype.clone=function(){return new p(null,ue(this._stack))},p.makeFromTransform=function(e,t){var n,r=t.stack,i=t.groupby,o=t.as,a=t.offset,u=void 0===a?"zero":a,s=[],c=[];if(void 0!==t.sort)for(var l=0,f=t.sort;l<f.length;l++){var d=f[l];s.push(d.field),c.push(void 0===d.order?"ascending":d.order)}return new p(e,{stackField:r,groupby:i,offset:u,sort:{field:s,order:c},facetby:[],as:S(n=o)&&n.every(function(e){return m(e)})&&1<n.length?o:m(o)?[o,o+"_end"]:[t.stack+"_start",t.stack+"_end"]})},p.makeFromEncoding=function(e,t){var n,r=t.stack;if(!r)return null;r.groupbyChannel&&(n=t.fieldDef(r.groupbyChannel));var i,o=t.stack.stackBy.reduce(function(e,t){var n=lr(t.fieldDef);return n&&e.push(n),e},[]),a=t.encoding.order;i=S(a)||ar(a)?Ta(a):o.reduce(function(e,t){return e.field.push(t),e.order.push("descending"),e},{field:[],order:[]});var u=t.vgField(r.fieldChannel);return new p(e,{dimensionFieldDef:n,stackField:u,facetby:[],stackby:o,sort:i,offset:r.offset,impute:r.impute,as:[u+"_start",u+"_end"]})},Object.defineProperty(p.prototype,"stack",{get:function(){return this._stack},enumerable:!0,configurable:!0}),p.prototype.addDimensions=function(e){this._stack.facetby=this._stack.facetby.concat(e)},p.prototype.dependentFields=function(){var t={};t[this._stack.stackField]=!0,this.getGroupbyFields().forEach(function(e){return t[e]=!0}),this._stack.facetby.forEach(function(e){return t[e]=!0});var e=this._stack.sort.field;return S(e)?e.forEach(function(e){return t[e]=!0}):t[e]=!0,t},p.prototype.producedFields=function(){return this._stack.as.reduce(function(e,t){return e[t]=!0,e},{})},p.prototype.getGroupbyFields=function(){var e=this._stack,t=e.dimensionFieldDef,n=e.impute,r=e.groupby;return t?t.bin?n?[lr(t,{binSuffix:"mid"})]:[lr(t,{}),lr(t,{binSuffix:"end"})]:[lr(t)]:r||[]},p.prototype.assemble=function(){var e=[],t=this._stack,n=t.facetby,r=t.dimensionFieldDef,i=t.stackField,o=t.stackby,a=t.sort,u=t.offset,s=t.impute,c=t.as;if(s&&r){var l=r?lr(r,{binSuffix:"mid"}):void 0;r.bin&&e.push({type:"formula",expr:"("+lr(r,{expr:"datum"})+"+"+lr(r,{expr:"datum",binSuffix:"end"})+")/2",as:l}),e.push({type:"impute",field:i,groupby:o,key:l,method:"value",value:0})}return e.push({type:"stack",groupby:this.getGroupbyFields().concat(n),field:i,sort:a,as:c,offset:u}),e},p}(Ra),ku="scale_";function Nu(t){if(t instanceof hu)if(1!==t.numChildren()||t.children[0]instanceof La){!function e(t){if(t instanceof La&&t.type===bo&&1===t.numChildren()){var n=t.children[0];n instanceof hu||(n.swapWithParent(),e(t))}}(t.model.component.data.main),Z(t.children.map((i=t,function e(t){if(!(t instanceof hu)){var n=t.clone();if(n instanceof La){var r=ku+n.getSource();n.setSource(r),i.model.component.data.outputNodes[r]=n}else(n instanceof pu||n instanceof wu)&&n.addDimensions(i.fields);return Z(t.children.map(e)).forEach(function(e){return e.parent=n}),[n]}return Z(t.children.map(e))}))).forEach(function(e){return e.parent=t.model.component.data.main})}else{var e=t.children[0];(e instanceof pu||e instanceof wu)&&e.addDimensions(t.fields),e.swapWithParent(),Nu(t)}else t.children.forEach(Nu);var i}function Ou(e){e instanceof mu&&J(oe(e.filter),function(e){return null===e})&&e.remove(),e instanceof La&&!e.isRequired()&&e.remove(),e.children.forEach(Ou)}function _u(e){var n=[];return e.forEach(function e(t){0===t.numChildren()?n.push(t):t.children.forEach(e)}),n}function Tu(e){var h,m,g;Bu(e)?(m=(h=e).specifiedScales,g=h.component.scales,ie(g).forEach(function(e){var t,n,r,i,o=m[e],a=o?o.domain:void 0,u=(n=e,r=(t=h).getScaleComponent(n).get("type"),(i=function(e,t,n,r){if("unaggregated"===e){var i=Au(t,n),o=i.valid,a=i.reason;if(!o)return void hn(a)}else if(void 0===e&&r.useUnaggregatedDomain){var o=Au(t,n).valid;if(o)return"unaggregated"}return e}(t.scaleDomain(n),t.fieldDef(n),r,t.config.scale))!==t.scaleDomain(n)&&(t.specifiedScales[n]=I({},t.specifiedScales[n],{domain:i})),"x"===n&&t.channelHasField("x2")?t.channelHasField("x")?Cu(r,i,t,"x").concat(Cu(r,i,t,"x2")):Cu(r,i,t,"x2"):"y"===n&&t.channelHasField("y2")?t.channelHasField("y")?Cu(r,i,t,"y").concat(Cu(r,i,t,"y2")):Cu(r,i,t,"y2"):Cu(r,i,t,n)),s=g[e];if(s.domains=u,ki(a)&&s.set("domainRaw",{signal:Es+V(a)},!0),h.component.data.isFaceted){for(var c=h;!Yu(c)&&c.parent;)c=c.parent;var l=c.component.resolve.scale[e];if("shared"===l)for(var f=0,d=u;f<d.length;f++){var p=d[f];Ho(p)&&(p.data=ku+p.data.replace(ku,""))}}})):function(s){for(var e=0,t=s.children;e<t.length;e++){var n=t[e];Tu(n)}var c=s.component.scales;ie(c).forEach(function(e){for(var t,n=null,r=0,i=s.children;r<i.length;r++){var o=i[r],a=o.component.scales[e];if(a){t=void 0===t?a.domains:t.concat(a.domains);var u=a.get("domainRaw");n&&u&&n.signal!==u.signal&&hn("The same selection must be used to override scale domains in a layered view."),n=u}}c[e].domains=t,n&&c[e].set("domainRaw",n,!0)})}(e)}function Cu(e,t,n,r){var i,o,a=n.fieldDef(r);if(t&&"unaggregated"!==t&&!ki(t)){var u=a.type,s=a.timeUnit;return"temporal"===u||s?(i=u,o=s,t.map(function(e){return{signal:"{data: "+Ar(e,{timeUnit:o,type:i})+"}"}})):[t]}var c=n.stack;if(c&&r===c.fieldChannel)return"normalize"===c.offset?[[0,1]]:[{data:f=n.requestDataName(bo),field:n.vgField(r,{suffix:"start"})},{data:f,field:n.vgField(r,{suffix:"end"})}];var l=wt(r)?function(e,t,n){if(!yi(n))return;var r=e.fieldDef(t),i=r.sort;if(Ko(i))return{op:"min",field:ja(r,t),order:"ascending"};if(Qo(i))return I({},i,i.field?{field:me(i.field)}:{});if("descending"===i)return{op:"min",field:e.vgField(t),order:"descending"};if(X(["ascending",void 0],i))return!0;return}(n,r,e):void 0;if("unaggregated"===t){var f=n.requestDataName(bo),d=a.field;return[{data:f,field:lr({field:d,aggregate:"min"})},{data:f,field:lr({field:d,aggregate:"max"})}]}if(!a.bin)return l?[{data:se(l)?n.requestDataName(bo):n.requestDataName(xo),field:n.vgField(r),sort:l}]:[{data:n.requestDataName(bo),field:n.vgField(r)}];if(bi(e)){var p=n.getName(Tt(a.bin)+"_"+a.field+"_bins");return[{signal:"sequence("+p+".start, "+p+".stop + "+p+".step, "+p+".step)"}]}return yi(e)?[{data:se(l)?n.requestDataName(bo):n.requestDataName(xo),field:n.vgField(r,Ia(a,r)?{binSuffix:"range"}:{}),sort:!0!==l&&Qo(l)?l:{field:n.vgField(r,{}),op:"min"}}]:"x"!==r&&"y"!==r?[{data:n.requestDataName(bo),field:n.vgField(r,{})}]:Ct(a.bin)&&a.bin.extent?[a.bin.extent]:[{data:f=n.requestDataName(bo),field:n.vgField(r,{})},{data:f,field:n.vgField(r,{binSuffix:"end"})}]}function Au(e,t){return e.aggregate?Oe[e.aggregate]?"quantitative"===e.type&&"log"===t?{valid:!1,reason:en.unaggregatedDomainWithLogScale(e)}:{valid:!0}:{valid:!1,reason:en.unaggregateDomainWithNonSharedDomainOp(e.aggregate)}:{valid:!1,reason:en.unaggregateDomainHasNoEffectForRawField(e)}}function Du(e){if(Ho(e)&&m(e.field))return e.field;if(!S(a=e)&&"fields"in a&&!("data"in a)){for(var t=void 0,n=0,r=e.fields;n<r.length;n++){var i=r[n];if(Ho(i)&&m(i.field))if(t){if(t!==i.field)return hn("Detected faceted independent scales that union domain of multiple fields from different data sources.  We will use the first field.  The result view size may be incorrect."),t}else t=i.field}return hn("Detected faceted independent scales that union domain of identical fields from different source detected.  We will assume that this is the same field from a different fork of the same data source.  However, if this is not case, the result view size maybe incorrect."),t}var o,a;return!S(o=e)&&"fields"in o&&"data"in o?(hn("Detected faceted independent scales that union domain of multiple fields from the same data source.  We will use the first field.  The result view size may be incorrect."),m(t=e.fields[0])?t:void 0):void 0}function Iu(t,e){return function(e){var t=te(e.map(function(e){return Ho(e)?(e.sort,z(e,["sort"])):e}),V),n=te(e.map(function(e){if(Ho(e)){var t=e.sort;return void 0===t||se(t)||("count"===t.op&&delete t.field,"ascending"===t.order&&delete t.order),t}}).filter(function(e){return void 0!==e}),V);if(1===t.length){if(Ho(a=e[0])&&0<n.length){var r=n[0];return 1<n.length&&(hn(en.MORE_THAN_ONE_SORT),r=!0),I({},a,{sort:r})}return a}var i=te(n.map(function(e){return!0===e?e:"count"===e.op?e:(hn(en.domainSortDropped(e)),!0)}),V),o=void 0;1===i.length?o=i[0]:1<i.length&&(hn(en.MORE_THAN_ONE_SORT),o=!0);var a,u=te(e.map(function(e){return Ho(e)?e.data:null}),function(e){return e});return 1===u.length&&null!==u[0]?a=I({data:u[0],fields:t.map(function(e){return e.field})},o?{sort:o}:{}):I({fields:t},o?{sort:o}:{})}(t.component.scales[e].domains.map(function(e){return Ho(e)&&(e.data=t.lookupDataSource(e.data)),e}))}function zu(c){return ie(c.component.scales).reduce(function(e,t){var n=c.component.scales[t];if(n.merged)return e;var r=n.combine(),i=r.domainRaw,o=r.range,a=r.name,u=r.type,s=(r.domainRaw,r.range,z(r,["name","type","domainRaw","range"]));return o=function(e,t,n,r){if("x"===r||"y"===r){if(Mo(e))return{step:{signal:t+"_step"}};if(S(e)&&2===e.length){var i=e[0],o=e[1];if(0===i&&Po(o))return[0,{signal:n.getSizeName(o.signal)}];if(Po(i)&&0===o)return[{signal:n.getSizeName(i.signal)},0]}}return e}(o,a,c,t),i&&0<=i.signal.indexOf(Es)&&(i=function(e,t){var n=JSON.parse(t.signal.replace(Es,"")),r=ce(n.selection),i=e.component.selection&&e.component.selection[r];{if(!i)return i=e.getSelectionComponent(r,n.selection),n.encoding||n.field||(n.field=i.project[0].field,1<i.project.length&&hn('A "field" or "encoding" must be specified when using a selection as a scale domain. Using "field": '+N(n.field)+".")),{signal:Os(i.type).scaleDomain+"("+N(r+xs)+", "+N(n.encoding||null)+", "+N(n.field||null)+("global"===i.resolve?")":", "+N(i.resolve)+")")};hn('Use "bind": "scales" to setup a binding for scales and selections within the same view.')}return{signal:"null"}}(c,i)),e.push(I({name:a,type:u,domain:Iu(c,t)},i?{domainRaw:i}:{},{range:o},s)),e},[])}var Ru=function(r){function e(e,t){var n=r.call(this,{},{name:e})||this;return n.merged=!1,n.domains=[],n.setWithExplicit("type",t),n}return h(e,r),e}(Xa),Lu=["range","rangeStep","scheme"];function Fu(e){var f,d;Bu(e)?(d=(f=e).component.scales,Et.forEach(function(e){var t=d[e];if(t){var n=f.getScaleComponent(e),r=f.specifiedScales[e],i=f.fieldDef(e),o="x"===e?"width":"y"===e?"height":void 0,a=o?!!f.component.layoutSize.get(o):void 0,u=n.get("type"),s=X(["point","band"],u)||!!r.rangeStep;o&&f.fit&&!a&&s&&(hn(en.CANNOT_FIX_RANGE_STEP_WITH_FIT),a=!0);var c=function(e){var t=[],n=e.getScaleComponent("x"),r=n&&n.get("range");r&&Mo(r)&&x(r.step)&&t.push(r.step);var i=e.getScaleComponent("y"),o=i&&i.get("range");return o&&Mo(o)&&x(o.step)&&t.push(o.step),t}(f),l=function(e,t,n,r,i,o,a,u,s,c){for(var l=u||null===r.rangeStep,f=0,d=Lu;f<d.length;f++){var p=d[f];if(void 0!==r[p]){var h=Ci(t,p),m=Ai(e,p);if(h)if(m)hn(m);else switch(p){case"range":return Qa(r[p]);case"scheme":return Qa(ju(r[p]));case"rangeStep":var g=r[p];if(null!==g){if(!u)return Qa({step:g});hn(en.rangeStepDropped(e))}}else hn(en.scalePropertyNotWorkWithScaleType(t,p,e))}}return Ka(function(e,t,n,r,i,o,a,u,s){switch(e){case Ue:case Pe:if(X(["point","band"],t)&&!s)if(e===Ue&&"text"===o){if(r.scale.textXRangeStep)return{step:r.scale.textXRangeStep}}else if(r.scale.rangeStep)return{step:r.scale.rangeStep};return e===Pe&&xi(t)?[{signal:a},0]:[0,{signal:a}];case Qe:var c=function(e,t,n){if(t)return 0;switch(e){case"bar":case"tick":return n.scale.minBandSize;case"line":case"trail":case"rule":return n.scale.minStrokeWidth;case"text":return n.scale.minFontSize;case"point":case"square":case"circle":return n.scale.minSize}throw new Error(en.incompatibleChannel("size",e))}(o,i,r),l=function(e,t,n){var r=n.scale;switch(e){case"bar":case"tick":return void 0!==n.scale.maxBandSize?n.scale.maxBandSize:Uu(t,n.scale)-1;case"line":case"trail":case"rule":return n.scale.maxStrokeWidth;case"text":return n.scale.maxFontSize;case"point":case"square":case"circle":if(n.scale.maxSize)return n.scale.maxSize;var i=Uu(t,r);return(i-2)*(i-2)}throw new Error(en.incompatibleChannel("size",e))}(o,u,r);return[c,l];case Xe:return"symbol";case Ke:case Je:case Ze:return"ordinal"===t?"nominal"===n?"category":"ordinal":"rect"===o||"geoshape"===o?"heatmap":"ramp";case rt:return[r.scale.minOpacity,r.scale.maxOpacity]}throw new Error("Scale range undefined for channel "+e)}(e,t,n,i,o,a,s,c,l))}(e,u,i.type,r,f.config,t.get("zero"),f.mark,a,f.getName(o),c);t.setWithExplicit("range",l)}})):Mu(e,"range")}function ju(e){if(wi(e)){var t={scheme:e.name};return e.count&&(t.count=e.count),e.extent&&(t.extent=e.extent),t}return{scheme:e}}function Uu(e,t){return 0<e.length?Math.min.apply(null,e):t.rangeStep?t.rangeStep:21}function Pu(e,t){var f,d,p;Bu(e)?(d=t,p=(f=e).component.scales,ie(p).forEach(function(e){var t=f.specifiedScales[e],n=p[e],r=f.getScaleComponent(e),i=f.fieldDef(e),o=f.config,a=t[d],u=r.get("type"),s=Ci(u,d),c=Ai(e,d);if(void 0!==a&&(s?c&&hn(c):hn(en.scalePropertyNotWorkWithScaleType(u,d,e))),s&&void 0===c)if(void 0!==a)n.copyKeyFromObject(d,t);else{var l=function(e,t,n,r,i,o,a,u,s){var c=s.scale;switch(e){case"nice":return function(e,t,n){if(!n.bin&&!X([Kr.TIME,Kr.UTC],e))return X([Ue,Pe],t)}(r,t,n);case"padding":return function(e,t,n,r,i,o){if(X([Ue,Pe],e)){if(Si(t)){if(void 0!==n.continuousPadding)return n.continuousPadding;var a=i.type,u=i.orient;if("bar"===a&&!r.bin&&("vertical"===u&&"x"===e||"horizontal"===u&&"y"===e))return o.continuousBandSize}if(t===Kr.POINT)return n.pointPadding}}(t,r,c,n,u,s.bar);case"paddingInner":return function(e,t,n){if(void 0===e)return X([Ue,Pe],t)?n.bandPaddingInner:void 0}(i,t,c);case"paddingOuter":return function(e,t,n,r,i){if(void 0===e)return X([Ue,Pe],t)&&n===Kr.BAND?void 0!==i.bandPaddingOuter?i.bandPaddingOuter:r/2:void 0}(i,t,r,o,c);case"reverse":return function(e,t){if(xi(e)&&"descending"===t)return!0}(r,n.sort);case"zero":return function(e,t,n,r){if(n&&"unaggregated"!==n)return!1;if("size"===e&&"quantitative"===t.type)return!0;if(!t.bin&&X([Ue,Pe],e)){var i=r.orient,o=r.type;return!X(["bar","area","line","trail"],o)||!("horizontal"===i&&"y"===e||"vertical"===i&&"x"===e)}return!1}(t,n,a,u)}return c[e]}(d,e,i,r.get("type"),r.get("padding"),r.get("paddingInner"),t.domain,f.markDef,o);void 0!==l&&n.set(d,l,!1)}})):Mu(e,t)}function Mu(o,a){for(var u=o.component.scales,e=0,t=o.children;e<t.length;e++){var n=t[e];"range"===a?Fu(n):Pu(n,a)}ie(u).forEach(function(e){for(var t,n=0,r=o.children;n<r.length;n++){var i=r[n].component.scales[e];if(i)t=$a(t,i.getWithExplicit(a),a,"scale",Ja(function(e,t){switch(a){case"range":return e.step&&t.step?e.step-t.step:0}return 0}))}u[e].setWithExplicit(a,t)})}function Hu(e,t,n,r,i){var o=function(e,t,n,r){switch(t.type){case"nominal":case"ordinal":if(ct(e)||"discrete"===Ot(e))return"shape"===e&&"ordinal"===t.type&&hn(en.discreteChannelCannotEncode(e,"ordinal")),"ordinal";if(X(["x","y"],e)){if(X(["rect","bar","rule"],n))return"band";if("bar"===n)return"band"}return"point";case"temporal":return ct(e)?"sequential":"discrete"===Ot(e)?(hn(en.discreteChannelCannotEncode(e,"temporal")),"ordinal"):"time";case"quantitative":return ct(e)?t.bin?"bin-ordinal":"sequential":"discrete"===Ot(e)?(hn(en.discreteChannelCannotEncode(e,"quantitative")),"ordinal"):t.bin&&"x"!==e&&"y"!==e?"bin-linear":"linear";case"latitude":case"longitude":case"geojson":return}throw new Error(en.invalidFieldType(t.type))}(t,n,r);return wt(t)?void 0!==e?Ii(t,e)?Di(e,n.type,n.bin)?e:(hn(en.scaleTypeNotWorkWithFieldDef(e,o)),o):(hn(en.scaleTypeNotWorkWithChannel(t,e,o)),o):o:null}function qu(e){var u,s,c,l;Bu(e)?e.component.scales=(s=(u=e).encoding,c=u.config,l=u.mark,Et.reduce(function(e,t){var n,r=void 0,i=s[t];if(ar(i)&&l===Wt&&t===Xe&&i.type===Jn)return e;if(ar(i)?r=(n=i).scale:ir(i)?(n=i.condition,r=i.condition.scale):t===Ue?n=Er(s.x2):t===Pe&&(n=Er(s.y2)),n&&null!==r&&!1!==r){var o=(r=r||{}).type,a=Hu(r.type,t,n,l,c.scale);e[t]=new Ru(u.scaleName(t+"",!0),{value:a,explicit:o===a})}return e},{})):e.component.scales=function(u){for(var s=u.component.scales={},c={},i=u.component.resolve,e=function(r){qu(r),ie(r.component.scales).forEach(function(e){if(i.scale[e]=i.scale[e]||function(e,t){if(Qu(t)||Yu(t))return"shared";if(Xu(t)||Vu(t))return X(yt,e)?"independent":"shared";throw new Error("invalid model type for resolve")}(e,u),"shared"===i.scale[e]){var t=c[e],n=r.component.scales[e].getWithExplicit("type");t?si(t.value,n.value)?c[e]=$a(t,n,"type","scale",Wu):(i.scale[e]="independent",delete c[e]):c[e]=n}})},t=0,n=u.children;t<n.length;t++){var r=n[t];e(r)}return ie(c).forEach(function(e){var t=u.scaleName(e,!0),n=c[e];s[e]=new Ru(t,n);for(var r=0,i=u.children;r<i.length;r++){var o=i[r],a=o.component.scales[e];a&&(o.renameScale(a.get("name"),t),a.merged=!0)}}),s}(e)}var Wu=Ja(function(e,t){return li(e)-li(t)});var Gu=function(){function e(){this.nameMap={}}return e.prototype.rename=function(e,t){this.nameMap[e]=t},e.prototype.has=function(e){return void 0!==this.nameMap[e]},e.prototype.get=function(e){for(;this.nameMap[e]&&e!==this.nameMap[e];)e=this.nameMap[e];return e},e}();function Bu(e){return e&&"unit"===e.type}function Yu(e){return e&&"facet"===e.type}function Vu(e){return e&&"repeat"===e.type}function Xu(e){return e&&"concat"===e.type}function Qu(e){return e&&"layer"===e.type}var Ku=function(){function e(e,t,n,r,i,o){var a,u,s,c,l,f,d,p,h=this;this.children=[],this.correctDataNames=function(e){return e.from&&e.from.data&&(e.from.data=h.lookupDataSource(e.from.data)),e.from&&e.from.facet&&e.from.facet.data&&(e.from.facet.data=h.lookupDataSource(e.from.facet.data)),e},this.parent=t,this.config=r,this.repeater=i,this.name=e.name||n,this.title=m(e.title)?{text:e.title}:e.title,this.scaleNameMap=t?t.scaleNameMap:new Gu,this.projectionNameMap=t?t.projectionNameMap:new Gu,this.layoutSizeNameMap=t?t.layoutSizeNameMap:new Gu,this.data=e.data,this.description=e.description,this.transforms=Zs(e.transform||[]),this.layout=$i(e)||eo(e)?void 0:(u=(a=e||{}).align,s=void 0===u?void 0:u,c=a.center,l=void 0===c?void 0:c,f=a.bounds,d=void 0===f?void 0:f,p=a.spacing,{align:s,bounds:d,center:l,spacing:void 0===p?void 0:p}),this.component={data:{sources:t?t.component.data.sources:{},outputNodes:t?t.component.data.outputNodes:{},outputNodeRefCounts:t?t.component.data.outputNodeRefCounts:{},isFaceted:Zi(e)||t&&t.component.data.isFaceted&&!e.data},layoutSize:new Xa,layoutHeaders:{row:{},column:{}},mark:null,resolve:I({scale:{},axis:{},legend:{}},o||{}),selection:null,scales:null,projection:null,axes:{},legends:{}}}return Object.defineProperty(e.prototype,"width",{get:function(){return this.getSizeSignalRef("width")},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"height",{get:function(){return this.getSizeSignalRef("height")},enumerable:!0,configurable:!0}),e.prototype.initSize=function(e){var t=e.width,n=e.height;t&&this.component.layoutSize.set("width",t,!0),n&&this.component.layoutSize.set("height",n,!0)},e.prototype.parse=function(){this.parseScale(),this.parseLayoutSize(),this.renameTopLevelLayoutSize(),this.parseSelection(),this.parseProjection(),this.parseData(),this.parseAxisAndHeader(),this.parseLegend(),this.parseMarkGroup()},e.prototype.parseScale=function(){!function(e){qu(e),Tu(e);for(var t=0,n=_i;t<n.length;t++)Pu(e,n[t]);Fu(e)}(this)},e.prototype.parseProjection=function(){du(this)},e.prototype.renameTopLevelLayoutSize=function(){"width"!==this.getName("width")&&this.renameLayoutSize(this.getName("width"),"width"),"height"!==this.getName("height")&&this.renameLayoutSize(this.getName("height"),"height")},e.prototype.parseLegend=function(){ou(this)},e.prototype.assembleGroupStyle=function(){if("unit"===this.type||"layer"===this.type)return"cell"},e.prototype.assembleLayoutSize=function(){if("unit"===this.type||"layer"===this.type)return{width:this.getSizeSignalRef("width"),height:this.getSizeSignalRef("height")}},e.prototype.assembleLayout=function(){if(this.layout){var e=this.layout,t=e.align,n=e.bounds,r=e.center,i=e.spacing,o=void 0===i?{}:i;return I({padding:x(o)?o:{row:o.row||10,column:o.column||10}},this.assembleDefaultLayout(),t?{align:t}:{},n?{bounds:n}:{},r?{center:r}:{})}},e.prototype.assembleDefaultLayout=function(){return{}},e.prototype.assembleHeaderMarks=function(){for(var e,t,n,r,i,o,a=this.component.layoutHeaders,u=[],s=0,c=Ua;s<c.length;s++){a[d=c[s]].title&&u.push((t=d,void 0,n=(e=this).component.layoutHeaders[t].title,r="row"===t?"left":void 0,i=e.config?e.config:void 0,o=e.component.layoutHeaders[t].facetFieldDef?e.component.layoutHeaders[t].facetFieldDef:void 0,{name:t+"-title",type:"group",role:t+"-title",title:I({text:n,offset:10,orient:r,style:"guide-title"},qa(i,o,Yo,Go))}))}for(var l=0,f=Ua;l<f.length;l++){var d=f[l];u=u.concat(Ma(this,d))}return u},e.prototype.assembleAxes=function(){return e=this.component.axes,t=this.config,n=e.x,r=void 0===n?[]:n,i=e.y,o=void 0===i?[]:i,r.map(function(e){return Wo(e,"main",t)}).concat(r.map(function(e){return Wo(e,"grid",t)}),o.map(function(e){return Wo(e,"main",t)}),o.map(function(e){return Wo(e,"grid",t)})).filter(function(e){return e});var e,t,n,r,i,o},e.prototype.assembleLegends=function(){return uu(this)},e.prototype.assembleProjections=function(){return su(this)},e.prototype.assembleTitle=function(){var e=I({},Fi(this.config.title).nonMark,this.title);if(e.text)return X(["unit","layer"],this.type)||(e.anchor&&"start"!==e.anchor&&hn(en.cannotSetTitleAnchor(this.type)),e.anchor="start"),0<ie(e).length?e:void 0},e.prototype.assembleGroup=function(e){void 0===e&&(e=[]);var t={};0<(e=e.concat(this.assembleSelectionSignals())).length&&(t.signals=e);var n=this.assembleLayout();n&&(t.layout=n),t.marks=[].concat(this.assembleHeaderMarks(),this.assembleMarks());var r=!this.parent||Yu(this.parent)?function n(e){return Qu(e)||Xu(e)||Vu(e)?e.children.reduce(function(e,t){return e.concat(n(t))},zu(e)):zu(e)}(this):[];0<r.length&&(t.scales=r);var i=this.assembleAxes();0<i.length&&(t.axes=i);var o=this.assembleLegends();return 0<o.length&&(t.legends=o),t},e.prototype.hasDescendantWithFieldOnChannel=function(e){for(var t=0,n=this.children;t<n.length;t++){var r=n[t];if(Bu(r)){if(r.channelHasField(e))return!0}else if(r.hasDescendantWithFieldOnChannel(e))return!0}return!1},e.prototype.getName=function(e){return ce((this.name?this.name+"_":"")+e)},e.prototype.requestDataName=function(e){var t=this.getName(e),n=this.component.data.outputNodeRefCounts;return n[t]=(n[t]||0)+1,t},e.prototype.getSizeSignalRef=function(e){if(Yu(this.parent)){var t="width"===e?"x":"y",n=this.component.scales[t];if(n&&!n.merged){var r=n.get("type"),i=n.get("range");if(yi(r)&&Mo(i)){var o=n.get("name"),a=Du(Iu(this,t));return a?{signal:Ya(o,n,lr({aggregate:"distinct",field:a},{expr:"datum"}))}:(hn("Unknown field for ${channel}.  Cannot calculate view size."),null)}}}return{signal:this.layoutSizeNameMap.get(this.getName(e))}},e.prototype.lookupDataSource=function(e){var t=this.component.data.outputNodes[e];return t?t.getSource():e},e.prototype.getSizeName=function(e){return this.layoutSizeNameMap.get(e)},e.prototype.renameLayoutSize=function(e,t){this.layoutSizeNameMap.rename(e,t)},e.prototype.renameScale=function(e,t){this.scaleNameMap.rename(e,t)},e.prototype.renameProjection=function(e,t){this.projectionNameMap.rename(e,t)},e.prototype.scaleName=function(e,t){return t?this.getName(e):pt(e)&&wt(e)&&this.component.scales[e]||this.scaleNameMap.has(this.getName(e))?this.scaleNameMap.get(this.getName(e)):void 0},e.prototype.projectionName=function(e){return e?this.getName("projection"):this.component.projection&&!this.component.projection.merged||this.projectionNameMap.has(this.getName("projection"))?this.projectionNameMap.get(this.getName("projection")):void 0},e.prototype.getScaleComponent=function(e){if(!this.component.scales)throw new Error("getScaleComponent cannot be called before parseScale().  Make sure you have called parseScale or use parseUnitModelWithScale().");var t=this.component.scales[e];return t&&!t.merged?t:this.parent?this.parent.getScaleComponent(e):void 0},e.prototype.getSelectionComponent=function(e,t){var n=this.component.selection[e];if(!n&&this.parent&&(n=this.parent.getSelectionComponent(e,t)),!n)throw new Error(en.selectionNotFound(t));return n},e}(),Ju=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return h(t,e),t.prototype.vgField=function(e,t){void 0===t&&(t={});var n=this.fieldDef(e);if(n)return lr(n,t)},t.prototype.reduceFieldDef=function(i,e,t){return Pr(this.getMapping(),function(e,t,n){var r=Er(t);return r?i(e,r,n):e},e,t)},t.prototype.forEachFieldDef=function(r,e){Ur(this.getMapping(),function(e,t){var n=Er(e);n&&r(n,t)},e)},t}(Ku),Zu={has:function(e){return"interval"===e.type&&"global"===e.resolve&&e.bind&&"scales"===e.bind},parse:function(i,e,o){var a=o.scales=[];o.project.forEach(function(e){var t=e.channel,n=i.getScaleComponent(t),r=n?n.get("type"):void 0;n&&xi(r)&&!bi(r)?(n.set("domainRaw",{signal:As(o,t,"data")},!0),a.push(t),i.repeater&&i.repeater.row===i.repeater.column&&i.getScaleComponent(t===Ue?Pe:Ue).set("domainRaw",{signal:As(o,t,"data")},!0)):hn(en.SCALE_BINDINGS_CONTINUOUS)})},topLevelSignals:function(e,n,r){if(!e.parent)return r;var t=n.scales.filter(function(t){return!r.filter(function(e){return e.name===As(n,t,"data")}).length});return r.concat(t.map(function(e){return{name:As(n,e,"data")}}))},signals:function(e,n,r){return e.parent&&n.scales.forEach(function(t){var e=r.filter(function(e){return e.name===As(n,t,"data")})[0];e.push="outer",delete e.value,delete e.update}),r}};function $u(e,t){return"domain("+N(e.scaleName(t))+")"}var es="_brush",ts="_scale_trigger",ns={predicate:"vlInterval",scaleDomain:"vlIntervalDomain",signals:function(b,x){var e=x.name,t=Zu.has(x),S=[],E=[],w=[],k=[];if(x.translate&&!t){var r="!event.item || event.item.mark.name !== "+N(e+es);rs(x,function(e,t){var n=t.between[0].filter||(t.between[0].filter=[]);n.indexOf(r)<0&&n.push(r)})}return x.project.forEach(function(e){var t=e.channel;if(t===Ue||t===Pe){var n,r,i,o,a,u,s,c,l,f,d,p,h=(n=b,o=As(r=x,i=t,"visual"),a=As(r,i,"data"),u=Zu.has(r),s=N(n.scaleName(i)),c=n.getScaleComponent(i),l=c?c.get("type"):void 0,f=n.getSizeSignalRef(i===Ue?"width":"height").signal,d=i+"(unit)",(p=rs(r,function(e,t){return e.concat({events:t.between[0],update:"["+d+", "+d+"]"},{events:t,update:"["+o+"[0], clamp("+d+", 0, "+f+")]"})})).push({events:{signal:r.name+ts},update:xi(l)&&!bi(l)?"[scale("+s+", "+a+"[0]), scale("+s+", "+a+"[1])]":"[0, 0]"}),u?[{name:a,on:[]}]:[{name:o,value:[],on:p},{name:a,on:[{events:{signal:o},update:o+"[0] === "+o+"[1] ? null : invert("+s+", "+o+")"}]}]),m=As(x,t,"data"),g=As(x,t,"visual"),v=N(b.scaleName(t)),y=xi(b.getScaleComponent(t).get("type"))?"+":"";S.push.apply(S,h),w.push(m),E.push("{encoding: "+N(t)+", field: "+N(e.field)+", extent: "+m+"}"),k.push({scaleName:b.scaleName(t),expr:"(!isArray("+m+") || ("+y+"invert("+v+", "+g+")[0] === "+y+m+"[0] && "+y+"invert("+v+", "+g+")[1] === "+y+m+"[1]))"})}else hn("Interval selections only support x and y encoding channels.")}),t||S.push({name:e+ts,update:k.map(function(e){return e.expr}).join(" && ")+" ? "+(e+ts)+" : {}"}),S.concat({name:e+Ss,on:[{events:w.map(function(e){return{signal:e}}),update:w.join(" && ")+" ? {unit: "+Ts(b)+", intervals: ["+E.join(", ")+"]} : null"}]})},modifyExpr:function(e,t){return t.name+Ss+", "+("global"===t.resolve?"true":"{unit: "+Ts(e)+"}")},marks:function(e,t,n){var r=t.name,i=Ds(t),o=i.xi,a=i.yi,u="data("+N(t.name+xs)+")";if(Zu.has(t))return n;var s={x:null!==o?{signal:r+"_x[0]"}:{value:0},y:null!==a?{signal:r+"_y[0]"}:{value:0},x2:null!==o?{signal:r+"_x[1]"}:{field:{group:"width"}},y2:null!==a?{signal:r+"_y[1]"}:{field:{group:"height"}}};if("global"===t.resolve)for(var c=0,l=ie(s);c<l.length;c++){var f=l[c];s[f]=[I({test:u+".length && "+u+"[0].unit === "+Ts(e)},s[f]),{value:0}]}var d=t.mark,p=d.fill,h=d.fillOpacity,m=z(d,["fill","fillOpacity"]),g=ie(m).reduce(function(e,t){return e[t]=[{test:[null!==o&&r+"_x[0] !== "+r+"_x[1]",null!=a&&r+"_y[0] !== "+r+"_y[1]"].filter(function(e){return e}).join(" && "),value:m[t]},{value:null}],e},{});return[{name:r+es+"_bg",type:"rect",clip:!0,encode:{enter:{fill:{value:p},fillOpacity:{value:h}},update:s}}].concat(n,{name:r+es,type:"rect",clip:!0,encode:{enter:{fill:{value:"transparent"}},update:I({},s,g)}})}};function rs(e,n){return e.events.reduce(function(e,t){return t.between?n(e,t):(hn(t+" is not an ordered event stream for interval selections"),e)},[])}var is="voronoi",os={has:function(e){return"interval"!==e.type&&e.nearest},marks:function(r,e,t){var n=Ds(e),i=n.x,o=n.y,a=r.mark;if(Vt(a))return hn(en.nearestNotSupportForContinuous(a)),t;var u={name:r.getName(is),type:"path",from:{data:r.getName("marks")},encode:{enter:{fill:{value:"transparent"},strokeWidth:{value:.35},stroke:{value:"transparent"},isVoronoi:{value:!0}}},transform:[{type:"voronoi",x:{expr:i||!i&&!o?"datum.datum.x || 0":"0"},y:{expr:o||!i&&!o?"datum.datum.y || 0":"0"},size:[r.getSizeSignalRef("width"),r.getSizeSignalRef("height")]}]},s=0,c=!1;return t.forEach(function(e,t){var n=e.name||"";n===r.component.mark[0].name?s=t:0<=n.indexOf(is)&&(c=!0)}),c||t.splice(s+1,0,u),t}};function as(r,e){var t=e.project,i=os.has(e)?"(item().isVoronoi ? datum.datum : datum)":"datum",o=[],n=t.map(function(e){return N(e.channel)}).filter(function(e){return e}).join(", "),a=t.map(function(e){return N(e.field)}).join(", "),u=t.map(function(e){var t=e.channel,n=r.fieldDef(t);return n&&n.bin?(o.push(e.field),"["+pe(r.vgField(t,{}),i)+", "+pe(r.vgField(t,{binSuffix:"end"}),i)+"]"):""+pe(e.field,i)}).join(", ");return[{name:e.name+Ss,value:{},on:[{events:e.events,update:"datum && item().mark.marktype !== 'group' ? {unit: "+Ts(r)+", encodings: ["+n+"], fields: ["+a+"], values: ["+u+"]"+(o.length?", "+o.map(function(e){return N("bin_"+e)+": 1"}).join(", "):"")+"} : null",force:!0}]}]}var us={predicate:"vlMulti",scaleDomain:"vlMultiDomain",signals:as,modifyExpr:function(e,t){return t.name+Ss+", "+("global"===t.resolve?"null":"{unit: "+Ts(e)+"}")}},ss={predicate:"vlSingle",scaleDomain:"vlSingleDomain",signals:as,topLevelSignals:function(e,t,n){var r=n.filter(function(e){return e.name===t.name}),i="data("+N(t.name+xs)+")",o=i+"[0].values";return r.length?n:n.concat({name:t.name,update:i+".length && {"+t.project.map(function(e,t){return e.field+": "+o+"["+t+"]"}).join(", ")+"}"})},modifyExpr:function(e,t){return t.name+Ss+", "+("global"===t.resolve?"true":"{unit: "+Ts(e)+"}")}},cs="_toggle",ls="_translate_anchor",fs="_translate_delta",ds={has:function(e){return"interval"===e.type&&e.translate},signals:function(e,t,n){var r=t.name,i=Zu.has(t),o=r+ls,a=Ds(t),u=a.x,s=a.y,c=Eo(t.translate,"scope");return i||(c=c.map(function(e){return e.between[0].markname=r+es,e})),n.push({name:o,value:{},on:[{events:c.map(function(e){return e.between[0]}),update:"{x: x(unit), y: y(unit)"+(null!==u?", extent_x: "+(i?$u(e,Ue):"slice("+As(t,"x","visual")+")"):"")+(null!==s?", extent_y: "+(i?$u(e,Pe):"slice("+As(t,"y","visual")+")"):"")+"}"}]},{name:r+fs,value:{},on:[{events:c,update:"{x: "+o+".x - x(unit), y: "+o+".y - y(unit)}"}]}),null!==u&&ps(e,t,Ue,"width",n),null!==s&&ps(e,t,Pe,"height",n),n}};function ps(e,t,n,r,i){var o=t.name,a=Zu.has(t),u=i.filter(function(e){return e.name===As(t,n,a?"data":"visual")})[0],s=o+ls,c=o+fs,l=e.getSizeSignalRef(r).signal,f=e.getScaleComponent(n),d=f.get("type"),p=s+".extent_"+n,h=(a?"log"===d?"panLog":"pow"===d?"panPow":"panLinear":"panLinear")+"("+p+", "+(""+(a&&n===Ue?"-":"")+c+"."+n+" / "+(a?""+l:"span("+p+")"))+(a&&"pow"===d?", "+(f.get("exponent")||1):"")+")";u.on.push({events:{signal:c},update:a?h:"clampRange("+h+", 0, "+l+")"})}var hs="_zoom_anchor",ms="_zoom_delta",gs={has:function(e){return"interval"===e.type&&e.zoom},signals:function(e,t,n){var r=t.name,i=Zu.has(t),o=r+ms,a=Ds(t),u=a.x,s=a.y,c=N(e.scaleName(Ue)),l=N(e.scaleName(Pe)),f=Eo(t.zoom,"scope");return i||(f=f.map(function(e){return e.markname=r+es,e})),n.push({name:r+hs,on:[{events:f,update:i?"{"+[c?"x: invert("+c+", x(unit))":"",l?"y: invert("+l+", y(unit))":""].filter(function(e){return!!e}).join(", ")+"}":"{x: x(unit), y: y(unit)}"}]},{name:o,on:[{events:f,force:!0,update:"pow(1.001, event.deltaY * pow(16, event.deltaMode))"}]}),null!==u&&vs(e,t,"x","width",n),null!==s&&vs(e,t,"y","height",n),n}};function vs(e,t,n,r,i){var o=t.name,a=Zu.has(t),u=i.filter(function(e){return e.name===As(t,n,a?"data":"visual")})[0],s=e.getSizeSignalRef(r).signal,c=e.getScaleComponent(n),l=c.get("type"),f=a?$u(e,n):u.name,d=o+ms,p=(a?"log"===l?"zoomLog":"pow"===l?"zoomPow":"zoomLinear":"zoomLinear")+"("+f+", "+(""+o+hs+"."+n)+", "+d+(a&&"pow"===l?", "+(c.get("exponent")||1):"")+")";u.on.push({events:{signal:d},update:a?p:"clampRange("+p+", 0, "+s+")"})}var ys={project:{has:function(e){var t=e;return void 0!==t.fields||void 0!==t.encodings},parse:function(r,e,t){var i={},o={};(e.fields||[]).forEach(function(e){return i[e]=null}),(e.encodings||[]).forEach(function(e){var t=r.fieldDef(e);if(t)if(t.timeUnit){var n=r.vgField(e);i[n]=e,o[n]={as:n,field:t.field,timeUnit:t.timeUnit}}else i[t.field]=e;else hn(en.cannotProjectOnChannelWithoutField(e))});var n=t.project||(t.project=[]);for(var a in i)i.hasOwnProperty(a)&&n.push({field:a,channel:i[a]});var u=t.fields||(t.fields={});n.filter(function(e){return e.channel}).forEach(function(e){return u[e.channel]=e.field}),ie(o).length&&(t.timeUnit=new yu(null,o))}},toggle:{has:function(e){return"multi"===e.type&&e.toggle},signals:function(e,t,n){return n.concat({name:t.name+cs,value:!1,on:[{events:t.events,update:t.toggle}]})},modifyExpr:function(e,t,n){var r=t.name+Ss,i=t.name+cs;return i+" ? null : "+r+", "+("global"===t.resolve?i+" ? null : true, ":i+" ? null : {unit: "+Ts(e)+"}, ")+i+" ? "+r+" : null"}},scales:Zu,translate:ds,zoom:gs,inputs:{has:function(e){return"single"===e.type&&"global"===e.resolve&&e.bind&&"scales"!==e.bind},topLevelSignals:function(e,n,r){var i=n.name,t=n.project,o=n.bind,a=os.has(n)?"(item().isVoronoi ? datum.datum : datum)":"datum";return t.forEach(function(e){var t=ce(i+"_"+e.field);r.filter(function(e){return e.name===t}).length||r.unshift({name:t,value:"",on:[{events:n.events,update:"datum && item().mark.marktype !== 'group' ? "+pe(e.field,a)+" : null"}],bind:o[e.field]||o[e.channel]||o})}),r},signals:function(e,t,n){var r=t.name,i=t.project,o=n.filter(function(e){return e.name===r+Ss})[0],a=i.map(function(e){return N(e.field)}).join(", "),u=i.map(function(e){return ce(r+"_"+e.field)});return u.length&&(o.update=u.join(" && ")+" ? {fields: ["+a+"], values: ["+u.join(", ")+"]} : null"),delete o.value,delete o.on,n}},nearest:os};function bs(e,t){for(var n in ys)ys[n].has(e)&&t(ys[n])}var xs="_store",Ss="_tuple",Es="_selection_domain_";function ws(n,r){return Ns(n,function(t,e){r=e.marks?e.marks(n,t,r):r,bs(t,function(e){e.marks&&(r=e.marks(n,t,r))})}),r}function ks(a,e,u){var s=[];var t=le(e,function(e){var t=ce(e),n=a.getSelectionComponent(t,e),r=N(t+xs);if(n.timeUnit){var i=u||a.component.data.raw,o=n.timeUnit.clone();i.parent?o.insertAsParentOf(i):i.parent=o}return"none"!==n.empty&&s.push(r),Os(n.type).predicate+"("+r+", datum"+("global"===n.resolve?")":", "+N(n.resolve)+")")});return(s.length?"!("+s.map(function(e){return"length(data("+e+"))"}).join(" || ")+") || ":"")+"("+t+")"}function Ns(e,t){var n=e.component.selection;for(var r in n)if(n.hasOwnProperty(r)){var i=n[r];t(i,Os(i.type))}}function Os(e){switch(e){case"single":return ss;case"multi":return us;case"interval":return ns}return null}function _s(e){for(var t=e.parent;t&&!Yu(t);)t=t.parent;return t}function Ts(e){var t=N(e.name),n=_s(e);return n&&(t+=(n.facet.row?" + '_' + ("+pe(n.vgField("row"),"facet")+")":"")+(n.facet.column?" + '_' + ("+pe(n.vgField("column"),"facet")+")":"")),t}function Cs(e){var t=!1;return Ns(e,function(e){t=t||e.project.some(function(e){return e.field===Li})}),t}function As(e,t,n){var r=e._signalNames||(e._signalNames={});if(r[t]&&r[t][n])return r[t][n];r[t]=r[t]||{};for(var i=ce(e.name+"_"+("visual"===n?t:e.fields[t])),o=i,a=1;r[o];)o=i+"_"+a++;return r[o]=r[t][n]=o}function Ds(e){var n=null,r=null,i=null,o=null;return e.project.forEach(function(e,t){e.channel===Ue?(n=e,r=t):e.channel===Pe&&(i=e,o=t)}),{x:n,xi:r,y:i,yi:o}}function Is(e){return e&&!!e.field&&void 0!==e.equal}function zs(e){return e&&!!e.field&&void 0!==e.lt}function Rs(e){return e&&!!e.field&&void 0!==e.lte}function Ls(e){return e&&!!e.field&&void 0!==e.gt}function Fs(e){return e&&!!e.field&&void 0!==e.gte}function js(e){return!!(e&&e.field&&S(e.range)&&2===e.range.length)}function Us(e){return e&&!!e.field&&(S(e.oneOf)||S(e.in))}function Ps(e){return Us(e)||Is(e)||js(e)||zs(e)||Ls(e)||Rs(e)||Fs(e)}function Ms(n,e,r){return le(e,function(e){return m(e)?e:(t=e)&&t.selection?ks(n,e.selection,r):qs(e);var t})}function Hs(e,t){return Ar(e,{timeUnit:t,time:!0})}function qs(e,t){void 0===t&&(t=!0);var n,r,i=e.field,o=e.timeUnit,a=o?"time("+Mn(o,i)+")":lr(e,{expr:"datum"});if(Is(e))return a+"==="+Hs(e.equal,o);if(zs(e))return a+"<"+Hs(c=e.lt,o);if(Ls(e))return a+">"+Hs(s=e.gt,o);if(Rs(e))return a+"<="+Hs(c=e.lte,o);if(Fs(e))return a+">="+Hs(s=e.gte,o);if(Us(e)){var u=e.oneOf;return u=u||e.in,"indexof(["+(n=u,r=o,n.map(function(e){return Hs(e,r)})).join(",")+"], "+a+") !== -1"}if(js(e)){var s=e.range[0],c=e.range[1];if(null!==s&&null!==c&&t)return"inrange("+a+", ["+Hs(s,o)+", "+Hs(c,o)+"])";var l=[];return null!==s&&l.push(a+" >= "+Hs(s,o)),null!==c&&l.push(a+" <= "+Hs(c,o)),0<l.length?l.join(" && "):"true"}throw new Error("Invalid field predicate: "+JSON.stringify(e))}function Ws(e){return Ps(e)&&e.timeUnit?I({},e,{timeUnit:qn(e.timeUnit)}):e}function Gs(e){return void 0!==e.filter}function Bs(e){return void 0!==e.lookup}function Ys(e){return void 0!==e.window}function Vs(e){return void 0!==e.calculate}function Xs(e){return!!e.bin}function Qs(e){return void 0!==e.timeUnit}function Ks(e){return void 0!==e.aggregate}function Js(e){return void 0!==e.stack}function Zs(e){return e.map(function(e){return Gs(e)?{filter:function t(e,n){return W(e)?{not:t(e.not,n)}:q(e)?{and:e.and.map(function(e){return t(e,n)})}:H(e)?{or:e.or.map(function(e){return t(e,n)})}:n(e)}(e.filter,Ws)}:e})}var $s=Object.freeze({isFilter:Gs,isLookup:Bs,isWindow:Ys,isCalculate:Vs,isBin:Xs,isTimeUnit:Qs,isAggregate:Ks,isStack:Js,normalizeTransform:Zs});function ec(e,t){var n;n="as"in e?m(e.as)?[e.as,e.as+"_end"]:[e.as[0],e.as[1]]:[lr(e,{}),lr(e,{binSuffix:"end"})];var r,i,o,a,u=Nr(e.bin,void 0)||{},s=(r=u,i=e.field,Tt(r)+"_"+i),c=(a=s,{signal:(o=t).getName(a+"_bins"),extentSignal:o.getName(a+"_extent")}),l=c.signal,f=c.extentSignal;return{key:s,binComponent:I({bin:u,field:e.field,as:n},l?{signal:l}:{},f?{extentSignal:f}:{})}}var tc=function(r){function u(e,t){var n=r.call(this,e)||this;return n.bins=t,n}return h(u,r),u.prototype.clone=function(){return new u(null,ue(this.bins))},u.makeFromEncoding=function(e,a){var t=a.reduceFieldDef(function(e,t,n){if(t.bin){var r=ec(t,a),i=r.key,o=r.binComponent;e[i]=I({},o,e[i],function(e,t,n,r){if(Ia(t,n)){var i=Bu(e)&&(e.axis(n)||e.legend(n))||{},o=lr(t,{expr:"datum"}),a=lr(t,{expr:"datum",binSuffix:"end"});return{formulaAs:lr(t,{binSuffix:"range"}),formula:Oa(o,a,i.format,r)}}return{}}(a,t,n,a.config))}return e},{});return 0===ie(t).length?null:new u(e,t)},u.makeFromTransform=function(e,t,n){var r,i=ec(t,n),o=i.key,a=i.binComponent;return new u(e,((r={})[o]=a,r))},u.prototype.merge=function(e){this.bins=I({},this.bins,e.bins),e.remove()},u.prototype.producedFields=function(){var t={};return oe(this.bins).forEach(function(e){e.as.forEach(function(e){return t[e]=!0})}),t},u.prototype.dependentFields=function(){var t={};return oe(this.bins).forEach(function(e){t[e.field]=!0}),t},u.prototype.assemble=function(){return Z(oe(this.bins).map(function(e){var t=[],n=I({type:"bin",field:e.field,as:e.as,signal:e.signal},e.bin);return!e.bin.extent&&e.extentSignal&&(t.push({type:"extent",field:e.field,signal:e.extentSignal}),n.extent={signal:e.extentSignal}),t.push(n),e.formula&&t.push({type:"formula",expr:e.formula,as:e.formulaAs}),t}))},u}(Ra),nc=function(i){function e(e,t,n){var r=i.call(this,e)||this;return r.model=t,r.filter=n,r.expr=Ms(r.model,r.filter,r),r}return h(e,i),e.prototype.clone=function(){return new e(null,this.model,ue(this.filter))},e.prototype.assemble=function(){return{type:"filter",expr:this.expr}},e}(Ra),rc=function(o){function a(e,t,n,r){var i=o.call(this,e)||this;return i.fields=t,i.geojson=n,i.signal=r,i}return h(a,o),a.prototype.clone=function(){return new a(null,ue(this.fields),this.geojson,this.signal)},a.parseAll=function(n,r){var i=0;if([[Ge,qe],[Be,We]].forEach(function(e){var t=e.map(function(e){return r.channelHasField(e)?r.fieldDef(e).field:void 0});(t[0]||t[1])&&(n=new a(n,t,null,r.getName("geojson_"+i++)))}),r.channelHasField(Xe)){var e=r.fieldDef(Xe);e.type===Jn&&(n=new a(n,null,e.field,r.getName("geojson_"+i++)))}return n},a.prototype.assemble=function(){return I({type:"geojson"},this.fields?{fields:this.fields}:{},this.geojson?{geojson:this.geojson}:{},{signal:this.signal})},a}(Ra),ic=function(o){function a(e,t,n,r){var i=o.call(this,e)||this;return i.projection=t,i.fields=n,i.as=r,i}return h(a,o),a.prototype.clone=function(){return new a(null,this.projection,ue(this.fields),ue(this.as))},a.parseAll=function(r,i){return i.projectionName()&&[[Ge,qe],[Be,We]].forEach(function(e){var t=e.map(function(e){return i.channelHasField(e)?i.fieldDef(e).field:void 0}),n=e[0]===Be?"2":"";(t[0]||t[1])&&(r=new a(r,i.projectionName(),t,[i.getName("x"+n),i.getName("y"+n)]))}),r},a.prototype.assemble=function(){return{type:"geopoint",projection:this.projection,fields:this.fields,as:this.as}},a}(Ra),oc=function(t){function e(e){return t.call(this,e)||this}return h(e,t),e.prototype.clone=function(){return new e(null)},e.prototype.producedFields=function(){var e;return(e={})[Li]=!0,e},e.prototype.assemble=function(){return{type:"identifier",as:Li}},e}(Ra),ac=function(i){function e(e,t,n){void 0===e&&(e={}),void 0===t&&(t={}),void 0===n&&(n=!1);var r=i.call(this,e,t)||this;return r.explicit=e,r.implicit=t,r.parseNothing=n,r}return h(e,i),e.prototype.clone=function(){var e=i.prototype.clone.call(this);return e.parseNothing=this.parseNothing,e},e}(Xa),uc=function(i){function c(e,t,n){var r=i.call(this,e)||this;return r.transform=t,r.secondary=n,r}return h(c,i),c.make=function(e,t,n,r){var i=t.component.data.sources,o=new vu(n.from.data),a=i[o.hash()];a||(a=i[o.hash()]=o);var u=t.getName("lookup_"+r),s=new La(a,u,"lookup",t.component.data.outputNodeRefCounts);return new c(e,n,(t.component.data.outputNodes[u]=s).getSource())},c.prototype.producedFields=function(){return f(this.transform.from.fields||(this.transform.as instanceof Array?this.transform.as:[this.transform.as]))},c.prototype.assemble=function(){var e;if(this.transform.from.fields)e=I({values:this.transform.from.fields},this.transform.as?{as:this.transform.as instanceof Array?this.transform.as:[this.transform.as]}:{});else{var t=this.transform.as;m(t)||(hn(en.NO_FIELDS_NEEDS_AS),t="_lookup"),e={as:[t]}}return I({type:"lookup",from:this.secondary,key:this.transform.from.key,fields:[this.transform.lookup]},e,this.transform.default?{default:this.transform.default}:{})},c}(Ra);function sc(i){var o=0;return function t(e,n){e instanceof vu&&(go(e.data)||(i.push(n),n={name:null,source:n.name,transform:[]}));if(e instanceof gu&&(e.parent instanceof vu&&!n.source?(n.format=I({},n.format||{},{parse:e.assembleFormatParse()}),n.transform=n.transform.concat(e.assembleTransforms(!0))):n.transform=n.transform.concat(e.assembleTransforms())),e instanceof hu)return n.name||(n.name="data_"+o++),!n.source||0<n.transform.length?(i.push(n),e.data=n.name):e.data=n.source,void e.assemble().forEach(function(e){return i.push(e)});(e instanceof nc||e instanceof Fa||e instanceof ic||e instanceof rc||e instanceof pu||e instanceof uc||e instanceof xc||e instanceof oc)&&n.transform.push(e.assemble()),(e instanceof mu||e instanceof tc||e instanceof yu||e instanceof wu)&&(n.transform=n.transform.concat(e.assemble())),e instanceof pu&&(n.name||(n.name="data_"+o++)),e instanceof La&&(n.source&&0===n.transform.length?e.setSource(n.source):e.parent instanceof La?e.setSource(n.name):(n.name||(n.name="data_"+o++),e.setSource(n.name),1===e.numChildren()&&(i.push(n),n={name:null,source:n.name,transform:[]})));switch(e.numChildren()){case 0:e instanceof La&&(!n.source||0<n.transform.length)&&i.push(n);break;case 1:t(e.children[0],n);break;default:n.name||(n.name="data_"+o++);var r=n.name;!n.source||0<n.transform.length?i.push(n):r=n.source,e.children.forEach(function(e){t(e,{name:null,source:r,transform:[]})})}}}function cc(e){fc(e);var t=e.component.layoutSize;t.setWithExplicit("width",dc(e,"width")),t.setWithExplicit("height",dc(e,"height"))}var lc=cc;function fc(e){for(var t=0,n=e.children;t<n.length;t++){n[t].parseLayoutSize()}}function dc(e,t){for(var n,r="width"===t?"x":"y",i=e.component.resolve,o=0,a=e.children;o<a.length;o++){var u=(f=a[o]).component.layoutSize.getWithExplicit(t),s=i.scale[r];if("independent"===s&&"range-step"===u.value){n=void 0;break}if(n){if("independent"===s&&n.value!==u.value){n=void 0;break}n=$a(n,u,t,"")}else n=u}if(n){for(var c=0,l=e.children;c<l.length;c++){var f=l[c];e.renameLayoutSize(f.getName(t),e.getName(t)),f.component.layoutSize.set(t,"merged",!1)}return n}return{explicit:!1,value:void 0}}function pc(e,t){var n="width"===t?"x":"y",r=e.config,i=e.getScaleComponent(n);if(i){var o=i.get("type"),a=i.get("range");return yi(o)&&Mo(a)?"range-step":r.view[t]}return e.hasProjection?r.view[t]:"width"===t&&"text"===e.mark?r.scale.textXRangeStep:r.scale.rangeStep||Ei.rangeStep}function hc(e,t){return tr(e.field)?e.field.repeat in t?I({},e,{field:t[e.field.repeat]}):void hn(en.noSuchRepeatedValue(e.field.repeat)):e}function mc(e,t){if(void 0!==(e=hc(e,t))){if(e.sort&&Qo(e.sort)){var n=hc(e.sort,t);e=I({},e,n?{sort:n}:{})}return e}}function gc(e,t){if(!ar(e)){if(ir(e)){if(n=mc(e.condition,t))return I({},e,{condition:n});e.condition;return z(e,["condition"])}return e}var n;return(n=mc(e,t))?n:rr(e)?{condition:e.condition}:void 0}function vc(e,t){var n={};for(var r in e)if(e.hasOwnProperty(r)){var i=e[r];if(S(i))n[r]=i.map(function(e){return gc(e,t)}).filter(function(e){return e});else{var o=gc(i,t);o&&(n[r]=o)}}return n}function yc(e,t,n){return lr(t,{expr:n,suffix:"by_"+lr(e)})}var bc=function(u){function l(e,t,n,r,i){var o=u.call(this,e,t,n,i,r,e.resolve)||this;o.type="facet",o.child=qc(e.spec,o,o.getName("child"),void 0,r,i,!1),o.children=[o.child];var a=vc(e.facet,r);return o.facet=o.initFacet(a),o}return h(l,u),l.prototype.initFacet=function(e){return Pr(e,function(e,t,n){return X([Ye,Ve],n)?void 0===t.field?hn(en.emptyFieldDef(t,n)):e[n]=wr(t,n):hn(en.incompatibleChannel(n,"facet")),e},{})},l.prototype.channelHasField=function(e){return!!this.facet[e]},l.prototype.fieldDef=function(e){return this.facet[e]},l.prototype.parseData=function(){this.component.data=Sc(this),this.child.parseData()},l.prototype.parseLayoutSize=function(){fc(this)},l.prototype.parseSelection=function(){this.child.parseSelection(),this.component.selection=this.child.component.selection},l.prototype.parseMarkGroup=function(){this.child.parseMarkGroup()},l.prototype.parseAxisAndHeader=function(){this.child.parseAxisAndHeader(),this.parseHeader("column"),this.parseHeader("row"),this.mergeChildAxis("x"),this.mergeChildAxis("y")},l.prototype.parseHeader=function(e){if(this.channelHasField(e)){var t=this.facet[e],n=t.header||{},r=void 0!==t.title?t.title:void 0!==n.title?n.title:xr(t,this.config);this.child.component.layoutHeaders[e].title&&(r+=" / "+this.child.component.layoutHeaders[e].title,this.child.component.layoutHeaders[e].title=null),this.component.layoutHeaders[e]={title:r,facetFieldDef:t,header:[this.makeHeaderComponent(e,!0)]}}},l.prototype.makeHeaderComponent=function(e,t){var n="row"===e?"height":"width";return{labels:t,sizeSignal:this.child.component.layoutSize.get(n)?this.child.getSizeSignalRef(n):void 0,axes:[]}},l.prototype.mergeChildAxis=function(e){var t,n=this.child;if(n.component.axes[e]){var r=this.component,i=r.layoutHeaders,o=r.resolve;if(o.axis[e]=Va(o,e),"shared"===o.axis[e])for(var a="x"===e?"column":"row",u=i[a],s=0,c=n.component.axes[e];s<c.length;s++){var l=c[s],f="top"===(t=l.get("orient"))||"left"===t?"header":"footer";u[f]=u[f]||[this.makeHeaderComponent(a,!1)];var d=Wo(l,"main",this.config,{header:!0});u[f][0].axes.push(d),l.mainExtracted=!0}}},l.prototype.assembleSelectionTopLevelSignals=function(e){return this.child.assembleSelectionTopLevelSignals(e)},l.prototype.assembleSelectionSignals=function(){return this.child.assembleSelectionSignals(),[]},l.prototype.assembleSelectionData=function(e){return this.child.assembleSelectionData(e)},l.prototype.getHeaderLayoutMixins=function(){var a=this,u={};return["row","column"].forEach(function(o){["header","footer"].forEach(function(e){var t=a.component.layoutHeaders[o],n=t[e];if(n&&n[0]){var r="row"===o?"height":"width",i="header"===e?"headerBand":"footerBand";a.child.component.layoutSize.get(r)||(u[i]=u[i]||{},u[i][o]=.5),t.title&&(u.offset=u.offset||{},u.offset["row"===o?"rowTitle":"columnTitle"]=10)}})}),u},l.prototype.assembleDefaultLayout=function(){var e=this.channelHasField("column")?this.columnDistinctSignal():1;return I({},this.getHeaderLayoutMixins(),{columns:e,bounds:"full",align:"all"})},l.prototype.assembleLayoutSignals=function(){return this.child.assembleLayoutSignals()},l.prototype.columnDistinctSignal=function(){if(!(this.parent&&this.parent instanceof l))return{signal:"length(data('"+this.getName("column_domain")+"'))"}},l.prototype.assembleGroup=function(e){return this.parent&&this.parent instanceof l?I({},this.channelHasField("column")?{encode:{update:{columns:{field:lr(this.facet.column,{prefix:"distinct"})}}}}:{},u.prototype.assembleGroup.call(this,e)):u.prototype.assembleGroup.call(this,e)},l.prototype.getCardinalityAggregateForChild=function(){var e=[],t=[],n=[];if(this.child instanceof l){if(this.child.channelHasField("column")){var r=lr(this.child.facet.column);e.push(r),t.push("distinct"),n.push("distinct_"+r)}}else for(var i=0,o=["x","y"];i<o.length;i++){var a=o[i],u=this.child.component.scales[a];if(u&&!u.merged){var s=u.get("type"),c=u.get("range");if(yi(s)&&Mo(c))(r=Du(Iu(this.child,a)))?(e.push(r),t.push("distinct"),n.push("distinct_"+r)):hn("Unknown field for ${channel}.  Cannot calculate view size.")}}return{fields:e,ops:t,as:n}},l.prototype.assembleFacet=function(){var a=this,e=this.component.data.facetRoot,t=e.name,n=e.data,r=this.facet,u=r.row,s=r.column,i=this.getCardinalityAggregateForChild(),c=i.fields,l=i.ops,f=i.as,d=[];["row","column"].forEach(function(e){var t=a.facet[e];if(t){d.push(lr(t));var n=t.sort;if(Qo(n)){var r=n.field,i=n.op,o=yc(t,n);u&&s?(c.push(o),l.push("max")):(c.push(r),l.push(i)),f.push(o)}else if(S(n)){o=ja(t,e);c.push(o),l.push("max"),f.push(o)}}});var o=!!u&&!!s;return I({name:t,data:n,groupby:d},o||c.length?{aggregate:I({},o?{cross:o}:{},c.length?{fields:c,ops:l,as:f}:{})}:{})},l.prototype.headerSortFields=function(e){var t=this.facet[e];return t?Qo(t.sort)?[yc(t,t.sort,"datum")]:S(t.sort)?[ja(t,e,"datum")]:[lr(t,{expr:"datum"})]:[]},l.prototype.headerSortOrder=function(e){var t=this.facet[e];if(t){var n=t.sort;return[(Qo(n)?n.order:!S(n)&&n)||"ascending"]}return[]},l.prototype.assembleMarks=function(){var t,e,n,r=this.child,i=this.component.data.facetRoot,o=(t=i,n=sc(e=[]),t.children.forEach(function(e){return n(e,{source:t.name,name:null,transform:[]})}),e),a=r.assembleLayoutSize(),u=r.assembleTitle(),s=r.assembleGroupStyle();return[I({name:this.getName("cell"),type:"group"},u?{title:u}:{},s?{style:s}:{},{from:{facet:this.assembleFacet()},sort:{field:this.headerSortFields("row").concat(this.headerSortFields("column")),order:this.headerSortOrder("row").concat(this.headerSortOrder("column"))}},0<o.length?{data:o}:{},a?{encode:{update:a}}:{},r.assembleGroup())]},l.prototype.getMapping=function(){return this.facet},l}(Ju),xc=function(r){function l(e,t){var n=r.call(this,e)||this;return n.transform=t,n}return h(l,r),l.makeFromFacet=function(e,t){var n=t.row,r=t.column;if(n&&r){for(var i=null,o=0,a=[n,r];o<a.length;o++){var u=a[o];if(Qo(u.sort)){var s=u.sort,c=s.field;e=i=new l(e,{window:[{op:s.op,field:c,as:yc(u,u.sort)}],groupby:[lr(u)],frame:[null,null]})}}return i}return null},l.prototype.clone=function(){return new l(this.parent,ue(this.transform))},l.prototype.producedFields=function(){var t=this,n={};return this.transform.window.forEach(function(e){n[t.getDefaultName(e)]=!0}),n},l.prototype.getDefaultName=function(e){return e.as||lr(e)},l.prototype.assemble=function(){for(var e=[],t=[],n=[],r=[],i=0,o=this.transform.window;i<o.length;i++){var a=o[i];t.push(a.op),n.push(this.getDefaultName(a)),r.push(void 0===a.param?null:a.param),e.push(void 0===a.field?null:a.field)}var u=this.transform.frame,s=this.transform.groupby,c=[],l=[];if(void 0!==this.transform.sort)for(var f=0,d=this.transform.sort;f<d.length;f++){var p=d[f];c.push(p.field),l.push(p.order||"ascending")}var h={field:c,order:l},m=this.transform.ignorePeers,g={type:"window",params:r,as:n,ops:t,fields:e,sort:h};return void 0!==m&&(g.ignorePeers=m),void 0!==s&&(g.groupby=s),void 0!==u&&(g.frame=u),g},l}(Ra);function Sc(e){var t=function(e,t){if(e.data||!e.parent){var n=new vu(e.data),r=n.hash();return r in t?t[r]:t[r]=n}return e.parent.component.data.facetRoot?e.parent.component.data.facetRoot:e.parent.component.data.main}(e,e.component.data.sources),n=e.component.data,r=n.outputNodes,i=n.outputNodeRefCounts,o=e.parent?e.parent.component.data.ancestorParse.clone():new ac;e.data&&e.data.format&&null===e.data.format.parse&&(o.parseNothing=!0),t=gu.makeExplicit(t,e,o)||t,Cs(e)&&(Bu(e)||Qu(e))&&(t=new oc(t));var v,y,b,x,a=e.parent&&Qu(e.parent);(Bu(e)||Yu(e))&&a&&(t=tc.makeFromEncoding(t,e)||t),0<e.transforms.length&&(v=t,b=o,x=0,(y=e).transforms.forEach(function(e){if(Vs(e))v=new Fa(v,e),b.set(e.as,"derived",!1);else if(Gs(e))v=gu.makeImplicitFromFilterTransform(v,e,b)||v,v=new nc(v,y,e.filter);else if(Xs(e))for(var t=v=tc.makeFromTransform(v,e,y),n=0,r=ie(t.producedFields());n<r.length;n++){var i=r[n];b.set(i,"number",!1)}else if(Qs(e))v=yu.makeFromTransform(v,e),b.set(e.as,"date",!1);else if(Ks(e)){var o=v=pu.makeFromTransform(v,e);Cs(y)&&(v=new oc(v));for(var a=0,u=ie(o.producedFields());a<u.length;a++)i=u[a],b.set(i,"derived",!1)}else if(Bs(e))for(var s=v=uc.make(v,y,e,x++),c=0,l=ie(s.producedFields());c<l.length;c++)i=l[c],b.set(i,"derived",!1);else if(Ys(e))for(var f=v=new xc(v,e),d=0,p=ie(f.producedFields());d<p.length;d++)i=p[d],b.set(i,"derived",!1);else{if(!Js(e))return void hn(en.invalidTransformIgnored(e));for(var h=v=wu.makeFromTransform(v,e),m=0,g=ie(h.producedFields());m<g.length;m++)i=g[m],b.set(i,"derived",!1)}}),t=v),t=gu.makeImplicitFromEncoding(t,e,o)||t,Bu(e)&&(t=rc.parseAll(t,e),t=ic.parseAll(t,e)),(Bu(e)||Yu(e))&&(a||(t=tc.makeFromEncoding(t,e)||t),t=yu.makeFromEncoding(t,e)||t,t=Fa.parseAllForSortIndex(t,e));var u=e.getName(xo),s=new La(t,u,xo,i);if(t=r[u]=s,Bu(e)){var c=pu.makeFromEncoding(t,e);c&&(t=c,Cs(e)&&(t=new oc(t))),t=wu.makeFromEncoding(t,e)||t}Bu(e)&&(t=mu.make(t,e)||t);var l=e.getName(bo),f=new La(t,l,bo,i);t=r[l]=f;var d=null;if(Yu(e)){var p=e.getName("facet");t=Fa.parseAllForSortIndex(t,e),t=xc.makeFromFacet(t,e.facet)||t,d=new hu(t,e,p,f.getSource()),t=r[p]=d}return I({},e.component.data,{outputNodes:r,outputNodeRefCounts:i,raw:s,main:f,facetRoot:d,ancestorParse:o})}var Ec=function(a){function e(e,t,n,r,i,o){return a.call(this,e,t,n,r,i,o)||this}return h(e,a),e.prototype.parseData=function(){this.component.data=Sc(this),this.children.forEach(function(e){e.parseData()})},e.prototype.parseSelection=function(){var n=this;this.component.selection={};for(var e=function(t){t.parseSelection(),ie(t.component.selection).forEach(function(e){n.component.selection[e]=t.component.selection[e]})},t=0,r=this.children;t<r.length;t++){e(r[t])}},e.prototype.parseMarkGroup=function(){for(var e=0,t=this.children;e<t.length;e++){t[e].parseMarkGroup()}},e.prototype.parseAxisAndHeader=function(){for(var e=0,t=this.children;e<t.length;e++){t[e].parseAxisAndHeader()}},e.prototype.assembleSelectionTopLevelSignals=function(e){return this.children.reduce(function(e,t){return t.assembleSelectionTopLevelSignals(e)},e)},e.prototype.assembleSelectionSignals=function(){return this.children.forEach(function(e){return e.assembleSelectionSignals()}),[]},e.prototype.assembleLayoutSignals=function(){return this.children.reduce(function(e,t){return e.concat(t.assembleLayoutSignals())},Wa(this))},e.prototype.assembleSelectionData=function(e){return this.children.reduce(function(e,t){return t.assembleSelectionData(e)},e)},e.prototype.assembleMarks=function(){return this.children.map(function(e){var t=e.assembleTitle(),n=e.assembleGroupStyle(),r=e.assembleLayoutSize();return I({type:"group",name:e.getName("group")},t?{title:t}:{},n?{style:n}:{},r?{encode:{update:r}}:{},e.assembleGroup())})},e}(Ku),wc=function(a){function e(e,t,n,r,i){var o=a.call(this,e,t,n,i,r,e.resolve)||this;return o.type="concat",e.resolve&&e.resolve.axis&&("shared"===e.resolve.axis.x||"shared"===e.resolve.axis.y)&&hn(en.CONCAT_CANNOT_SHARE_AXIS),o.isVConcat=ro(e),o.children=(ro(e)?e.vconcat:e.hconcat).map(function(e,t){return qc(e,o,o.getName("concat_"+t),void 0,r,i,!1)}),o}return h(e,a),e.prototype.parseLayoutSize=function(){!function(e){fc(e);var t=e.component.layoutSize,n=e.isVConcat?"width":"height";t.setWithExplicit(n,dc(e,n))}(this)},e.prototype.parseAxisGroup=function(){return null},e.prototype.assembleDefaultLayout=function(){return I({},this.isVConcat?{columns:1}:{},{bounds:"full",align:"each"})},e}(Ec);var kc=function(i){function e(e,t,n){void 0===e&&(e={}),void 0===t&&(t={}),void 0===n&&(n=!1);var r=i.call(this)||this;return r.explicit=e,r.implicit=t,r.mainExtracted=n,r}return h(e,i),e.prototype.clone=function(){return new e(ue(this.explicit),ue(this.implicit),this.mainExtracted)},e.prototype.hasAxisPart=function(e){return"axis"===e||("grid"===e||"title"===e?!!this.get(e):!(!1===(t=this.get(e))||null===t));var t},e}(Xa);function Nc(e,t,n,r,i){void 0===r&&(r="");for(var o=0,a=("band"===i?["axisBand"]:[]).concat(["x"===n?"axisX":"axisY","axis"+r.substr(0,1).toUpperCase()+r.substr(1),"axis"]);o<a.length;o++){var u=a[o];if(t[u]&&void 0!==t[u][e])return t[u][e]}}function Oc(e,t,n,r){var i=e.fieldDef(t)||("x"===t?e.fieldDef("x2"):"y"===t?e.fieldDef("y2"):void 0),o=e.axis(t),a=e.config,u={};if(Cr(i)){var s=e.getScaleComponent(t).get("type")===Kr.UTC,c=_a("datum.value",i.timeUnit,o.format,a.axis.shortTimeLabels,a.timeFormat,s);c&&(u.text={signal:c})}var l,f,d,p,h=Nc("labelAngle",e.config,t,r,e.getScaleComponent(t).get("type"));if(void 0===h&&(h=function(e,t,n){{if(void 0!==e.labelAngle)return(e.labelAngle%360+360)%360;if(t===Ue&&X([Kn,Xn],n.type))return 270}return}(o,t,i))&&(u.angle={value:h}),void 0!==h){var m=(d=((d=h)%360+360)%360,"top"===(p=r)||"bottom"===p?d%180==0?"center":0<d&&d<180?"top"===p?"right":"left":"top"===p?"left":"right":(d+90)%180==0?"center":90<=d&&d<270?"left"===p?"left":"right":"left"===p?"right":"left");m&&(u.align={value:m}),u.baseline=(l=h,"top"===(f=r)||"bottom"===f?l<=45||315<=l?{value:"top"===f?"bottom":"top"}:135<=l&&l<=225?{value:"top"===f?"top":"bottom"}:{value:"middle"}:l<=45||315<=l||135<=l&&l<=225?{value:"middle"}:45<=l&&l<=135?{value:"left"===f?"top":"bottom"}:{value:"left"===f?"bottom":"top"})}return u=I({},u,n),0===ie(u).length?void 0:u}function _c(n){return yt.reduce(function(e,t){return n.component.scales[t]&&n.axis(t)&&(e[t]=[function(i,o){var a=o.axis(i),u=new kc;Le.forEach(function(e){var t=function(e,t,n,r){var i=r.fieldDef(n);switch(e){case"scale":return r.scaleName(n);case"gridScale":return function(e,t){var n="x"===t?"y":"x";if(e.getScaleComponent(n))return e.scaleName(n)}(r,n);case"format":return wa(i,t.format,r.config);case"grid":var o=r.getScaleComponent(n).get("type");return Ea(t.grid,(y=i,!yi(o)&&!y.bin));case"labelFlush":return m=i,g=n,void 0!==(v=t).labelFlush?v.labelFlush:!("x"!==g||!X(["quantitative","temporal"],m.type))||void 0;case"labelOverlap":var o=r.getScaleComponent(n).get("type");return d=i,h=o,void 0!==(p=t).labelOverlap?p.labelOverlap:"nominal"!==d.type?"log"!==h||"greedy":void 0;case"orient":return Ea(t.orient,function(e){switch(e){case Ue:return"bottom";case Pe:return"left"}throw new Error(en.INVALID_CHANNEL_FOR_AXIS)}(n));case"tickCount":var o=r.getScaleComponent(n).get("type"),a="x"===n?"width":"y"===n?"height":void 0,u=a?r.getSizeSignalRef(a):void 0;return Ea(t.tickCount,function(e,t,n,r){if(!yi(n)&&"log"!==n&&!X(["month","hours","day","quarter"],t.timeUnit))return t.bin?{signal:"ceil("+r.signal+"/20)"}:{signal:"ceil("+r.signal+"/40)"}}(0,i,o,u));case"title":var s="x"===n?"x2":"y2",c=r.fieldDef(s),l=Dc(r,n),f=void 0!==l?l:void 0===t.title?void 0:t.title;return Ea(f,Ca([nr(i)],c?[nr(c)]:[]));case"values":return function(e,t,n,r){var i=e.values;if(i)return Dr(n,i);if(n.bin&&n.type===Vn){var o=t.scaleDomain(r);if(o&&"unaggregated"!==o&&!ki(o))return;var a=t.getName(Tt(n.bin)+"_"+n.field+"_bins");return{signal:"sequence("+a+".start, "+a+".stop + "+a+".step, "+a+".step)"}}}(t,r,i,n)}var d,p,h;var m,g,v;var y;return Ie(e)?t[e]:void 0}(e,a,i,o);if(void 0!==t){var n="values"===e?!!a.values:"encode"===e?!!a.encoding||!!a.labelAngle:"title"===e&&t===Dc(o,i)||t===a[e],r=Nc(e,o.config,i,u.get("orient"),o.getScaleComponent(i).get("type"));n||void 0===r?u.set(e,t,n):"grid"===e&&r&&u.set(e,r,!1)}});var s=a.encoding||{},e=Te.reduce(function(e,t){if(!u.hasAxisPart(t))return e;var n=za(s[t]||{},o),r="labels"===t?Oc(o,i,n,u.get("orient")):n;return void 0!==r&&0<ie(r).length&&(e[t]={update:r}),e},{});0<ie(e).length&&u.set("encode",e,!!a.encoding||void 0!==a.labelAngle);return u}(t,n)]),e},{})}var Tc={bottom:"top",top:"bottom",left:"right",right:"left"};function Cc(e,t){if(!e)return t.map(function(e){return e.clone()});if(e.length===t.length){for(var n=e.length,r=0;r<n;r++){var i=e[r],o=t[r];if(!!i!=!!o)return;if(i&&o){var a=i.getWithExplicit("orient"),u=o.getWithExplicit("orient");if(a.explicit&&u.explicit&&a.value!==u.value)return;e[r]=Ac(i,o)}}return e}}function Ac(t,r){for(var e=function(n){var e=$a(t.getWithExplicit(n),r.getWithExplicit(n),n,"axis",function(e,t){switch(n){case"title":return Da(e,t);case"gridScale":return{explicit:e.explicit,value:e.value||t.value}}return Za(e,t,n,"axis")});t.setWithExplicit(n,e)},n=0,i=Le;n<i.length;n++){e(i[n])}return t}function Dc(e,t){var n="x"===t?"x2":"y2",r=e.fieldDef(t),i=e.fieldDef(n),o=r?r.title:void 0,a=i?i.title:void 0;return o&&a?Aa(o,a):o||(a||(void 0!==o?o:void 0!==a?a:void 0))}function Ic(e,t,n){var r,i,o,a=Qt(e)?I({},e):{type:e},u=a.orient||xa("orient",a,n);return a.orient=function(e,t,n){switch(e){case jt:case Gt:case Bt:case Ut:case Ht:return}var r=t.y2,i=t.x2;switch(e){case Lt:if(r||i){if(n)return n;var o=t.x;if(!i&&ar(o)&&o.type===Vn&&!o.bin)return"horizontal";var a=t.y;if(!r&&ar(a)&&a.type===Vn&&!a.bin)return"vertical"}case qt:if(i&&r)return;case Rt:if(r)return"vertical";if(i)return"horizontal";if(e===qt){if(t.x&&!t.y)return"vertical";if(t.y&&!t.x)return"horizontal"}case Ft:case Pt:var u=ar(t.x)&&dr(t.x),s=ar(t.y)&&dr(t.y);if(u&&!s)return"tick"!==e?"horizontal":"vertical";if(!u&&s)return"tick"!==e?"vertical":"horizontal";if(u&&s){var o=t.x,a=t.y,c=o.type===Qn,l=a.type===Qn;return c&&!l?"tick"!==e?"vertical":"horizontal":!c&&l?"tick"!==e?"horizontal":"vertical":!o.aggregate&&a.aggregate?"tick"!==e?"vertical":"horizontal":o.aggregate&&!a.aggregate?"tick"!==e?"horizontal":"vertical":n||"vertical"}return n||void 0}return"vertical"}(a.type,t,u),void 0!==u&&u!==a.orient&&hn(en.orientOverridden(a.orient,u)),void 0===(void 0!==a.opacity?a.opacity:xa("opacity",a,n))&&(a.opacity=function(e,t){if(X([jt,Pt,Gt,Bt],e)&&!Rr(t))return.7;return}(a.type,t)),void 0===a.filled&&(a.filled=(i=xa("filled",r=a,n),o=r.type,void 0!==i?i:o!==jt&&o!==Ft&&o!==qt)),void 0===(a.cursor||xa("cursor",a,n))&&(a.cursor=function(e,t,n){if(t.href||e.href||xa("href",e,n))return"pointer";return e.cursor}(a,t,n)),a}function zc(e,t,n,r){if(void 0!==e.size)return{value:e.size};if(r.bar.discreteBandSize)return{value:r.bar.discreteBandSize};if(n){var i=n.get("type");if(i!==Kr.POINT)return i===Kr.BAND?ta(t):{value:r.bar.continuousBandSize};var o=n.get("range");if(Mo(o)&&x(o.step))return{value:o.step-1};hn(en.BAR_WITH_POINT_SCALE_AND_RANGESTEP_NULL)}else if(r.scale.rangeStep&&null!==r.scale.rangeStep)return{value:r.scale.rangeStep-1};return{value:20}}function Rc(e,t){var n=e.config,r=e.width,i=e.height;return I({},ua(e,{size:"include",orient:"ignore"}),va("x",e,ia(r)),va("y",e,ia(i)),la("size",e),function(e,t,n){if(n)return{shape:{value:n}};return la("shape",e,{defaultValue:xa("shape",e.markDef,t)})}(e,n,t))}var Lc={area:{vgMark:"area",encodeEntry:function(e){return I({},ua(e,{size:"ignore",orient:"include"}),va("x",e,"zeroOrMin"),va("y",e,"zeroOrMin"),ya(e,"zeroOrMin","horizontal"===e.markDef.orient?"x2":"y2"),ca(e))}},bar:{vgMark:"rect",encodeEntry:function(e){return I({},ua(e,{size:"ignore",orient:"ignore"}),function(e){var t=e.config,n=e.encoding,r=e.markDef,i=e.width,o=r.orient,a=n.size,u=n.x,s=n.x2,c=e.scaleName(Ue),l=e.getScaleComponent(Ue);{if("horizontal"===o||s)return I({},va("x",e,"zeroOrMin"),ya(e,"zeroOrMin","x2"));if(ar(u)){var f=l.get("type");if(u.bin&&!a&&!yi(f))return ga(u,"x",e.scaleName("x"),void 0===r.binSpacing?t.bar.binSpacing:r.binSpacing,l.get("reverse"));if(f===Kr.BAND)return ha(u,"x",e)}return ma("x",e,I({},ia(i)),zc(r,c,l,t))}}(e),function(e){var t=e.config,n=e.encoding,r=e.height,i=e.markDef,o=i.orient,a=n.size,u=n.y,s=n.y2,c=e.scaleName(Pe),l=e.getScaleComponent(Pe);{if("vertical"===o||s)return I({},va("y",e,"zeroOrMin"),ya(e,"zeroOrMin","y2"));if(ar(u)){var f=l.get("type");if(u.bin&&!a&&!yi(f))return ga(u,"y",e.scaleName("y"),void 0===i.binSpacing?t.bar.binSpacing:i.binSpacing,l.get("reverse"));if(f===Kr.BAND)return ha(u,"y",e)}return ma("y",e,ia(r),zc(i,c,l,t))}}(e))}},circle:{vgMark:"symbol",encodeEntry:function(e){return Rc(e,"circle")}},geoshape:{vgMark:"shape",encodeEntry:function(e){return I({},ua(e,{size:"ignore",orient:"ignore"}))},postEncodingTransform:function(e){var t=e.encoding.shape;return[I({type:"geoshape",projection:e.projectionName()},t&&ar(t)&&t.type===Jn?{field:lr(t,{expr:"datum"})}:{})]}},line:{vgMark:"line",encodeEntry:function(e){var t=e.width,n=e.height;return I({},ua(e,{size:"ignore",orient:"ignore"}),va("x",e,ia(t)),va("y",e,ia(n)),la("size",e,{vgChannel:"strokeWidth"}),ca(e))}},point:{vgMark:"symbol",encodeEntry:function(e){return Rc(e)}},rect:{vgMark:"rect",encodeEntry:function(e){return I({},ua(e,{size:"ignore",orient:"ignore"}),function(e){var t=e.encoding.x,n=e.encoding.x2,r=e.getScaleComponent(Ue),i=r?r.get("type"):void 0;{if(ar(t)&&t.bin&&!n)return ga(t,"x",e.scaleName("x"),0,r.get("reverse"));if(ar(t)&&r&&yi(i)){if(i===Kr.BAND)return ha(t,"x",e);throw new Error(en.scaleTypeNotWorkWithMark(Ht,i))}return I({},va("x",e,"zeroOrMax"),ya(e,"zeroOrMin","x2"))}}(e),function(e){var t=e.encoding.y,n=e.encoding.y2,r=e.getScaleComponent(Pe),i=r?r.get("type"):void 0;{if(ar(t)&&t.bin&&!n)return ga(t,"y",e.scaleName("y"),0,r.get("reverse"));if(ar(t)&&r&&yi(i)){if(i===Kr.BAND)return ha(t,"y",e);throw new Error(en.scaleTypeNotWorkWithMark(Ht,i))}return I({},va("y",e,"zeroOrMax"),ya(e,"zeroOrMin","y2"))}}(e))}},rule:{vgMark:"rule",encodeEntry:function(e){e.config;var t=e.markDef,n=e.width,r=e.height,i=t.orient;return e.encoding.x||e.encoding.y||e.encoding.latitude||e.encoding.longitude?I({},ua(e,{size:"ignore",orient:"ignore"}),va("x",e,"horizontal"===i?"zeroOrMin":ia(n)),va("y",e,"vertical"===i?"zeroOrMin":ia(r)),"vertical"!==i?ya(e,"zeroOrMax","x2"):{},"horizontal"!==i?ya(e,"zeroOrMax","y2"):{},la("size",e,{vgChannel:"strokeWidth",defaultValue:t.size})):{}}},square:{vgMark:"symbol",encodeEntry:function(e){return Rc(e,"square")}},text:{vgMark:"text",encodeEntry:function(e){var t=e.config,n=(e.encoding,e.width),r=e.height,i=e.markDef;return I({},ua(e,{size:"ignore",orient:"ignore"}),va("x",e,ia(n)),va("y",e,ia(r)),da(e),la("size",e,I({},i.size?{defaultValue:i.size}:{},{vgChannel:"fontSize"})),function(e,t){var n;if(void 0!==t)return(n={})[e]={value:t},n}("align",function(e,t,n){if(void 0===(e.align||xa("align",e,n)))return"center";return}(e.markDef,0,t)))}},tick:{vgMark:"rect",encodeEntry:function(e){var t,n=e.config,r=e.markDef,i=e.width,o=e.height,a=r.orient,u="horizontal"===a?"width":"height",s="horizontal"===a?"height":"width";return I({},ua(e,{size:"ignore",orient:"ignore"}),va("x",e,ia(i),"xc"),va("y",e,ia(o),"yc"),la("size",e,{defaultValue:function(e){var t=e.config,n=e.markDef,r=n.orient,i=e.getScaleComponent("horizontal"===r?"x":"y");{if(void 0!==n.size)return n.size;if(void 0!==t.tick.bandSize)return t.tick.bandSize;var o=i?i.get("range"):void 0,a=o&&Mo(o)?o.step:t.scale.rangeStep;if("number"!=typeof a)throw new Error("Function does not handle non-numeric rangeStep");return a/1.5}}(e),vgChannel:u}),((t={})[s]={value:r.thickness||n.tick.thickness},t))}},trail:{vgMark:"trail",encodeEntry:function(e){var t=e.width,n=e.height;return I({},ua(e,{size:"include",orient:"ignore"}),va("x",e,ia(t)),va("y",e,ia(n)),la("size",e),ca(e))}}};function Fc(e){return X([Ft,Rt,Mt],e.mark)?(i=(t=e).mark,o=t.encoding,n=ie(o).reduce(function(t,e){switch(e){case"x":case"y":case"order":case"tooltip":case"href":case"x2":case"y2":case"latitude":case"longitude":case"latitude2":case"longitude2":case"text":case"shape":return t;case"detail":case"key":var n=o[e];return n&&(S(n)?n:[n]).forEach(function(e){e.aggregate||t.push(lr(e,{}))}),t;case"size":if("trail"===i)return t;case"color":case"fill":case"stroke":case"opacity":var r=Er(o[e]);return r&&!r.aggregate&&t.push(lr(r,{})),t;default:throw new Error("Bug: Channel "+e+" unimplemented for line mark")}},[]),r=Uc(t,{fromPrefix:0<n.length?jc:""}),0<n.length?[{name:t.getName("pathgroup"),type:"group",from:{facet:{name:jc+t.requestDataName(bo),data:t.requestDataName(bo),groupby:n}},encode:{update:{width:{field:{group:"width"}},height:{field:{group:"height"}}}},marks:r}]:r):Uc(e);var t,n,r,i,o}var jc="faceted_path_";function Uc(e,t){void 0===t&&(t={fromPrefix:""});var n,r,i,o=e.mark,a=void 0!==e.markDef.clip?!!e.markDef.clip:(r=(n=e).getScaleComponent("x"),i=n.getScaleComponent("y"),!!(r&&r.get("domainRaw")||i&&i.get("domainRaw"))),u=ba(e.markDef),s=e.encoding.key,c=function(e){var t=e.encoding,n=e.stack,r=e.mark,i=e.markDef,o=t.order;if(S(o)||!sr(o)){if((S(o)||ar(o))&&!n)return Ta(o,{expr:"datum"});if(Vt(r)){var a=t["horizontal"===i.orient?"y":"x"];if(ar(a)){var u=a.sort;return{field:Qo(u)?lr({aggregate:Rr(e.encoding)?u.op:void 0,field:u.field},{expr:"datum"}):lr(a,{binSuffix:e.stack&&e.stack.impute?"mid":void 0,expr:"datum"}),order:"descending"}}}}}(e),l=Lc[o].postEncodingTransform?Lc[o].postEncodingTransform(e):null;return[I({name:e.getName("marks"),type:Lc[o].vgMark},a?{clip:!0}:{},u?{style:u}:{},s?{key:{field:s.field}}:{},c?{sort:c}:{},{from:{data:t.fromPrefix+e.requestDataName(bo)},encode:{update:Lc[o].encodeEntry(e)}},l?{transform:l}:{})]}var Pc=function(l){function e(e,t,n,r,i,o,a){void 0===r&&(r={});var u=l.call(this,e,t,n,o,i,void 0)||this;u.fit=a,u.type="unit",u.specifiedScales={},u.specifiedAxes={},u.specifiedLegends={},u.specifiedProjection={},u.selection={},u.children=[],u.initSize(I({},r,e.width?{width:e.width}:{},e.height?{height:e.height}:{}));var s=Qt(e.mark)?e.mark.type:e.mark,c=u.encoding=Lr(vc(e.encoding||{},i),s);return u.markDef=Ic(e.mark,c,o),u.stack=Ki(s,c,u.config.stack),u.specifiedScales=u.initScales(s,c),u.specifiedAxes=u.initAxes(c),u.specifiedLegends=u.initLegend(c),u.specifiedProjection=e.projection,u.selection=e.selection,u}return h(e,l),Object.defineProperty(e.prototype,"hasProjection",{get:function(){var t=this.encoding,e=this.mark===Wt,n=t&&ut.some(function(e){return ar(t[e])});return e||n},enumerable:!0,configurable:!0}),e.prototype.scaleDomain=function(e){var t=this.specifiedScales[e];return t?t.domain:void 0},e.prototype.axis=function(e){return this.specifiedAxes[e]},e.prototype.legend=function(e){return this.specifiedLegends[e]},e.prototype.initScales=function(e,o){return Et.reduce(function(e,t){var n,r,i=o[t];return ar(i)?r=(n=i).scale:ir(i)?(n=i.condition,r=i.condition.scale):"x"===t?n=Er(o.x2):"y"===t&&(n=Er(o.y2)),n&&(e[t]=r||{}),e},{})},e.prototype.initAxes=function(i){return[Ue,Pe].reduce(function(e,t){var n=i[t];if(ar(n)||t===Ue&&ar(i.x2)||t===Pe&&ar(i.y2)){var r=ar(n)?n.axis:null;null!==r&&!1!==r&&(e[t]=I({},r))}return e},{})},e.prototype.initLegend=function(i){return xt.reduce(function(e,t){var n=i[t];if(n){var r=ar(n)?n.legend:ir(n)?n.condition.legend:null;null!==r&&!1!==r&&(e[t]=I({},r))}return e},{})},e.prototype.parseData=function(){this.component.data=Sc(this)},e.prototype.parseLayoutSize=function(){!function(e){var t=e.component.layoutSize;if(!t.explicit.width){var n=pc(e,"width");t.set("width",n,!1)}if(!t.explicit.height){var r=pc(e,"height");t.set("height",r,!1)}}(this)},e.prototype.parseSelection=function(){this.component.selection=function(o,a){var u={},s=o.config.selection,e=function(e){if(!a.hasOwnProperty(e))return"continue";var t=a[e],n=s[t.type];for(var r in n)"encodings"===r&&t.fields||"fields"===r&&t.encodings||("mark"===r&&(t[r]=I({},n[r],t[r])),void 0!==t[r]&&!0!==t[r]||(t[r]=n[r]||t[r]));e=ce(e);var i=u[e]=I({},t,{name:e,events:m(t.on)?Eo(t.on,"scope"):t.on});bs(i,function(e){e.parse&&e.parse(o,t,i)})};for(var t in a)e(t);return u}(this,this.selection)},e.prototype.parseMarkGroup=function(){this.component.mark=Fc(this)},e.prototype.parseAxisAndHeader=function(){this.component.axes=_c(this)},e.prototype.assembleSelectionTopLevelSignals=function(e){return r=e,i=!1,Ns(n=this,function(t,e){e.topLevelSignals&&(r=e.topLevelSignals(n,t,r)),bs(t,function(e){e.topLevelSignals&&(r=e.topLevelSignals(n,t,r))}),i=!0}),i&&(r.filter(function(e){return"unit"===e.name}).length||r.unshift({name:"unit",value:{},on:[{events:"mousemove",update:"isTuple(group()) ? group() : unit"}]})),r;var n,r,i},e.prototype.assembleSelectionSignals=function(){return function(i,o){Ns(i,function(t,e){var n=t.name,r=e.modifyExpr(i,t);o.push.apply(o,e.signals(i,t)),bs(t,function(e){e.signals&&(o=e.signals(i,t,o)),e.modifyExpr&&(r=e.modifyExpr(i,t,r))}),o.push({name:n+"_modify",on:[{events:{signal:n+Ss},update:"modify("+N(t.name+xs)+", "+r+")"}]})});var e=_s(i);if(o.length&&e){var t=N(e.getName("cell"));o.unshift({name:"facet",value:{},on:[{events:Eo("mousemove","scope"),update:"isTuple(facet) ? facet : group("+t+").datum"}]})}return o}(this,[])},e.prototype.assembleSelectionData=function(e){return n=e,Ns(this,function(t){n.filter(function(e){return e.name===t.name+xs}).length||n.push({name:t.name+xs})}),n;var n},e.prototype.assembleLayout=function(){return null},e.prototype.assembleLayoutSignals=function(){return Wa(this)},e.prototype.assembleMarks=function(){var e=this.component.mark||[];return this.parent&&Qu(this.parent)||(e=ws(this,e)),e.map(this.correctDataNames)},e.prototype.assembleLayoutSize=function(){return{width:this.getSizeSignalRef("width"),height:this.getSizeSignalRef("height")}},e.prototype.getMapping=function(){return this.encoding},e.prototype.toSpec=function(e,t){var n,r=ue(this.encoding);return n={mark:this.markDef,encoding:r},e||(n.config=ue(this.config)),t||(n.data=ue(this.data)),n},Object.defineProperty(e.prototype,"mark",{get:function(){return this.markDef.type},enumerable:!0,configurable:!0}),e.prototype.channelHasField=function(e){return zr(this.encoding,e)},e.prototype.fieldDef=function(e){return Er(this.encoding[e])},e}(Ju),Mc=function(c){function l(e,t,n,r,i,o,a){var u=c.call(this,e,t,n,o,i,e.resolve)||this;u.type="layer";var s=I({},r,e.width?{width:e.width}:{},e.height?{height:e.height}:{});return u.initSize(s),u.children=e.layer.map(function(e,t){if(eo(e))return new l(e,u,u.getName("layer_"+t),s,i,o,a);if($i(e))return new Pc(e,u,u.getName("layer_"+t),s,i,o,a);throw new Error(en.INVALID_SPEC)}),u}return h(l,c),l.prototype.parseData=function(){this.component.data=Sc(this);for(var e=0,t=this.children;e<t.length;e++){t[e].parseData()}},l.prototype.parseLayoutSize=function(){cc(this)},l.prototype.parseSelection=function(){var n=this;this.component.selection={};for(var e=function(t){t.parseSelection(),ie(t.component.selection).forEach(function(e){n.component.selection[e]=t.component.selection[e]})},t=0,r=this.children;t<r.length;t++){e(r[t])}},l.prototype.parseMarkGroup=function(){for(var e=0,t=this.children;e<t.length;e++){t[e].parseMarkGroup()}},l.prototype.parseAxisAndHeader=function(){!function(e){for(var t=e.component,n=t.axes,r=t.resolve,i={top:0,bottom:0,right:0,left:0},o=0,a=e.children;o<a.length;o++){(h=a[o]).parseAxisAndHeader();for(var u=0,s=ie(h.component.axes);u<s.length;u++){var c=s[u];r.axis[c]=Va(e.component.resolve,c),"shared"===r.axis[c]&&(n[c]=Cc(n[c],h.component.axes[c]),n[c]||(r.axis[c]="independent",delete n[c]))}}for(var l=0,f=[Ue,Pe];l<f.length;l++){c=f[l];for(var d=0,p=e.children;d<p.length;d++){var h;if((h=p[d]).component.axes[c]){if("independent"===r.axis[c]){n[c]=(n[c]||[]).concat(h.component.axes[c]);for(var m=0,g=h.component.axes[c];m<g.length;m++){var v=g[m],y=v.getWithExplicit("orient"),b=y.value,x=y.explicit;if(0<i[b]&&!x){var S=Tc[b];i[b]>i[S]&&v.set("orient",S,!1)}i[b]++}}delete h.component.axes[c]}}}}(this)},l.prototype.assembleSelectionTopLevelSignals=function(e){return this.children.reduce(function(e,t){return t.assembleSelectionTopLevelSignals(e)},e)},l.prototype.assembleSelectionSignals=function(){return this.children.reduce(function(e,t){return e.concat(t.assembleSelectionSignals())},[])},l.prototype.assembleLayoutSignals=function(){return this.children.reduce(function(e,t){return e.concat(t.assembleLayoutSignals())},Wa(this))},l.prototype.assembleSelectionData=function(e){return this.children.reduce(function(e,t){return t.assembleSelectionData(e)},e)},l.prototype.assembleTitle=function(){var e=c.prototype.assembleTitle.call(this);if(e)return e;for(var t=0,n=this.children;t<n.length;t++){if(e=n[t].assembleTitle())return e}},l.prototype.assembleLayout=function(){return null},l.prototype.assembleMarks=function(){return t=Z((e=this).children.map(function(e){return e.assembleMarks()})),e.children.forEach(function(e){Bu(e)&&(t=ws(e,t))}),t;var e,t},l.prototype.assembleLegends=function(){return this.children.reduce(function(e,t){return e.concat(t.assembleLegends())},uu(this))},l}(Ku),Hc=function(a){function e(e,t,n,r,i){var o=a.call(this,e,t,n,i,r,e.resolve)||this;return o.type="repeat",e.resolve&&e.resolve.axis&&("shared"===e.resolve.axis.x||"shared"===e.resolve.axis.y)&&hn(en.REPEAT_CANNOT_SHARE_AXIS),o.repeat=e.repeat,o.children=o._initChildren(e,o.repeat,r,i),o}return h(e,a),e.prototype._initChildren=function(e,t,n,r){for(var i=[],o=t.row||[n?n.row:null],a=t.column||[n?n.column:null],u=0,s=o;u<s.length;u++)for(var c=s[u],l=0,f=a;l<f.length;l++){var d=f[l],p=(c?"_"+c:"")+(d?"_"+d:""),h={row:c,column:d};i.push(qc(e.spec,this,this.getName("child"+p),void 0,h,r,!1))}return i},e.prototype.parseLayoutSize=function(){lc(this)},e.prototype.assembleDefaultLayout=function(){return{columns:this.repeat&&this.repeat.column?this.repeat.column.length:1,bounds:"full",align:"all"}},e}(Ec);function qc(e,t,n,r,i,o,a){if(Zi(e))return new bc(e,t,n,i,o);if(eo(e))return new Mc(e,t,n,r,i,o,a);if($i(e))return new Pc(e,t,n,r,i,o,a);if(to(e))return new Hc(e,t,n,i,o);if(no(e))return new wc(e,t,n,i,o);throw new Error(en.INVALID_SPEC)}var Wc=Object.freeze({}),Gc={text:["text"],line:["x","y"],trail:["x","y"],area:["x","y"]},Bc={bar:f(["row","column","x","y","size","color","fill","stroke","detail"]),line:f(["row","column","x","y","color","fill","stroke","color","detail"]),trail:f(["row","column","x","y","color","fill","stroke","color","detail","size"]),area:f(["row","column","x","y","color","fill","stroke","detail"]),tick:f(["row","column","x","y","color","fill","stroke","detail"]),circle:f(["row","column","x","y","color","fill","stroke","size","detail"]),square:f(["row","column","x","y","color","fill","stroke","size","detail"]),point:f(["row","column","x","y","color","fill","stroke","size","detail","shape"]),geoshape:f(["row","column","color","fill","stroke","detail","shape"]),text:f(["row","column","size","color","fill","stroke","text"])};var Yc=Object.freeze({DEFAULT_REQUIRED_CHANNEL_MAP:Gc,DEFAULT_SUPPORTED_CHANNEL_TYPE:Bc,getEncodingMappingError:function(e,t,n){void 0===t&&(t=Gc),void 0===n&&(n=Bc);var r=Qt(e.mark)?e.mark.type:e.mark,i=e.encoding,o=t[r],a=n[r];for(var u in o)if(!(o[u]in i))return'Missing encoding channel "'+o[u]+'" for mark "'+r+'"';for(var s in i)if(!a[s])return'Encoding channel "'+s+'" is not supported by mark type "'+r+'"';return r!==Lt||i.x||i.y?null:"Missing both x and y for bar"}}),Vc="2.7.0";e.aggregate=_e,e.axis=je,e.bin=zt,e.channel=_t,e.compositeMark=Zr,e.config=Bi,e.data=So,e.datetime=kn,e.encoding=Mr,e.facet=Wc,e.fieldDef=Ir,e.header=Xo,e.legend=oi,e.mark=fn,e.scale=Ri,e.sort=Jo,e.spec=fo,e.stack=Ji,e.timeUnit=Bn,e.transform=$s,e.type=$n,e.util=ye,e.validate=Yc,e.version=Vc,e.compile=function(e,t){var n,r,i,o,a,u;void 0===t&&(t={}),t.logger&&(n=t.logger,pn=n),t.fieldTitle&&yr(t.fieldTitle);try{var s=Pi($({},t.config,e.config)),c=oo(e,s),l=function(e,t,n){void 0===n&&(n=!0);var r=I({type:"pad"},po(t),po(e));return"fit"===r.type&&(n||(hn(en.FIT_NON_SINGLE),r.type="pad")),r}(e.autosize,s.autosize,eo(c)||$i(c)),f=qc(c,null,"",void 0,void 0,s,"fit"===l.type);return f.parse(),a=f.component.data,(u=oe(a.sources)).forEach(Ou),_u(u=u.filter(function(e){return 0<e.numChildren()})).forEach(bu(Su)),_u(u=u.filter(function(e){return 0<e.numChildren()})).forEach(bu(xu)),_u(u).forEach(Eu),u.forEach(Nu),ie(a.sources).forEach(function(e){0===a.sources[e].numChildren()&&delete a.sources[e]}),function(e,t){var n=e.config?Wi(e.config):void 0,r=[].concat(e.assembleSelectionData([]),function(e,t){var n=oe(e.sources),r=[],i=sc(r),o=0;n.forEach(function(e){e.hasName()||(e.dataName="source_"+o++);var t=e.assemble();i(e,t)}),r.forEach(function(e){0===e.transform.length&&delete e.transform});for(var a=0,u=0;u<r.length;u++)0!==((m=r[u]).transform||[]).length||m.source||r.splice(a++,0,r.splice(u,1)[0]);for(var s=0,c=r;s<c.length;s++)for(var l=0,f=(m=c[s]).transform||[];l<f.length;l++){var d=f[l];"lookup"===d.type&&(d.from=e.outputNodes[d.from].getSource())}for(var p=0,h=r;p<h.length;p++){var m;(m=h[p]).name in t&&(m.values=t[m.name])}return r}(e.component.data,t.datasets||{}));delete t.datasets;var i=e.assembleProjections(),o=e.assembleTitle(),a=e.assembleGroupStyle(),u=e.assembleLayoutSignals();return u=u.filter(function(e){return"width"!==e.name&&"height"!==e.name||void 0===e.value||(t[e.name]=+e.value,!1)}),{spec:I({$schema:"https://vega.github.io/schema/vega/v4.json"},e.description?{description:e.description}:{},t,o?{title:o}:{},a?{style:a}:{},{data:r},0<i.length?{projections:i}:{},e.assembleGroup(u.concat(e.assembleSelectionTopLevelSignals([]))),n?{config:n}:{})}}(f,(r=e,i=s,I({autosize:1===ie(o=l).length&&o.type?o.type:o},mo(i),mo(r))))}finally{t.logger&&(pn=dn),t.fieldTitle&&br()}},Object.defineProperty(e,"__esModule",{value:!0})});